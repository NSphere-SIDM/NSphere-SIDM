

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nsphere_plot &mdash; NSphere  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            NSphere
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../command_line/index.html">Command-Line Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_flow/index.html">Data and Results Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_flow/index.html#output-file-reference">Output File Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../c_api/index.html">C API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_api/index.html">Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NSphere</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">nsphere_plot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for nsphere_plot</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Copyright 2025 Kris Sigurdson</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="c1"># Check for --help flag at the very beginning</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">showing_help</span> <span class="o">=</span> <span class="s1">&#39;--help&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="ow">or</span> <span class="s1">&#39;-h&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>

<span class="c1"># Import other modules</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.animation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">animation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">energy_distance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnivariateSpline</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">imageio.v2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">imageio</span> <span class="c1"># Use imageio v2 for get_writer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">colors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">binned_statistic</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">atexit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<div class="viewcode-block" id="find_project_root">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.find_project_root">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_project_root</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the project root directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the project root directory.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The project root is identified by the presence of a &#39;src&#39; directory.</span>
<span class="sd">    Uses path normalization for cross-platform compatibility.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">script_path</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">script_dir</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;python&#39;</span><span class="p">:</span>
        <span class="n">potential_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">script_dir</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">potential_root</span> <span class="o">=</span> <span class="n">script_dir</span>
    
    <span class="n">potential_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">potential_root</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">potential_root</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">potential_root</span>
    
    <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">potential_root</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">parent_dir</span>
        
    <span class="n">grandparent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grandparent_dir</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">grandparent_dir</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not verify project root via &#39;src&#39; directory. Using derived directory: </span><span class="si">{</span><span class="n">potential_root</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">potential_root</span></div>


<span class="c1"># Set up project paths</span>
<span class="n">PROJECT_ROOT</span> <span class="o">=</span> <span class="n">find_project_root</span><span class="p">()</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>

<span class="c1"># Add the project src directory to the module search path if needed</span>
<span class="n">src_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">src_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">src_dir</span><span class="p">)</span>

<span class="c1"># Define global variables</span>
<span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Will be set in main()</span>
<span class="n">start_snap</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">end_snap</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">step_snap</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">duration</span> <span class="o">=</span> <span class="mf">100.0</span>  <span class="c1"># Default frame duration in ms (for fps=10)</span>
<span class="n">section_delay</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># No delay by default (will be set to 5.0 if paced_mode is enabled)</span>
<span class="n">progress_delay</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># No delay by default (will be set to 2.0 if paced_mode is enabled)</span>
<span class="n">enable_logging</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default: don&#39;t log info messages unless --log is specified</span>
<span class="n">paced_mode</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># When true, enables delays between sections with timers</span>

<div class="viewcode-block" id="show_section_delay">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.show_section_delay">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">show_section_delay</span><span class="p">(</span><span class="n">delay_seconds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a visual timer with dots for section transitions.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    delay_seconds : float</span>
<span class="sd">        The number of seconds to delay/pace</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Shows an upward counting timer with dots accumulating each second.</span>
<span class="sd">    Displays the full delay_seconds at the end to ensure consistent timing.</span>
<span class="sd">    Allows the user to skip the delay with spacebar or pause/resume with &#39;p&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">msvcrt</span>  <span class="c1"># Windows</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">kbhit</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">kbhit</span><span class="p">()</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">getch</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">getch</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">is_windows</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">termios</span><span class="o">,</span><span class="w"> </span><span class="nn">fcntl</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">select</span>  <span class="c1"># Unix/Linux/MacOS</span>
            <span class="n">is_windows</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Save the terminal settings</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
            <span class="n">old_settings</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="c1"># Setup non-blocking input</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">setup_nonblocking</span><span class="p">():</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">termios</span><span class="o">.</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
                <span class="n">new</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">termios</span><span class="o">.</span><span class="n">ICANON</span>
                <span class="n">new</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">termios</span><span class="o">.</span><span class="n">ECHO</span>
                <span class="n">termios</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TCSANOW</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
                <span class="n">oldflags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFL</span><span class="p">)</span>
                <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFL</span><span class="p">,</span> <span class="n">oldflags</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NONBLOCK</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">restore_terminal</span><span class="p">():</span>
                <span class="n">termios</span><span class="o">.</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="n">old_settings</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">kbhit</span><span class="p">():</span>
                <span class="n">dr</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">de</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">getch</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">kbhit</span><span class="p">():</span>
                    <span class="n">ch</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">ch</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">setup_nonblocking</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="c1"># If neither input method is available, fallback to basic behavior</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">kbhit</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">getch</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">restore_terminal</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="n">is_windows</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dots</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">paused</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">pause_start_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pause_elapsed_time</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Store the elapsed time when entering pause</span>
    <span class="n">total_paused_time</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Helper to format display string</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_display_text</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">,</span> <span class="n">dots_str</span><span class="p">,</span> <span class="n">pause_status</span><span class="p">):</span>
        <span class="c1"># Fix the position of the message by padding the dots to a consistent length</span>
        <span class="n">max_dots</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">delay_seconds</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Maximum possible dots</span>
        <span class="n">dots_padding</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_dots</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">dots_str</span><span class="p">))</span>
        
        <span class="c1"># Format base display string - time goes right after &quot;for&quot;</span>
        <span class="n">base_display</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Pacing output for </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s &quot;</span>
        
        <span class="c1"># Calculate message length and ensure padding is sufficient</span>
        <span class="n">pause_msg</span> <span class="o">=</span> <span class="s2">&quot;Press Spacebar to Skip, P to Resume&quot;</span>
        <span class="n">run_msg</span> <span class="o">=</span> <span class="s2">&quot;Press Spacebar to Skip, P to Pause&quot;</span>
        
        <span class="c1"># Ensure extra padding is present for the longer message</span>
        <span class="n">max_msg_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pause_msg</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">run_msg</span><span class="p">))</span> <span class="o">+</span> <span class="mi">4</span>  <span class="c1"># +4 for brackets and buffer</span>
        
        <span class="c1"># Define spacing constants</span>
        <span class="n">status_text</span> <span class="o">=</span> <span class="s2">&quot;[PAUSED] &quot;</span>
        <span class="n">status_padding</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">status_text</span><span class="p">)</span>
        
        <span class="c1"># Add appropriate status or padding after the time</span>
        <span class="k">if</span> <span class="n">pause_status</span><span class="p">:</span>
            <span class="c1"># When paused, show [PAUSED] after the time</span>
            <span class="n">display_with_status</span> <span class="o">=</span> <span class="n">base_display</span> <span class="o">+</span> <span class="n">status_text</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">pause_msg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># When not paused, add padding to keep elements position consistent</span>
            <span class="n">display_with_status</span> <span class="o">=</span> <span class="n">base_display</span> <span class="o">+</span> <span class="n">status_padding</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">run_msg</span>  <span class="c1"># No extra space here - it will be added after the bracket</span>
        
        <span class="c1"># Place message 14 spaces to the right and ensure it stays in place</span>
        <span class="n">guidance</span> <span class="o">=</span> <span class="s2">&quot;              [&quot;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;] &quot;</span>  <span class="c1"># Added a space after the closing bracket for padding</span>
        
        <span class="c1"># Complete the display string with dots and guidance</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_with_status</span><span class="si">}{</span><span class="n">dots_str</span><span class="si">}{</span><span class="n">dots_padding</span><span class="si">}{</span><span class="n">guidance</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># Initial display with empty dots and consistent padding</span>
    <span class="n">initial_dots</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>  <span class="c1"># Start with one dot</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Always start in the unpaused state for the initial display</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_display_text</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">initial_dots</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Keep running until the delay duration is reached or exceeded</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kbhit</span><span class="p">():</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">getch</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>  <span class="c1"># Spacebar always skips entirely, even when paused</span>
                    <span class="c1"># Clear the entire line and return immediately</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[2K&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>  <span class="c1"># &#39;p&#39; toggles pause/resume</span>
                    <span class="k">if</span> <span class="n">paused</span><span class="p">:</span>
                        <span class="c1"># Resuming - add elapsed pause time to total</span>
                        <span class="n">total_paused_time</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">pause_start_time</span>
                        <span class="n">paused</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Pausing - record the time pause began and save current elapsed time</span>
                        <span class="n">pause_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="c1"># Calculate and store the current elapsed time to display during pause</span>
                        <span class="n">pause_elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">-</span> <span class="n">total_paused_time</span>
                        <span class="n">paused</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">paused</span><span class="p">:</span>
                <span class="c1"># Only update time when not paused</span>
                <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">-</span> <span class="n">total_paused_time</span>
                
                <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">delay_seconds</span><span class="p">:</span>
                    <span class="c1"># The end of the delay has been reached</span>
                    <span class="c1"># Instead of showing a final display, clear the line completely (like spacebar skip)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[2K&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">break</span>
                
                <span class="c1"># Add a dot every second</span>
                <span class="n">new_dots</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_dots</span> <span class="o">!=</span> <span class="n">dots</span><span class="p">:</span>
                    <span class="n">dots</span> <span class="o">=</span> <span class="n">new_dots</span>
                
                <span class="c1"># Update display</span>
                <span class="n">display_content</span> <span class="o">=</span> <span class="n">get_display_text</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="n">dots</span><span class="p">,</span> <span class="n">paused</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[2K&quot;</span> <span class="o">+</span> <span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="n">display_content</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># When paused, display the stored time and dots from when we entered pause</span>
                <span class="c1"># Use the stored pause_elapsed_time which is frozen at the moment of pause</span>
                <span class="n">display_content_paused</span> <span class="o">=</span> <span class="n">get_display_text</span><span class="p">(</span><span class="n">pause_elapsed_time</span><span class="p">,</span> <span class="n">dots</span><span class="p">,</span> <span class="n">paused</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[2K&quot;</span> <span class="o">+</span> <span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="n">display_content_paused</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    
        <span class="c1"># No newline after completing - line is already cleared</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Ensure terminal is restored if using Unix-style input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_windows</span> <span class="ow">and</span> <span class="s1">&#39;restore_terminal&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="n">restore_terminal</span><span class="p">()</span></div>


<div class="viewcode-block" id="show_progress_delay">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.show_progress_delay">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">show_progress_delay</span><span class="p">(</span><span class="n">delay_seconds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a minimal visual indicator during progress delay.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    delay_seconds : float</span>
<span class="sd">        The number of seconds to delay/pace</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Shows only dots accumulating with each second, without text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">dots</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">delay_seconds</span><span class="p">:</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="c1"># Add a dot every second</span>
        <span class="n">new_dots</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_dots</span> <span class="o">!=</span> <span class="n">dots</span><span class="p">:</span>
            <span class="n">dots</span> <span class="o">=</span> <span class="n">new_dots</span>
        <span class="c1"># Truncate the dots string (unlikely to be needed but consistent)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[2K</span><span class="si">{</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="n">dots</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[2K&quot;</span><span class="p">)</span>  <span class="c1"># Clear the dots</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<span class="c1"># Global variables for animation data</span>
<span class="n">mass_snapshots</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">density_snapshots</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">psi_snapshots</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Global variables for histogram data tracking</span>
<span class="n">particles_original_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">particles_final_original_count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Configure tqdm to work properly in all environments</span>
<span class="n">tqdm</span><span class="o">.</span><span class="n">monitor_interval</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Disable monitor thread to avoid issues</span>

<span class="c1"># --- TQDM Dynamic Formatting Constants ---</span>

<span class="c1"># Format Strings (No Bar, No Percentage for counter_tqdm line)</span>
<span class="n">FMT_FULL</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">: </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1"> [</span><span class="si">{elapsed}</span><span class="s1">&lt;</span><span class="si">{remaining}</span><span class="s1">, </span><span class="si">{rate_fmt}</span><span class="s1">]&#39;</span>
<span class="n">FMT_NO_REM</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">: </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1"> [</span><span class="si">{elapsed}</span><span class="s1">, </span><span class="si">{rate_fmt}</span><span class="s1">]&#39;</span>
<span class="n">FMT_NO_RATE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">: </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1"> [</span><span class="si">{elapsed}</span><span class="s1">]&#39;</span>
<span class="n">FMT_COUNTS</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">: </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1">&#39;</span>
<span class="n">FMT_DESC</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">&#39;</span>

<span class="c1"># Descriptions (Full and Short)</span>
<span class="n">DESCRIPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;proc_anim_frames&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s2">&quot;Processing animation frames&quot;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s2">&quot;Proc. anim frames&quot;</span><span class="p">},</span>
    <span class="s1">&#39;encod_frames&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s2">&quot;Encoding frames&quot;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s2">&quot;Encod. frames&quot;</span><span class="p">},</span>
    <span class="s1">&#39;preproc_phase&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s2">&quot;Preprocessing phase space data&quot;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s2">&quot;Preproc. phase data&quot;</span><span class="p">},</span>
    <span class="s1">&#39;render_phase&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s2">&quot;Rendering phase space frames&quot;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s2">&quot;Render phase frames&quot;</span><span class="p">},</span>
    <span class="s1">&#39;proc_sorted_snaps&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s2">&quot;Processing rank sorted snapshot files&quot;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s2">&quot;Proc. sorted snaps&quot;</span><span class="p">},</span>
    <span class="s1">&#39;proc_unsorted_snaps&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s2">&quot;Processing unsorted snapshot files&quot;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s2">&quot;Proc. unsorted snaps&quot;</span><span class="p">},</span>
    <span class="s1">&#39;proc_energy_series&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s2">&quot;Processing energy data for time series&quot;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s2">&quot;Proc. energy series&quot;</span><span class="p">},</span>
    <span class="s1">&#39;gen_mass_frames&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s2">&quot;Generating mass profile frames&quot;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s2">&quot;Gen. mass frames&quot;</span><span class="p">},</span>
    <span class="s1">&#39;gen_dens_frames&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s2">&quot;Generating density profile frames&quot;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s2">&quot;Gen. density frames&quot;</span><span class="p">},</span>
    <span class="s1">&#39;gen_psi_frames&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="s2">&quot;Generating psi profile frames&quot;</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="s2">&quot;Gen. psi frames&quot;</span><span class="p">},</span>
<span class="p">}</span>

<span class="c1"># Pre-calculated Thresholds (Min width needed for format with specific desc length)</span>
<span class="c1"># Based on: Counts=11, Elapsed=9, Remaining=9, Rate=14, Separators</span>
<span class="n">TQDM_THRESHOLDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;proc_anim_frames&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Len 28/18</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">52</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">41</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">28</span><span class="p">},</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">}},</span>
    <span class="s1">&#39;encod_frames&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Len 15/13</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">57</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">65</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">55</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">}},</span>
    <span class="s1">&#39;preproc_phase&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Len 30/20</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">82</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">72</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">54</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">43</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">72</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}},</span>
    <span class="s1">&#39;render_phase&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Len 28/19</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">52</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">41</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">28</span><span class="p">},</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">71</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">61</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">43</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">19</span><span class="p">}},</span>
    <span class="s1">&#39;proc_sorted_snaps&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Len 36/18</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">88</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">78</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">36</span><span class="p">},</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">}},</span>
    <span class="s1">&#39;proc_unsorted_snaps&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Len 34/20</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">86</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">76</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">58</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">47</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">34</span><span class="p">},</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">72</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}},</span>
    <span class="s1">&#39;proc_energy_series&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Len 38/20</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">51</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">38</span><span class="p">},</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">72</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">33</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}},</span>
    <span class="s1">&#39;gen_mass_frames&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Len 30/16</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">82</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">72</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">54</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">43</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">58</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">29</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}},</span>
    <span class="s1">&#39;gen_dens_frames&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Len 32/19</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">84</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">},</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">71</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">61</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">43</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">19</span><span class="p">}},</span>
    <span class="s1">&#39;gen_psi_frames&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c1"># Len 29/15</span>
        <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">81</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">71</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">53</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">29</span><span class="p">},</span>
        <span class="s1">&#39;short&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span> <span class="s1">&#39;no_rem&#39;</span><span class="p">:</span> <span class="mi">57</span><span class="p">,</span> <span class="s1">&#39;no_rate&#39;</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}},</span>
<span class="p">}</span>

<span class="c1"># Helper function to select format and description</span>
<div class="viewcode-block" id="select_tqdm_format">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.select_tqdm_format">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">select_tqdm_format</span><span class="p">(</span><span class="n">desc_key</span><span class="p">,</span> <span class="n">term_width</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Selects tqdm description and format based on terminal width.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">desc_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TQDM_THRESHOLDS</span> <span class="ow">or</span> <span class="n">desc_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DESCRIPTIONS</span><span class="p">:</span>
        <span class="c1"># Fallback if key is unknown</span>
        <span class="k">return</span> <span class="n">desc_key</span><span class="p">,</span> <span class="n">FMT_NO_RATE</span> <span class="c1"># Default to a reasonable format</span>

    <span class="n">thresholds</span> <span class="o">=</span> <span class="n">TQDM_THRESHOLDS</span><span class="p">[</span><span class="n">desc_key</span><span class="p">]</span>
    <span class="n">full_desc</span> <span class="o">=</span> <span class="n">DESCRIPTIONS</span><span class="p">[</span><span class="n">desc_key</span><span class="p">][</span><span class="s1">&#39;full&#39;</span><span class="p">]</span>
    <span class="n">short_desc</span> <span class="o">=</span> <span class="n">DESCRIPTIONS</span><span class="p">[</span><span class="n">desc_key</span><span class="p">][</span><span class="s1">&#39;short&#39;</span><span class="p">]</span>

    <span class="c1"># Determine which description and format to use</span>
    <span class="k">if</span> <span class="n">term_width</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">][</span><span class="s1">&#39;full&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">full_desc</span><span class="p">,</span> <span class="n">FMT_FULL</span>
    <span class="k">elif</span> <span class="n">term_width</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">][</span><span class="s1">&#39;no_rem&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">full_desc</span><span class="p">,</span> <span class="n">FMT_NO_REM</span>
    <span class="k">elif</span> <span class="n">term_width</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">][</span><span class="s1">&#39;no_rate&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">full_desc</span><span class="p">,</span> <span class="n">FMT_NO_RATE</span>
    <span class="c1"># Switch to short description if full doesn&#39;t fit even minimal stats</span>
    <span class="k">elif</span> <span class="n">term_width</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">][</span><span class="s1">&#39;no_rate&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">short_desc</span><span class="p">,</span> <span class="n">FMT_NO_RATE</span>
    <span class="k">elif</span> <span class="n">term_width</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">][</span><span class="s1">&#39;counts&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">short_desc</span><span class="p">,</span> <span class="n">FMT_COUNTS</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">short_desc</span><span class="p">,</span> <span class="n">FMT_DESC</span></div>

<span class="c1"># --- End TQDM Dynamic Formatting Constants ---</span>

<span class="c1"># Configure tqdm to match the custom progress bar format</span>
<span class="n">tqdm_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;ascii&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>              <span class="c1"># Use Unicode characters for progress bars</span>
    <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>               <span class="c1"># Always at position 0</span>
    <span class="s1">&#39;leave&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>               <span class="c1"># Leave the progress bar after completion</span>
    <span class="s1">&#39;miniters&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>               <span class="c1"># Update every 5 iterations to reduce flickering</span>
    <span class="s1">&#39;dynamic_ncols&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>       <span class="c1"># Enable dynamic width adaptation</span>
    <span class="s1">&#39;ncols&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>               <span class="c1"># No fixed width override</span>
    <span class="s1">&#39;smoothing&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>            <span class="c1"># Smoother progress updates</span>
    <span class="c1"># &#39;bar_format&#39;: MUST BE ABSENT or None</span>
<span class="p">}</span>

<span class="c1"># Handle keyboard interrupts gracefully</span>
<span class="n">original_sigint_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>

<div class="viewcode-block" id="signal_handler">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.signal_handler">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">signal_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle keyboard interrupts gracefully.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sig : int</span>
<span class="sd">        Signal number</span>
<span class="sd">    frame : frame</span>
<span class="sd">        Current stack frame</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Restores the original signal handler to allow a forced exit</span>
<span class="sd">    with a second Ctrl+C if needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Interrupted by user. Cleaning up...&quot;</span><span class="p">)</span>
    <span class="c1"># Restore original handler to allow a second Ctrl+C to force exit</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">original_sigint_handler</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>

<span class="c1"># Context manager to suppress stdout during progress bar updates</span>
<div class="viewcode-block" id="suppress_stdout">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.suppress_stdout">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">suppress_stdout</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager that suppresses stdout output.</span>

<span class="sd">    Temporarily redirects stdout to a dummy file object that discards output.</span>
<span class="sd">    Used to prevent unwanted console output during progress bar updates.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    None</span>
<span class="sd">        Control returns to the caller with stdout suppressed</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The original stdout is always restored when leaving the context,</span>
<span class="sd">    even if an exception occurs.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; with suppress_stdout():</span>
<span class="sd">    ...     print(&quot;This won&#39;t be displayed&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">DummyFile</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">DummyFile</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">original_stdout</span></div>


<span class="c1"># Helper function for processing animation frames (must be at module level for multiprocessing)</span>
<div class="viewcode-block" id="process_animation_frame">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_animation_frame">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_animation_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a single animation frame for GIF output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    frame : numpy.ndarray</span>
<span class="sd">        The frame image data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Processed frame ready for GIF encoding</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create BytesIO buffer for this frame</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>

    <span class="c1"># Write frame to BytesIO buffer with explicit format (needed in v3)</span>
    <span class="n">imageio</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">plugin</span><span class="o">=</span><span class="s1">&#39;pillow&#39;</span><span class="p">)</span>

    <span class="c1"># Reset buffer position to start</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Read the frame back as an image</span>
    <span class="n">frame_img</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Clean up buffer</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">frame_img</span></div>


<span class="c1"># ANSI escape codes for cursor manipulation</span>
<span class="n">HIDE_CURSOR</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[?25l&quot;</span>  <span class="c1"># Hide the cursor</span>
<span class="n">SHOW_CURSOR</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[?25h&quot;</span>  <span class="c1"># Show the cursor</span>

<div class="viewcode-block" id="truncate_and_pad_string">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.truncate_and_pad_string">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">truncate_and_pad_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">fallback_width</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Truncates a string to the terminal width and pads with spaces.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    text : str</span>
<span class="sd">        The string to potentially truncate and pad.</span>
<span class="sd">    fallback_width : int, optional</span>
<span class="sd">        The width to use if terminal size can&#39;t be determined, by default 100.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The string, truncated and padded with spaces to the terminal width.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Attempt to get the terminal size</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">columns</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="c1"># If output is redirected or terminal size unavailable, use fallback</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">fallback_width</span>
    <span class="c1"># Truncate the string first</span>
    <span class="n">truncated</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span>
    <span class="c1"># Pad the truncated string with spaces to the full width</span>
    <span class="k">return</span> <span class="n">truncated</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_separator_line">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.get_separator_line">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">fallback_width</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a separator line spanning the terminal width.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    char : str, optional</span>
<span class="sd">        The character to repeat for the line, by default &#39;-&#39;.</span>
<span class="sd">    fallback_width : int, optional</span>
<span class="sd">        The width to use if terminal size can&#39;t be determined, by default 100.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        A string consisting of &#39;char&#39; repeated to fill the terminal width.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Attempt to get the terminal size</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
        <span class="c1"># Use the determined width, but ensure it&#39;s at least fallback_width</span>
        <span class="c1"># to avoid overly short separators on very narrow terminals.</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">fallback_width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Ensure a minimum reasonable width</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="c1"># If output is redirected or terminal size unavailable, use fallback</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">fallback_width</span>
    <span class="k">return</span> <span class="n">char</span> <span class="o">*</span> <span class="n">width</span></div>


<span class="c1"># Function to clear the current line before printing</span>
<div class="viewcode-block" id="clear_line">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.clear_line">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clear_line</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clear the current terminal line for clean console output using ANSI escape codes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses carriage return and the ANSI sequence `\033[2K` to erase the entire line.</span>
<span class="sd">    This is more reliable than printing spaces across different terminal widths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[2K&quot;</span><span class="p">)</span> <span class="c1"># Move to beginning, erase entire line</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<span class="c1"># Hide/show cursor functions for progress displays</span>
<div class="viewcode-block" id="hide_cursor">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.hide_cursor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hide_cursor</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hide the terminal cursor.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses ANSI escape code to hide the cursor for cleaner progress bar display.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">HIDE_CURSOR</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="show_cursor">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.show_cursor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">show_cursor</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show the terminal cursor.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses ANSI escape code to restore cursor visibility after it was hidden.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SHOW_CURSOR</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<span class="c1"># Safety mechanism to restore cursor if process is terminated unexpectedly</span>
<div class="viewcode-block" id="ensure_cursor_visible">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.ensure_cursor_visible">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_cursor_visible</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restore cursor visibility when program exits.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Safety mechanism registered with atexit to ensure the terminal cursor</span>
<span class="sd">    remains visible even if the program terminates unexpectedly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">show_cursor</span><span class="p">()</span></div>


<span class="c1"># Register the safety function to run on exit</span>
<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ensure_cursor_visible</span><span class="p">)</span>

<span class="c1"># Set up the logger</span>
<div class="viewcode-block" id="setup_logging">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.setup_logging">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configure and initialize the logging system.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    logging.Logger</span>
<span class="sd">        Configured logger instance for nsphere_plot.py</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Creates a log directory if it doesn&#39;t exist and configures</span>
<span class="sd">    a file-based logger that writes to log/nsphere_plot.log with</span>
<span class="sd">    timestamp, log level, and message formatting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create log directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Configure the logger</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="s2">&quot;log/nsphere_plot.log&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">log_file</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;nsphere_plot&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="log_message">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.log_message">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log a message to the log file based on level and settings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    message : str</span>
<span class="sd">        The message to log</span>
<span class="sd">    level : str, optional</span>
<span class="sd">        The log level (info, warning, error, debug), by default &quot;info&quot;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Warning and error messages are always logged regardless of enable_logging flag.</span>
<span class="sd">    Info and debug messages are only logged if enable_logging is True (--log specified).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">enable_logging</span>

    <span class="c1"># Always log warnings and errors regardless of enable_logging setting</span>
    <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;warning&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># For info and debug, only log if enable_logging is True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">enable_logging</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;info&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Default to info level</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>


<span class="c1"># Initialize the logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logging</span><span class="p">()</span>

<span class="c1"># Log plot saving to file, display on console cycling through filenames</span>
<div class="viewcode-block" id="log_plot_saved">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.log_plot_saved">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">section_type</span><span class="o">=</span><span class="s2">&quot;plots&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log a saved plot to log file and update status on console.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Full path to the saved file</span>
<span class="sd">    current : int, optional</span>
<span class="sd">        Current plot number, by default 0</span>
<span class="sd">    total : int, optional</span>
<span class="sd">        Total plots to save, by default 1</span>
<span class="sd">    section_type : str, optional</span>
<span class="sd">        Type of plots being saved, by default &quot;plots&quot;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Displays a progress bar and updates the console with the current plot</span>
<span class="sd">    being saved. Includes timing information once enough plots have been</span>
<span class="sd">    processed to calculate a reasonable rate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Log the full path to the log file</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># First plot initialization is handled globally</span>
    <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Show shorter message on console with cycling display</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">get_file_prefix</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="n">clear_line</span><span class="p">()</span>

    <span class="c1"># Create progress display</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">current</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">100</span>
    <span class="n">bar_length</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">filled_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bar_length</span> <span class="o">*</span> <span class="n">current</span> <span class="o">//</span> <span class="n">total</span><span class="p">)</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="s1">&#39;█&#39;</span> <span class="o">*</span> <span class="n">filled_length</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">bar_length</span> <span class="o">-</span> <span class="n">filled_length</span><span class="p">)</span>

    <span class="c1"># Calculate time estimates for multiple plots</span>
    <span class="n">time_info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">log_plot_saved</span><span class="p">,</span> <span class="s1">&#39;start_time&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">log_plot_saved</span><span class="o">.</span><span class="n">start_time</span>
        <span class="c1"># For display purposes, ensure elapsed time is at least 0.01 seconds</span>
        <span class="n">displayed_elapsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Minimum displayed time</span>
        <span class="c1"># Apply a minimum nominal time to prevent unrealistically high rates</span>
        <span class="n">nominal_elapsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>  <span class="c1"># Minimum 0.02 seconds</span>

        <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Need at least 2 plots to calculate rate</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">current</span> <span class="o">/</span> <span class="n">nominal_elapsed</span>  <span class="c1"># plots per second</span>
            <span class="c1"># Cap the rate at a reasonable maximum for display</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">)</span>

            <span class="c1"># Only show remaining time once there&#39;s a reasonable rate calculation</span>
            <span class="k">if</span> <span class="n">current</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">total</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">):</span>  <span class="c1"># At least 3 plots or 10% complete</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">-</span> <span class="n">current</span><span class="p">)</span> <span class="o">/</span> <span class="n">rate</span> <span class="k">if</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">time_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; [</span><span class="si">{</span><span class="n">displayed_elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">remaining</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">rate</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">file/s]&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Initialize the start time on first call</span>
        <span class="n">log_plot_saved</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Print the progress bar and current plot name inline with extra padding</span>
    <span class="c1"># Truncate the content part of the string</span>
    <span class="n">content_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Save: </span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">progress</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% | File: </span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">time_info</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="n">content_string</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c1"># Print newline if this is the last plot</span>
    <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Add a separator line after a completed progress bar</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Add delay after completing progress section if enabled</span>
        <span class="k">if</span> <span class="n">progress_delay</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">paced_mode</span><span class="p">:</span>
            <span class="n">show_progress_delay</span><span class="p">(</span><span class="n">progress_delay</span><span class="p">)</span>

        <span class="c1"># Reset start time for next batch</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">log_plot_saved</span><span class="p">,</span> <span class="s1">&#39;start_time&#39;</span><span class="p">):</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="n">log_plot_saved</span><span class="p">,</span> <span class="s1">&#39;start_time&#39;</span><span class="p">)</span></div>


<span class="c1"># Global state for combined progress tracking</span>
<span class="n">_combined_plot_trackers</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="start_combined_progress">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.start_combined_progress">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">start_combined_progress</span><span class="p">(</span><span class="n">section_key</span><span class="p">,</span> <span class="n">total_plots</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a combined progress tracker for a section of related plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    section_key : str</span>
<span class="sd">        Unique identifier for this plotting section</span>
<span class="sd">    total_plots : int</span>
<span class="sd">        Total number of plots expected in this section</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Sets up a progress tracker in the global _combined_plot_trackers dictionary</span>
<span class="sd">    to monitor progress across multiple related operations. Initializes timing</span>
<span class="sd">    information for rate calculation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_combined_plot_trackers</span><span class="p">[</span><span class="n">section_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="n">total_plots</span><span class="p">,</span>
        <span class="s1">&#39;plots&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># Initialize timing information</span>
    <span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting combined progress tracking for </span><span class="si">{</span><span class="n">section_key</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">total_plots</span><span class="si">}</span><span class="s2"> total plots&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_combined_progress">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.update_combined_progress">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_combined_progress</span><span class="p">(</span><span class="n">section_key</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the combined progress tracker for a specific plot section.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    section_key : str</span>
<span class="sd">        Identifier for the plotting section</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Path to the plot file that was saved</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (current, total) counts for the section, indicating progress</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Updates the progress tracker for the specified section, increments</span>
<span class="sd">    the counter, and displays a progress bar showing completion status.</span>
<span class="sd">    Includes timing information and estimated completion time once</span>
<span class="sd">    enough data points are available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">section_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_combined_plot_trackers</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No active progress tracker for </span><span class="si">{</span><span class="n">section_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">tracker</span> <span class="o">=</span> <span class="n">_combined_plot_trackers</span><span class="p">[</span><span class="n">section_key</span><span class="p">]</span>
    <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;plots&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Progress update: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="n">get_file_prefix</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="n">clear_line</span><span class="p">()</span>

    <span class="n">progress</span> <span class="o">=</span> <span class="p">(</span><span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">100</span>
    <span class="n">bar_length</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">filled_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bar_length</span> <span class="o">*</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span> <span class="o">//</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>
    <span class="n">bar</span> <span class="o">=</span> <span class="s1">&#39;█&#39;</span> <span class="o">*</span> <span class="n">filled_length</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">bar_length</span> <span class="o">-</span> <span class="n">filled_length</span><span class="p">)</span>

    <span class="c1"># Calculate time estimates</span>
    <span class="n">time_info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;start_time&#39;</span> <span class="ow">in</span> <span class="n">tracker</span><span class="p">:</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
        <span class="c1"># For display purposes, ensure elapsed time is at least 0.01 seconds</span>
        <span class="n">displayed_elapsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Minimum displayed time</span>
        <span class="c1"># Apply a minimum nominal time to prevent unrealistically high rates</span>
        <span class="n">nominal_elapsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>  <span class="c1"># Minimum 0.02 seconds</span>

        <span class="c1"># Always show timing information, even for single items</span>
        <span class="c1"># Calculate a reasonable rate based on progress so far</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">nominal_elapsed</span>  <span class="c1"># items per second</span>

        <span class="c1"># Cap the rate at a reasonable maximum for display</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">)</span>

        <span class="c1"># Calculate remaining time based on current rate</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="p">(</span><span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">rate</span> <span class="k">if</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Always show timing information</span>
        <span class="n">time_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; [</span><span class="si">{</span><span class="n">displayed_elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">remaining</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">rate</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">file/s]&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Initialize the start time on first update</span>
        <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Determine if this is a loading progress or saving progress</span>
    <span class="n">action</span> <span class="o">=</span> <span class="s2">&quot;Loading data&quot;</span> <span class="k">if</span> <span class="n">section_key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_data_loading&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Saving plots&quot;</span>

    <span class="c1"># Print the progress bar and current plot name inline with extra padding</span>
    <span class="c1"># For progress bars, use shorter Read/Save labels</span>
    <span class="n">display_action</span> <span class="o">=</span> <span class="s2">&quot;Read:&quot;</span> <span class="k">if</span> <span class="n">section_key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_data_loading&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Save:&quot;</span>
    <span class="c1"># Truncate the content part of the string</span>
    <span class="n">content_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_action</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">progress</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">% | File: </span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">time_info</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="n">content_string</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c1"># Print newline if this is the last plot</span>
    <span class="k">if</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Add a separator line after a completed progress bar</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Add delay after completing progress section if enabled</span>
        <span class="k">if</span> <span class="n">progress_delay</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">paced_mode</span><span class="p">:</span>
            <span class="n">show_progress_delay</span><span class="p">(</span><span class="n">progress_delay</span><span class="p">)</span>

        <span class="c1"># Clear the tracker as it&#39;s complete</span>
        <span class="n">_combined_plot_trackers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">section_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">],</span> <span class="n">tracker</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span></div>


<span class="c1"># Custom print functions for consistent output formatting</span>
<div class="viewcode-block" id="print_status">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.print_status">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_status</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print a message to the console and also log it if detailed logging is enabled.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    message : str</span>
<span class="sd">        The message to print and potentially log.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Always print to console (if not showing help)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">showing_help</span><span class="p">:</span>
        <span class="n">clear_line</span><span class="p">()</span>
        <span class="c1"># Truncate the message before writing</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Also log the message if detailed logging is enabled</span>
    <span class="k">if</span> <span class="n">enable_logging</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CONSOLE] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_header">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.print_header">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_header</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">add_newline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print a consistent section header with configurable delay and log it if detailed logging is enabled.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    title : str</span>
<span class="sd">        The section title to display.</span>
<span class="sd">    add_newline : bool, optional</span>
<span class="sd">        Whether to add a newline before the header. Default is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">showing_help</span><span class="p">:</span>
        <span class="c1"># Add delay between sections for better visual separation, but only if this is not the first header</span>
        <span class="k">global</span> <span class="n">section_delay</span><span class="p">,</span> <span class="n">enable_logging</span><span class="p">,</span> <span class="n">paced_mode</span>
        <span class="c1"># Use a static variable to track if this is the first header</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">print_header</span><span class="p">,</span> <span class="s1">&#39;first_call&#39;</span><span class="p">):</span>
            <span class="n">print_header</span><span class="o">.</span><span class="n">first_call</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">section_delay</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">paced_mode</span><span class="p">:</span>
            <span class="n">show_section_delay</span><span class="p">(</span><span class="n">section_delay</span><span class="p">)</span>

        <span class="n">clear_line</span><span class="p">()</span>
        <span class="c1"># Only add newline if requested (for energy plots we want to control this)</span>
        <span class="k">if</span> <span class="n">add_newline</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Truncate the title before writing</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Also log the header if detailed logging is enabled</span>
        <span class="k">if</span> <span class="n">enable_logging</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SECTION] </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_footer">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.print_footer">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_footer</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print a footer for a section and log it if detailed logging is enabled.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    message : str, optional</span>
<span class="sd">        The footer message to display. Default is an empty string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">showing_help</span> <span class="ow">and</span> <span class="n">message</span><span class="p">:</span>
        <span class="n">clear_line</span><span class="p">()</span>
        <span class="c1"># Truncate the message before writing</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Also log the footer if detailed logging is enabled</span>
        <span class="k">if</span> <span class="n">enable_logging</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FOOTER] </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_lastparams">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.read_lastparams">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_lastparams</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;data/lastparams.dat&quot;</span><span class="p">,</span> <span class="n">return_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user_suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read parameters from lastparams.dat file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str, optional</span>
<span class="sd">        Base path to the lastparams.dat file.</span>
<span class="sd">    return_suffix : bool, optional</span>
<span class="sd">        If True, return a suffix string. If False, return individual parameters.</span>
<span class="sd">    user_suffix : str, optional</span>
<span class="sd">        If provided, look for lastparams&lt;user_suffix&gt;.dat instead of lastparams.dat.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or tuple</span>
<span class="sd">        If return_suffix is True, returns a string like &quot;_[filetag]_npts_Ntimes_tfinal_factor&quot;.</span>
<span class="sd">        If return_suffix is False, returns a tuple of (npts, Ntimes, tfinal_factor, file_tag).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">showing_help</span>

    <span class="n">default_suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">default_params</span> <span class="o">=</span> <span class="p">(</span><span class="mi">30000</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Default values</span>

    <span class="k">if</span> <span class="n">showing_help</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default_suffix</span> <span class="k">if</span> <span class="n">return_suffix</span> <span class="k">else</span> <span class="n">default_params</span>

    <span class="c1"># Determine which lastparams file to read</span>
    <span class="k">if</span> <span class="n">user_suffix</span><span class="p">:</span>
        <span class="c1"># If user supplied a suffix, use lastparams&lt;suffix&gt;.dat</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/lastparams</span><span class="si">{</span><span class="n">user_suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to read parameters from user-specified file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Otherwise, use the default lastparams.dat which points to the latest run</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;data/lastparams.dat&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading parameters from default file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Could not find parameter file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="s2">&quot;Please run the simulation or specify a valid --suffix.&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default_suffix</span> <span class="k">if</span> <span class="n">return_suffix</span> <span class="k">else</span> <span class="n">default_params</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">maxsplit</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default_suffix</span> <span class="k">if</span> <span class="n">return_suffix</span> <span class="k">else</span> <span class="n">default_params</span>

        <span class="n">npts</span><span class="p">,</span> <span class="n">Ntimes</span><span class="p">,</span> <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">parts</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">file_tag</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read parameters: npts=</span><span class="si">{</span><span class="n">npts</span><span class="si">}</span><span class="s2">, Ntimes=</span><span class="si">{</span><span class="n">Ntimes</span><span class="si">}</span><span class="s2">, tfinal=</span><span class="si">{</span><span class="n">tfinal_factor</span><span class="si">}</span><span class="s2">, tag=&#39;</span><span class="si">{</span><span class="n">file_tag</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_suffix</span><span class="p">:</span>
            <span class="c1"># Reconstruct the suffix from the read parameters</span>
            <span class="k">if</span> <span class="n">file_tag</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">file_tag</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">npts</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">Ntimes</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">tfinal_factor</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">npts</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">Ntimes</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">tfinal_factor</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">Ntimes</span><span class="p">,</span> <span class="n">tfinal_factor</span><span class="p">,</span> <span class="n">file_tag</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Error reading </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">default_suffix</span> <span class="k">if</span> <span class="n">return_suffix</span> <span class="k">else</span> <span class="n">default_params</span></div>


<span class="c1"># Default values for module-level constants</span>
<span class="c1"># These will be properly initialized in main() via Configuration</span>
<span class="n">npts</span><span class="p">,</span> <span class="n">Ntimes</span><span class="p">,</span> <span class="n">tfinal_factor</span><span class="p">,</span> <span class="n">file_tag</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

<span class="c1"># Define column counts for various data structures</span>
<span class="n">ncol_traj_particles</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">nlowest</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">ncol_convergence</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncol_debug_energy_compare</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">ncol_particles_dat</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ncol_particlesfinal</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">ncol_density_profile</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncol_mass_profile</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncol_psi_profile</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncol_psi_theory</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ncol_dpsi_dr</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncol_drho_dpsi</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncol_f_of_E</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncol_df_fixed_radius</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncol_combined_histogram</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ncol_integrand</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ncol_particles_initial</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">ncol_Rank_Mass_Rad_VRad_unsorted</span> <span class="o">=</span> <span class="mi">7</span>

<span class="c1"># Constants for unit conversions</span>
<span class="n">kmsec_to_kpcmyr</span> <span class="o">=</span> <span class="mf">1.02271e-3</span>  <span class="c1"># Conversion factor from km/s to kpc/Myr</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_robust_range</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mf">95.0</span><span class="p">,</span> <span class="n">percentile_multiplier</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
                           <span class="n">min_abs_extent</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                           <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                           <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">force_symmetric_around_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;axis&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates a robust plot range based on percentiles.</span>

<span class="sd">    Handles positive-only data (e.g., radius, speed magnitude) and data</span>
<span class="sd">    that can be positive or negative (e.g., radial velocity).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_array : np.ndarray</span>
<span class="sd">        1D array of data points.</span>
<span class="sd">    percentile : float</span>
<span class="sd">        Percentile to use (0-100) for range calculation.</span>
<span class="sd">    percentile_multiplier : float</span>
<span class="sd">        Factor to multiply the percentile value by to determine the range extent.</span>
<span class="sd">    min_abs_extent : float, optional</span>
<span class="sd">        A minimum absolute value for the extent of the range (e.g., if range is</span>
<span class="sd">        [0, X], then X must be at least `min_abs_extent`). Ensures a non-zero</span>
<span class="sd">        range. Default is 1.0.</span>
<span class="sd">    default_if_empty : tuple, optional</span>
<span class="sd">        Default (min_val, max_val) tuple to return if `data_array` is empty</span>
<span class="sd">        or contains no finite values. Default is (0, 1.0).</span>
<span class="sd">    can_be_negative : bool, optional</span>
<span class="sd">        If True, the data can have negative values, and the range calculation</span>
<span class="sd">        will consider both positive and negative parts independently.</span>
<span class="sd">        If False, data is assumed to be non-negative, and the range will</span>
<span class="sd">        start from 0. Default is False.</span>
<span class="sd">    force_symmetric_around_zero : bool, optional</span>
<span class="sd">        If True (and `can_be_negative` is True), makes the range symmetric</span>
<span class="sd">        around zero, e.g., (-max_abs_val, max_abs_val). Default is False.</span>
<span class="sd">    percentile_fallback : float, optional</span>
<span class="sd">        Percentile (0-100) to use for range estimation if the median is close</span>
<span class="sd">        to zero, to avoid an overly small range. Default is 95.0.</span>
<span class="sd">    axis_name : str, optional</span>
<span class="sd">        Name of the axis for logging purposes (e.g., &quot;radius&quot;, &quot;velocity&quot;).</span>
<span class="sd">        Default is &quot;axis&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (min_val, max_val) for the plot range.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_array</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data_array</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_calculate_robust_range for </span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2">: Data array empty. Returning default </span><span class="si">{</span><span class="n">default_if_empty</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default_if_empty</span>

    <span class="n">finite_data</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data_array</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">finite_data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_calculate_robust_range for </span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2">: No finite data. Returning default </span><span class="si">{</span><span class="n">default_if_empty</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default_if_empty</span>

    <span class="n">min_lim_final</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">max_lim_final</span> <span class="o">=</span> <span class="n">min_abs_extent</span> <span class="c1"># Initialize with a minimal positive extent</span>

    <span class="k">if</span> <span class="n">can_be_negative</span><span class="p">:</span>
        <span class="n">pos_data</span> <span class="o">=</span> <span class="n">finite_data</span><span class="p">[</span><span class="n">finite_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">neg_data</span> <span class="o">=</span> <span class="n">finite_data</span><span class="p">[</span><span class="n">finite_data</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># Keep negative values for percentile calculation</span>

        <span class="c1"># --- Positive side ---</span>
        <span class="k">if</span> <span class="n">pos_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Direct index calculation for percentile (data may not be sorted)</span>
            <span class="n">pos_data_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">pos_data</span><span class="p">)</span>
            <span class="n">p_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentile</span> <span class="o">/</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_data_sorted</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">p_val_pos</span> <span class="o">=</span> <span class="n">pos_data_sorted</span><span class="p">[</span><span class="n">p_index</span><span class="p">]</span>
            <span class="n">max_lim_final</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p_val_pos</span> <span class="o">*</span> <span class="n">percentile_multiplier</span><span class="p">,</span> <span class="n">min_abs_extent</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_calc_robust for </span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2"> (pos): </span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s2">th percentile (</span><span class="si">{</span><span class="n">p_val_pos</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">) * </span><span class="si">{</span><span class="n">percentile_multiplier</span><span class="si">}</span><span class="s2"> -&gt; max_lim_final=</span><span class="si">{</span><span class="n">max_lim_final</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># No positive data</span>
            <span class="n">max_lim_final</span> <span class="o">=</span> <span class="n">default_if_empty</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">default_if_empty</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">min_abs_extent</span> <span class="c1"># Ensure some positive extent</span>

        <span class="c1"># --- Negative side ---</span>
        <span class="k">if</span> <span class="n">neg_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Direct index calculation for negative data percentile</span>
            <span class="n">neg_data_abs_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">neg_data</span><span class="p">))</span>
            <span class="n">p_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentile</span> <span class="o">/</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_data_abs_sorted</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">p_val_neg_abs</span> <span class="o">=</span> <span class="n">neg_data_abs_sorted</span><span class="p">[</span><span class="n">p_index</span><span class="p">]</span>
            <span class="n">min_lim_final</span> <span class="o">=</span> <span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">p_val_neg_abs</span> <span class="o">*</span> <span class="n">percentile_multiplier</span><span class="p">,</span> <span class="n">min_abs_extent</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_calc_robust for </span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2"> (neg): </span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s2">th percentile of abs (</span><span class="si">{</span><span class="n">p_val_neg_abs</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">) * </span><span class="si">{</span><span class="n">percentile_multiplier</span><span class="si">}</span><span class="s2"> -&gt; min_lim_final=</span><span class="si">{</span><span class="n">min_lim_final</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># No negative data</span>
            <span class="n">min_lim_final</span> <span class="o">=</span> <span class="n">default_if_empty</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">default_if_empty</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">min_abs_extent</span> <span class="c1"># Ensure some negative extent if expected</span>

        <span class="k">if</span> <span class="n">force_symmetric_around_zero</span><span class="p">:</span>
            <span class="n">max_abs_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_lim_final</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">max_lim_final</span><span class="p">))</span>
            <span class="n">min_lim_final</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_abs_val</span>
            <span class="n">max_lim_final</span> <span class="o">=</span> <span class="n">max_abs_val</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># Data is purely positive (or zero)</span>
        <span class="c1"># For positive-only data, range starts at 0.</span>
        <span class="n">min_lim_final</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">abs_finite_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">finite_data</span><span class="p">)</span> <span class="c1"># Ensure all positive for percentile calculation</span>
        <span class="k">if</span> <span class="n">abs_finite_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Direct index calculation for percentile</span>
            <span class="n">abs_data_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">abs_finite_data</span><span class="p">)</span>
            <span class="n">p_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentile</span> <span class="o">/</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">abs_data_sorted</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">p_val_abs</span> <span class="o">=</span> <span class="n">abs_data_sorted</span><span class="p">[</span><span class="n">p_index</span><span class="p">]</span>
            <span class="n">max_lim_final</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p_val_abs</span> <span class="o">*</span> <span class="n">percentile_multiplier</span><span class="p">,</span> <span class="n">min_abs_extent</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_calc_robust for </span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2"> (pos-only): </span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s2">th percentile (</span><span class="si">{</span><span class="n">p_val_abs</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">) * </span><span class="si">{</span><span class="n">percentile_multiplier</span><span class="si">}</span><span class="s2"> -&gt; max_lim_final=</span><span class="si">{</span><span class="n">max_lim_final</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Should not happen due to earlier check, but as a fallback</span>
            <span class="n">max_lim_final</span> <span class="o">=</span> <span class="n">default_if_empty</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Ensure min_lim is less than max_lim</span>
    <span class="k">if</span> <span class="n">min_lim_final</span> <span class="o">&gt;=</span> <span class="n">max_lim_final</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">can_be_negative</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_symmetric_around_zero</span><span class="p">:</span>
             <span class="c1"># Could happen if e.g. only negative data, min_lim_final calculated, max_lim_final is default_if_empty[1]</span>
             <span class="c1"># or only positive data. Try to make a sensible small range.</span>
            <span class="k">if</span> <span class="n">min_lim_final</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_lim_final</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Both ended up zero</span>
                <span class="n">max_lim_final</span> <span class="o">=</span> <span class="n">min_abs_extent</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># If one side is zero, and other side also becomes zero or crosses over</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_lim_final</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">max_lim_final</span><span class="p">):</span>
                    <span class="n">max_lim_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_lim_final</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="c1"># Arbitrary small positive</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">min_lim_final</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">max_lim_final</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="c1"># Arbitrary small negative</span>
        <span class="k">elif</span> <span class="n">force_symmetric_around_zero</span> <span class="p">:</span> <span class="c1"># Should be covered by logic but as safety</span>
            <span class="n">max_lim_final</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_lim_final</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">max_lim_final</span><span class="p">),</span> <span class="n">min_abs_extent</span><span class="p">)</span>
            <span class="n">min_lim_final</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_lim_final</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Positive only data</span>
            <span class="n">max_lim_final</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_lim_final</span><span class="p">,</span> <span class="n">max_lim_final</span><span class="p">,</span> <span class="n">min_abs_extent</span><span class="p">)</span> <span class="c1"># Ensure max_lim is at least min_abs_extent</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_calc_robust for </span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2">: Adjusted min/max due to overlap or zero: min=</span><span class="si">{</span><span class="n">min_lim_final</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">max_lim_final</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_calculate_robust_range for </span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2">: Result (</span><span class="si">{</span><span class="n">min_lim_final</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">max_lim_final</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">min_lim_final</span><span class="p">,</span> <span class="n">max_lim_final</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_global_animation_ranges</span><span class="p">(</span><span class="n">rank_files_subset</span><span class="p">,</span>
                                       <span class="n">r_min_abs_extent</span><span class="p">,</span> <span class="n">v_min_abs_extent</span><span class="p">,</span>
                                       <span class="n">r_default_if_empty</span><span class="p">,</span> <span class="n">v_default_if_empty</span><span class="p">,</span>
                                       <span class="n">kmsec_to_kpcmyr</span><span class="p">,</span>
                                       <span class="n">current_suffix_for_logging</span><span class="p">,</span>
                                       <span class="n">axis_name_prefix</span><span class="o">=</span><span class="s2">&quot;anim_global&quot;</span><span class="p">,</span>
                                       <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates global X (radius) and Y (velocity) ranges for phase space animation.</span>

<span class="sd">    Processes only the first and last snapshot files, calculates 95th percentile</span>
<span class="sd">    for both radius and velocity, then uses the maximum of these two ranges.</span>
<span class="sd">    This ensures consistent axis scaling across all animation frames.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rank_files_subset : list[str]</span>
<span class="sd">        A list of Rank snapshot filenames to sample for range calculation.</span>
<span class="sd">    r_min_abs_extent : float</span>
<span class="sd">        Minimum absolute extent for the radius range.</span>
<span class="sd">    v_min_abs_extent : float</span>
<span class="sd">        Minimum absolute extent for the velocity range.</span>
<span class="sd">    r_default_if_empty : tuple</span>
<span class="sd">        Default (min, max) for radius range if data is empty.</span>
<span class="sd">    v_default_if_empty : tuple</span>
<span class="sd">        Default (min, max) for velocity range if data is empty.</span>
<span class="sd">    kmsec_to_kpcmyr : float</span>
<span class="sd">        Conversion factor from km/s to kpc/Myr (or its inverse depending on usage).</span>
<span class="sd">        Here, it&#39;s used to convert simulation velocity units to km/s.</span>
<span class="sd">    current_suffix_for_logging : str</span>
<span class="sd">        The current simulation suffix, used for logging messages.</span>
<span class="sd">    axis_name_prefix : str, optional</span>
<span class="sd">        Prefix for axis names in logging messages. Default is &quot;anim_global&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A tuple ((overall_min_r, overall_max_r), (overall_min_v, overall_max_v))</span>
<span class="sd">        representing the global ranges for radius and velocity. Returns default</span>
<span class="sd">        ranges if no valid data is found in the subset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rank_files_subset</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis_name_prefix</span><span class="si">}</span><span class="s2">: No rank files provided for global range calculation. Returning defaults.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">r_default_if_empty</span><span class="p">,</span> <span class="n">v_default_if_empty</span><span class="p">)</span>

    <span class="c1"># Use config parameters if available</span>
    <span class="n">percentile</span> <span class="o">=</span> <span class="mf">95.0</span>
    <span class="n">x_percentile_multiplier</span> <span class="o">=</span> <span class="mf">1.2</span>
    <span class="n">y_percentile_multiplier</span> <span class="o">=</span> <span class="mf">1.2</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">percentile</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;x_percentile&#39;</span><span class="p">,</span> <span class="mf">95.0</span><span class="p">)</span>
        <span class="n">x_percentile_multiplier</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;x_percentile_multiplier&#39;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
        <span class="n">y_percentile_multiplier</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;y_percentile_multiplier&#39;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
    
    <span class="c1"># Process only first and last frames</span>
    <span class="n">frames_to_check</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rank_files_subset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">frames_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rank_files_subset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># First frame</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rank_files_subset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">frames_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rank_files_subset</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Last frame</span>
    
    <span class="n">max_r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_v</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">any_valid_data_found</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="c1"># Define dtype list for efficient loading of specific columns</span>
    <span class="c1"># Rank(0), Mass(1), Radius(2), Vrad(3), Psi(4), Energy(5), L(6), Density(7)</span>
    <span class="c1"># We need Radius (2), Vrad (3), L (6)</span>
    <span class="n">cols_to_load_indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
    <span class="c1"># Dtype for *all* 8 columns of Rank_Mass_Rad_VRad_sorted*.dat</span>
    <span class="n">full_rank_sorted_dtype_list</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">]</span>
    
    <span class="c1"># Map loaded column index back to conceptual meaning (R, Vrad, L)</span>
    <span class="n">idx_map_radius</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idx_map_vrad</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">idx_map_l</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis_name_prefix</span><span class="si">}</span><span class="s2">: Calculating 95th percentile ranges for first and last frames (2 files max).&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">frames_to_check</span><span class="p">:</span>
        <span class="n">loaded_cols</span> <span class="o">=</span> <span class="n">load_specific_columns_bin</span><span class="p">(</span>
            <span class="n">fname</span><span class="p">,</span>
            <span class="n">ncols_total</span><span class="o">=</span><span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span><span class="p">,</span>
            <span class="n">cols_to_load</span><span class="o">=</span><span class="n">cols_to_load_indices</span><span class="p">,</span>
            <span class="n">dtype_list</span><span class="o">=</span><span class="n">full_rank_sorted_dtype_list</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">loaded_cols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_cols</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols_to_load_indices</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">radii_snap_raw</span> <span class="o">=</span> <span class="n">loaded_cols</span><span class="p">[</span><span class="n">idx_map_radius</span><span class="p">]</span>
        <span class="n">vrad_snap_raw</span> <span class="o">=</span> <span class="n">loaded_cols</span><span class="p">[</span><span class="n">idx_map_vrad</span><span class="p">]</span>
        <span class="n">l_snap_raw</span> <span class="o">=</span> <span class="n">loaded_cols</span><span class="p">[</span><span class="n">idx_map_l</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">loaded_cols</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Filter out non-positive radii</span>
        <span class="n">valid_radius_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">radii_snap_raw</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">radii_snap_raw</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_radius_mask</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">radii_snap</span> <span class="o">=</span> <span class="n">radii_snap_raw</span><span class="p">[</span><span class="n">valid_radius_mask</span><span class="p">]</span>
        <span class="n">vrad_snap</span> <span class="o">=</span> <span class="n">vrad_snap_raw</span><span class="p">[</span><span class="n">valid_radius_mask</span><span class="p">]</span>
        <span class="n">l_snap</span> <span class="o">=</span> <span class="n">l_snap_raw</span><span class="p">[</span><span class="n">valid_radius_mask</span><span class="p">]</span>

        <span class="c1"># Calculate total velocity in km/s</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
            <span class="n">tangential_velocity_sim</span> <span class="o">=</span> <span class="n">l_snap</span> <span class="o">/</span> <span class="n">radii_snap</span>
        <span class="n">total_velocity_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vrad_snap</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">tangential_velocity_sim</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">total_velocity_kms_snap</span> <span class="o">=</span> <span class="n">total_velocity_sim</span> <span class="o">/</span> <span class="n">kmsec_to_kpcmyr</span>

        <span class="c1"># Filter velocities for finite values</span>
        <span class="n">valid_velocity_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">total_velocity_kms_snap</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_velocity_mask</span><span class="p">):</span>
             <span class="k">continue</span>
        
        <span class="n">final_radii_snap</span> <span class="o">=</span> <span class="n">radii_snap</span><span class="p">[</span><span class="n">valid_velocity_mask</span><span class="p">]</span>
        <span class="n">final_total_velocity_kms_snap</span> <span class="o">=</span> <span class="n">total_velocity_kms_snap</span><span class="p">[</span><span class="n">valid_velocity_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">final_radii_snap</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="n">any_valid_data_found</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Calculate 95th percentile for this frame</span>
        <span class="n">r_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">final_radii_snap</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_percentile_multiplier</span>
        <span class="n">v_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">final_total_velocity_kms_snap</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_percentile_multiplier</span>
        
        <span class="c1"># Update maximum values</span>
        <span class="n">max_r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_r</span><span class="p">,</span> <span class="n">r_95</span><span class="p">)</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_v</span><span class="p">,</span> <span class="n">v_95</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">any_valid_data_found</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis_name_prefix</span><span class="si">}</span><span class="s2">: No valid data found in any snapshot files. Returning defaults.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">r_default_if_empty</span><span class="p">,</span> <span class="n">v_default_if_empty</span><span class="p">)</span>
    
    <span class="c1"># Apply minimum extents if needed</span>
    <span class="n">max_r</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_r</span><span class="p">,</span> <span class="n">r_min_abs_extent</span><span class="p">)</span>
    <span class="n">max_v</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_v</span><span class="p">,</span> <span class="n">v_min_abs_extent</span><span class="p">)</span>
    
    <span class="n">final_r_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_r</span><span class="p">)</span>
    <span class="n">final_v_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_v</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis_name_prefix</span><span class="si">}</span><span class="s2">: 95th percentile-based ranges (first/last frames): R=</span><span class="si">{</span><span class="n">final_r_range</span><span class="si">}</span><span class="s2">, V=</span><span class="si">{</span><span class="n">final_v_range</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">final_r_range</span><span class="p">,</span> <span class="n">final_v_range</span><span class="p">)</span>



<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_profile_animation_ranges</span><span class="p">(</span><span class="n">snapshots</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">data_index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                       <span class="n">x_default_max</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span> <span class="n">y_multiplier</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
                                       <span class="n">animation_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate X and Y axis ranges for profile animations using smart x-axis calculation</span>
<span class="sd">    based on where curves peak/decay or reach asymptotic values.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    snapshots : list</span>
<span class="sd">        List of snapshot tuples (snap, x_data, y_data)</span>
<span class="sd">    config : Configuration</span>
<span class="sd">        Configuration object (checked for use_median_ranges flag)</span>
<span class="sd">    data_index : int, optional</span>
<span class="sd">        Index of the data value in snapshot tuple (2 for most animations)</span>
<span class="sd">    x_default_max : float, optional</span>
<span class="sd">        Default maximum X value if calculation fails</span>
<span class="sd">    y_multiplier : float, optional</span>
<span class="sd">        Multiplier for Y-axis maximum (default 1.1 = 10% headroom)</span>
<span class="sd">    animation_name : str</span>
<span class="sd">        Name of the animation (used to determine calculation method)</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        ((x_min, x_max), y_max) where x_max is calculated based on profile behavior</span>
<span class="sd">        and y_max is multiplier × maximum y value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;use_median_ranges&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">use_median_ranges</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Use original behavior</span>
    
    <span class="c1"># Determine animation type based on name</span>
    <span class="n">is_mass_animation</span> <span class="o">=</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="n">animation_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
    <span class="c1"># Process only first and last snapshots for X-axis calculation</span>
    <span class="n">snapshots_to_check</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">snapshots_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># First frame</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">snapshots_to_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshots</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Last frame</span>
    
    <span class="n">max_x_candidate</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Y-axis still uses simple max across all frames</span>
    
    <span class="c1"># Calculate smart X-axis range from first/last frames</span>
    <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots_to_check</span><span class="p">:</span>
        <span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snapshot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># radius data</span>
        <span class="n">y_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snapshot</span><span class="p">[</span><span class="n">data_index</span><span class="p">])</span>  <span class="c1"># profile data</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Sort by radius to ensure proper ordering</span>
            <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span>
            <span class="n">x_sorted</span> <span class="o">=</span> <span class="n">x_data</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
            <span class="n">y_sorted</span> <span class="o">=</span> <span class="n">y_data</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">is_mass_animation</span><span class="p">:</span>
                <span class="c1"># For mass: find where curve rises above 97% of maximum</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_sorted</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">y_max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.97</span> <span class="o">*</span> <span class="n">y_max</span>
                    <span class="c1"># Find first radius where mass exceeds threshold</span>
                    <span class="n">above_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_sorted</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">above_threshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">radius_candidate</span> <span class="o">=</span> <span class="n">x_sorted</span><span class="p">[</span><span class="n">above_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">max_x_candidate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_x_candidate</span><span class="p">,</span> <span class="n">radius_candidate</span> <span class="o">*</span> <span class="mf">1.33</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For density/psi: find where curve drops below threshold of maximum</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_sorted</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">y_max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Use 5% for psi, 3% for density</span>
                    <span class="k">if</span> <span class="s2">&quot;psi&quot;</span> <span class="ow">in</span> <span class="n">animation_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">y_max</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.03</span> <span class="o">*</span> <span class="n">y_max</span>
                    <span class="c1"># Find the peak location first</span>
                    <span class="n">peak_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_sorted</span><span class="p">)</span>
                    
                    <span class="c1"># Look for drop below threshold after the peak</span>
                    <span class="k">if</span> <span class="n">peak_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_sorted</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">below_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y_sorted</span><span class="p">[</span><span class="n">peak_idx</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">below_threshold</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># Add peak_idx to get correct index in original array</span>
                            <span class="n">radius_candidate</span> <span class="o">=</span> <span class="n">x_sorted</span><span class="p">[</span><span class="n">peak_idx</span> <span class="o">+</span> <span class="n">below_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">max_x_candidate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_x_candidate</span><span class="p">,</span> <span class="n">radius_candidate</span> <span class="o">*</span> <span class="mf">1.33</span><span class="p">)</span>
    
    <span class="c1"># Calculate max Y across all frames (not just first/last)</span>
    <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
        <span class="n">y_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">snapshot</span><span class="p">[</span><span class="n">data_index</span><span class="p">])</span>  <span class="c1"># profile data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_data</span><span class="p">))</span>
    
    <span class="c1"># Use defaults if no valid data found</span>
    <span class="n">final_x_max</span> <span class="o">=</span> <span class="n">max_x_candidate</span> <span class="k">if</span> <span class="n">max_x_candidate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">x_default_max</span>
    <span class="n">final_y_max</span> <span class="o">=</span> <span class="n">max_y</span> <span class="o">*</span> <span class="n">y_multiplier</span> <span class="k">if</span> <span class="n">max_y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
    
    <span class="c1"># Log the calculated ranges</span>
    <span class="k">if</span> <span class="n">is_mass_animation</span><span class="p">:</span>
        <span class="n">calculation_method</span> <span class="o">=</span> <span class="s2">&quot;97</span><span class="si">% o</span><span class="s2">f max&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;psi&quot;</span> <span class="ow">in</span> <span class="n">animation_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">calculation_method</span> <span class="o">=</span> <span class="s2">&quot;5</span><span class="si">% o</span><span class="s2">f max after peak&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">calculation_method</span> <span class="o">=</span> <span class="s2">&quot;3</span><span class="si">% o</span><span class="s2">f max after peak&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">animation_name</span><span class="si">}</span><span class="s2"> animation: X range = [0, </span><span class="si">{</span><span class="n">final_x_max</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">] kpc (</span><span class="si">{</span><span class="n">calculation_method</span><span class="si">}</span><span class="s2">), Y max = </span><span class="si">{</span><span class="n">final_y_max</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">final_x_max</span><span class="p">),</span> <span class="n">final_y_max</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_robust_range_from_histogram</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">bin_counts</span><span class="p">,</span> 
                                          <span class="n">percentile</span><span class="o">=</span><span class="mf">95.0</span><span class="p">,</span> <span class="n">percentile_multiplier</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
                                          <span class="n">min_abs_extent</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                          <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;axis&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate robust plot range from pre-binned histogram data using percentile-based scaling.</span>
<span class="sd">    </span>
<span class="sd">    This function reconstructs the underlying distribution from histogram bins to calculate</span>
<span class="sd">    a percentile-based range that captures the bulk of the data while avoiding outliers.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bin_centers : array-like</span>
<span class="sd">        The center values of histogram bins (e.g., radius or velocity values).</span>
<span class="sd">    bin_counts : array-like</span>
<span class="sd">        The count/frequency in each bin.</span>
<span class="sd">    percentile : float</span>
<span class="sd">        Percentile to use for determining the range extent (e.g., 95.0).</span>
<span class="sd">    percentile_multiplier : float</span>
<span class="sd">        Factor to multiply the percentile value by when determining the range extent.</span>
<span class="sd">        Typical value: 1.2 for 20% padding beyond the percentile.</span>
<span class="sd">    min_abs_extent : float, optional</span>
<span class="sd">        Minimum absolute extent for the range. Default is 1.0.</span>
<span class="sd">        Ensures the range is at least this wide even for very concentrated data.</span>
<span class="sd">    default_if_empty : tuple, optional</span>
<span class="sd">        Default (min, max) range to use if no valid data. Default is (0, 1.0).</span>
<span class="sd">    can_be_negative : bool, optional</span>
<span class="sd">        Whether the data can have negative values. Default is False.</span>
<span class="sd">        If False, the minimum is clamped to 0.</span>
<span class="sd">    axis_name : str, optional</span>
<span class="sd">        Name of the axis for logging purposes. Default is &quot;axis&quot;.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (min_value, max_value) representing the calculated range.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The algorithm works by:</span>
<span class="sd">    1. Creating a weighted array where each bin center appears N times (N = bin count)</span>
<span class="sd">    2. Calculating the specified percentile of this reconstructed distribution</span>
<span class="sd">    3. Setting range as [0, percentile * multiplier] for non-negative data</span>
<span class="sd">    4. Applying minimum extent constraints</span>
<span class="sd">    5. Handling edge cases with appropriate defaults</span>
<span class="sd">    </span>
<span class="sd">    This is particularly useful for histogram data from nsphere.c where we have</span>
<span class="sd">    pre-binned data but still want to apply intelligent axis scaling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to numpy arrays and flatten</span>
    <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">bin_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bin_counts</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    
    <span class="c1"># Validate inputs</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_counts</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2">: Bin centers and counts have different lengths. Using defaults.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default_if_empty</span>
        
    <span class="c1"># Filter out bins with zero or negative counts</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">bin_counts</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">valid_centers</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
    <span class="n">valid_counts</span> <span class="o">=</span> <span class="n">bin_counts</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_centers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2">: No bins with positive counts. Using defaults.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default_if_empty</span>
        
    <span class="c1"># Reconstruct the distribution by repeating each bin center by its count</span>
    <span class="c1"># This gives us an array that represents the underlying distribution</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">reconstructed_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">valid_centers</span><span class="p">,</span> <span class="n">valid_counts</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">MemoryError</span><span class="p">:</span>
        <span class="c1"># If too much data, sample instead</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2">: Too much data for full reconstruction. Sampling instead.&quot;</span><span class="p">)</span>
        <span class="c1"># Use weighted random sampling</span>
        <span class="n">total_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_counts</span><span class="p">)</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="n">total_counts</span><span class="p">)</span>  <span class="c1"># Sample up to 1M points</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">valid_counts</span> <span class="o">/</span> <span class="n">total_counts</span>
        <span class="n">reconstructed_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">valid_centers</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probabilities</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">reconstructed_data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2">: No valid data after reconstruction. Using defaults.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default_if_empty</span>
        
    <span class="c1"># Sort the reconstructed data - necessary because filtered bin centers may not be contiguous</span>
    <span class="n">reconstructed_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reconstructed_data</span><span class="p">)</span>
    
    <span class="c1"># Calculate the specified percentile using direct index method</span>
    <span class="n">p_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">percentile</span> <span class="o">/</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reconstructed_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">data_percentile</span> <span class="o">=</span> <span class="n">reconstructed_data</span><span class="p">[</span><span class="n">p_index</span><span class="p">]</span>
    
    <span class="c1"># Calculate additional statistics for logging context</span>
    <span class="c1"># Now that data is sorted, we can calculate percentiles correctly</span>
    <span class="n">median_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reconstructed_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">data_median</span> <span class="o">=</span> <span class="n">reconstructed_data</span><span class="p">[</span><span class="n">median_index</span><span class="p">]</span>
    
    <span class="c1"># Calculate 25th and 75th percentiles for IQR</span>
    <span class="n">p25_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reconstructed_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">p75_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.75</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reconstructed_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">p25</span> <span class="o">=</span> <span class="n">reconstructed_data</span><span class="p">[</span><span class="n">p25_index</span><span class="p">]</span>
    <span class="n">p75</span> <span class="o">=</span> <span class="n">reconstructed_data</span><span class="p">[</span><span class="n">p75_index</span><span class="p">]</span>
    
    <span class="c1"># Calculate the range based on percentile</span>
    <span class="k">if</span> <span class="n">can_be_negative</span><span class="p">:</span>
        <span class="c1"># For data that can be negative, use percentile for both sides</span>
        <span class="n">max_abs_val</span> <span class="o">=</span> <span class="n">data_percentile</span> <span class="o">*</span> <span class="n">percentile_multiplier</span>
        <span class="n">min_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">max_abs_val</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="n">max_abs_val</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For non-negative data (like radius), start from 0</span>
        <span class="n">min_val</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data_percentile</span> <span class="o">*</span> <span class="n">percentile_multiplier</span><span class="p">,</span> <span class="n">min_abs_extent</span><span class="p">)</span>
        
    <span class="c1"># Log the statistics</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">axis_name</span><span class="si">}</span><span class="s2"> histogram statistics: </span><span class="si">{</span><span class="n">percentile</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">th percentile=</span><span class="si">{</span><span class="n">data_percentile</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;median=</span><span class="si">{</span><span class="n">data_median</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, IQR=[</span><span class="si">{</span><span class="n">p25</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">p75</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">], range=[</span><span class="si">{</span><span class="n">min_val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">max_val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>


<div class="viewcode-block" id="filter_finite_rows">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.filter_finite_rows">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">filter_finite_rows</span><span class="p">(</span><span class="o">*</span><span class="n">arrs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter out rows containing NaN or Inf values across multiple arrays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *arrs : array-like</span>
<span class="sd">        Variable number of arrays to filter. All must have the same length.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        New arrays with invalid rows removed from all input arrays.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function removes any row that contains NaN or Inf in ANY of the input arrays.</span>
<span class="sd">    All arrays must have the same length for proper row-wise filtering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arrs</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arrs</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrs</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Arrays must have the same length to apply filter_finite_rows.&quot;</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">arr</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrs</span><span class="p">]</span></div>


<span class="c1"># Additional column counts derived from the base counts</span>
<span class="n">ncol_trajectories</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ncol_traj_particles</span>
<span class="n">ncol_single_trajectory</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">ncol_energy_and_angular_momentum_vs_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">ncol_traj_particles</span>
<span class="n">ncol_lowest_l_trajectories</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">nlowest</span>
<span class="n">ncol_2d_hist_initial</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ncol_2d_hist_final</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ncol_all_particle_data_snapshot</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">ncol_Rank_Mass_Rad_VRad_unsorted</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1"># Parameter information is displayed in the main function header</span>

<div class="viewcode-block" id="get_mem_usage_mb">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.get_mem_usage_mb">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_mem_usage_mb</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get current memory usage of the Python process.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Current Resident Set Size (RSS) memory usage in megabytes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Provides the actual physical memory being used by the Python process</span>
<span class="sd">    using the psutil library to access system resource information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">proc</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1024.0</span> <span class="o">*</span> <span class="mf">1024.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_timer_energy_plots">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.update_timer_energy_plots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_timer_energy_plots</span><span class="p">(</span><span class="n">stop_timer</span><span class="p">,</span> <span class="n">energy_plot_start_time</span><span class="p">,</span> <span class="n">paced_mode</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Continuously update the timer display for energy plot processing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stop_timer : threading.Event</span>
<span class="sd">        Event to signal when to stop the timer thread</span>
<span class="sd">    energy_plot_start_time : float</span>
<span class="sd">        Time when energy plot processing started</span>
<span class="sd">    paced_mode : bool</span>
<span class="sd">        Whether the visualization is in paced mode (with deliberate delays)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Runs in a separate thread and updates the console with elapsed time,</span>
<span class="sd">    estimated remaining time, and processing rate. Updates every 0.1 seconds</span>
<span class="sd">    until stop_timer is set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Only wait briefly to let the initial display settle</span>
    <span class="k">if</span> <span class="n">paced_mode</span><span class="p">:</span>
        <span class="c1"># In paced mode, use longer delay for better visualization</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># In fast mode (default), use minimal delay</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">stop_timer</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">cur_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">energy_plot_start_time</span>
        <span class="c1"># Apply a minimum nominal time to prevent unrealistically high rates</span>
        <span class="c1"># For display purposes, ensure elapsed time is at least 0.01 seconds</span>
        <span class="n">displayed_elapsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cur_elapsed</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Minimum displayed time</span>
        <span class="n">nominal_elapsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cur_elapsed</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>  <span class="c1"># Minimum for rate calculation</span>
        <span class="n">est_remaining</span> <span class="o">=</span> <span class="n">nominal_elapsed</span>  <span class="c1"># Estimate remaining time based on elapsed</span>
        <span class="n">cur_rate</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">nominal_elapsed</span>  <span class="c1"># 0.5 plots in the elapsed time</span>
        <span class="c1"># Cap the rate at a reasonable maximum for display</span>
        <span class="n">cur_rate</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cur_rate</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">)</span>

        <span class="c1"># Format the current timing info with extra padding spaces</span>
        <span class="n">time_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; [</span><span class="si">{</span><span class="n">displayed_elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">est_remaining</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">cur_rate</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">file/s]&quot;</span>

        <span class="c1"># Print the progress bar and current plot name inline with extra padding</span>
        <span class="n">bar_length</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">half_filled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bar_length</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">half_bar</span> <span class="o">=</span> <span class="s1">&#39;█&#39;</span> <span class="o">*</span> <span class="n">half_filled</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">bar_length</span> <span class="o">-</span> <span class="n">half_filled</span><span class="p">)</span>

        <span class="c1"># Get current file prefix</span>
        <span class="n">unsorted_name</span> <span class="o">=</span> <span class="s2">&quot;Energy_vs_timestep_unsorted&quot;</span>  <span class="c1"># Base name without suffix</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">get_file_prefix</span><span class="p">(</span><span class="n">unsorted_name</span><span class="p">)</span>

        <span class="c1"># Use ANSI escape sequences to update progress in-place</span>
        <span class="c1"># Truncate the content part of the string</span>
        <span class="n">content_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Save: </span><span class="si">{</span><span class="n">half_bar</span><span class="si">}</span><span class="s2"> 50.0% | File: </span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">time_info</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[2K</span><span class="si">{</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="n">content_string</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Sleep briefly to avoid high CPU usage</span>
        <span class="k">if</span> <span class="n">paced_mode</span><span class="p">:</span>
            <span class="c1"># In paced mode, use longer delay for better visualization</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># In fast mode (default), use minimal delay</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_snapshot_number">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.get_snapshot_number">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_snapshot_number</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the snapshot number from a filename containing a timestamp pattern.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Filename to extract snapshot number from</span>
<span class="sd">    pattern : re.Pattern, optional</span>
<span class="sd">        Compiled regex pattern to use. If None, defaults to Rank_Mass_Rad_VRad_sorted_t pattern.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Snapshot number extracted from filename, or a very large number if no match found</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses regular expression matching to extract the snapshot number from filenames</span>
<span class="sd">    that follow a pattern like &quot;Rank_Mass_Rad_VRad_sorted_t00012&quot;. Returns a large</span>
<span class="sd">    value for non-matching files to ensure they sort after valid snapshot files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">suffix</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Build a pattern that correctly handles the suffix</span>
        <span class="n">pattern_str</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Rank_Mass_Rad_VRad_sorted_t(\d+)&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\.dat$&#39;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern_str</span><span class="p">)</span>

    <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">999999999</span></div>


<div class="viewcode-block" id="get_file_prefix">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.get_file_prefix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_file_prefix</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the filename prefix without path, extension or suffix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        Full path or filename to process</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The extracted filename prefix</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; get_file_prefix(&#39;results/phase_space_initial_kris_40000_1001_5.png&#39;)</span>
<span class="sd">    &#39;phase_space_initial&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_file_prefix(&#39;loading_combined_histogram&#39;)</span>
<span class="sd">    &#39;combined_histogram&#39;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Handles special cases including loading prefixes and various suffix</span>
<span class="sd">    patterns. For files with a standard suffix pattern (_tag_nnn_nnn_n),</span>
<span class="sd">    removes these components to extract the core filename.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make sure filepath is a string (handle None or other types)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="c1"># Special handling for &quot;loading_&quot; identifiers</span>
    <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;loading_&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">filepath</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>  <span class="c1"># Remove &quot;loading_&quot; prefix</span>

    <span class="c1"># Get the filename without the path</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="c1"># Remove the extension</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># For files with the suffix, remove the suffix part</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

    <span class="c1"># Handle potential energy_compare filename change</span>
    <span class="k">if</span> <span class="n">prefix</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;energy_compare&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">prefix</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;debug_energy_compare&quot;</span><span class="p">):</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;energy_compare&quot;</span><span class="p">,</span> <span class="s2">&quot;debug_energy_compare&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># If the filename has a suffix pattern _tag_nnn_nnn_n</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]):</span>
        <span class="c1"># Remove the last parts that match the suffix pattern</span>
        <span class="c1"># For files with the pattern name_tag_npts_Ntimes_tfinal_factor</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Keep everything before the suffix</span>
            <span class="c1"># Re-check prefix after potential rename</span>
            <span class="n">prefix_parts</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix_parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="n">prefix_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="k">else</span> <span class="n">prefix_parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># If the file path looks like &quot;loading_something_convergence_data&quot; or other non-filename format</span>
    <span class="c1"># (used for progress updates), just return the basename without special processing</span>
    <span class="k">if</span> <span class="s2">&quot;loading_&quot;</span> <span class="ow">in</span> <span class="n">prefix</span> <span class="ow">or</span> <span class="s2">&quot;processing_&quot;</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">prefix</span>

    <span class="k">return</span> <span class="n">prefix</span></div>


<div class="viewcode-block" id="load_partial_file">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.load_partial_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_partial_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load data from file, handling incomplete or partially-written lines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the file to read</span>
<span class="sd">    dtype : numpy.dtype, optional</span>
<span class="sd">        Data type to use for the array, by default np.float32</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray or None</span>
<span class="sd">        Array containing the data successfully read from the file, or None if</span>
<span class="sd">        the file doesn&#39;t exist or contains no valid data</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function stops reading if it encounters a line it cannot parse,</span>
<span class="sd">    returning all data successfully read up to that point. This is useful</span>
<span class="sd">    for handling files that might be incomplete or partially written.</span>

<span class="sd">    Skips blank lines and stops reading at the first parsing error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Skip if file doesn&#39;t exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> not found. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">valid_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">stripped</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stripped</span><span class="p">:</span>
                <span class="c1"># skip blank lines</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">stripped</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># If there&#39;s a parse error (e.g., incomplete line),</span>
                <span class="c1"># Stop reading further</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># If line was empty or couldn&#39;t parse anything, stop</span>
                <span class="k">continue</span>
            <span class="n">valid_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valid_rows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_partial_file_bin">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.load_partial_file_bin">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_partial_file_bin</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load data from binary file with support for different data types.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the binary file to read</span>
<span class="sd">    ncols : int</span>
<span class="sd">        Number of columns expected in the data</span>
<span class="sd">    dtype : numpy.dtype or list, optional</span>
<span class="sd">        Data type(s) to use for the array, by default np.float32</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray or None</span>
<span class="sd">        Array containing the data from the file, or None if the file</span>
<span class="sd">        is missing or contains no valid data</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Supports two different modes of operation:</span>

<span class="sd">    1. Single dtype (e.g., np.float32):</span>
<span class="sd">       Returns array of shape (N, ncols)</span>

<span class="sd">    2. List/tuple of dtypes:</span>
<span class="sd">       Returns structured array with fields named &#39;f0&#39;, &#39;f1&#39;, ..., &#39;f{ncols-1}&#39;,</span>
<span class="sd">       each with its corresponding dtype from the list</span>

<span class="sd">    Uses align=False to ensure tight packing of structured arrays.</span>
<span class="sd">    Reads as many complete rows as possible from the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> not found. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Get file size for diagnostics</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># Log file size for very small files (&lt;1000 bytes) to help debug issues</span>
    <span class="k">if</span> <span class="n">file_size</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Small binary file detected: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, size: </span><span class="si">{</span><span class="n">file_size</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Empty binary file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, size: </span><span class="si">{</span><span class="n">file_size</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Check if dtype is a list of dtypes =&gt; build structured dtype</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: dtype list length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="si">}</span><span class="s2"> != ncols=</span><span class="si">{</span><span class="n">ncols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Build fields: [(&quot;f0&quot;, dtype[0]), (&quot;f1&quot;, dtype[1]), ...]</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">structured</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">itemsize</span> <span class="o">=</span> <span class="n">structured</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">//</span> <span class="n">itemsize</span>

        <span class="c1"># Log extra diagnostics for small files</span>
        <span class="k">if</span> <span class="n">nrows</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binary file has few rows: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, raw bytes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="si">}</span><span class="s2">, itemsize: </span><span class="si">{</span><span class="n">itemsize</span><span class="si">}</span><span class="s2">, estimated rows: </span><span class="si">{</span><span class="n">nrows</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nrows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No complete rows found in binary file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, raw bytes: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="si">}</span><span class="s2">, itemsize: </span><span class="si">{</span><span class="n">itemsize</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># For very small files, log hex dump of raw bytes to help debug</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw binary data (hex): </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="s1">02x</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">raw</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Drop leftover bytes</span>
        <span class="n">bytes_to_use</span> <span class="o">=</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">itemsize</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bytes_to_use</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Partial final row detected: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, using </span><span class="si">{</span><span class="n">bytes_to_use</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[:</span><span class="n">bytes_to_use</span><span class="p">]</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">structured</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># For debugging small datasets, log some content</span>
        <span class="k">if</span> <span class="n">nrows</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Structured array content (first </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows): </span><span class="si">{</span><span class="n">arr</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">nrows</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;empty&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">arr</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Normal single-dtype path</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">full_count</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="n">ncols</span>

        <span class="c1"># Log extra diagnostics for small arrays</span>
        <span class="k">if</span> <span class="n">full_count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Binary file has few rows: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, array size: </span><span class="si">{</span><span class="n">arr</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">, columns: </span><span class="si">{</span><span class="n">ncols</span><span class="si">}</span><span class="s2">, complete rows: </span><span class="si">{</span><span class="n">full_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">full_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No complete rows found in binary file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, array size: </span><span class="si">{</span><span class="n">arr</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">, columns: </span><span class="si">{</span><span class="n">ncols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># For very small arrays, log raw values to help debug</span>
            <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw array values: </span><span class="si">{</span><span class="n">arr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:</span><span class="n">full_count</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">full_count</span><span class="p">,</span> <span class="n">ncols</span><span class="p">))</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># For debugging small datasets, log some content</span>
        <span class="k">if</span> <span class="n">full_count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Array content (first </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">full_count</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows): </span><span class="si">{</span><span class="n">arr</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">full_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;empty&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="safe_load_and_filter">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.safe_load_and_filter">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_load_and_filter</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and filter data from file with error handling.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the file to read</span>
<span class="sd">    dtype : numpy.dtype, optional</span>
<span class="sd">        Data type to use for the array, by default np.float32</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray or None</span>
<span class="sd">        Filtered array containing only valid data, or None if</span>
<span class="sd">        the file doesn&#39;t exist or contains no valid data</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function performs three steps:</span>

<span class="sd">    1. Verifies the file exists</span>
<span class="sd">    2. Loads as much data as possible using load_partial_file</span>
<span class="sd">    3. Filters out rows containing NaN or Inf values</span>

<span class="sd">    Returns None with appropriate warnings if the file is missing or</span>
<span class="sd">    contains no valid data after filtering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> does not exist. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">load_partial_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Means either the file was missing or empty or partial lines only</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> had no valid data. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Filter out any invalid (NaN/Inf) rows</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: After filtering, </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> had no valid rows. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="safe_load_and_filter_bin">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.safe_load_and_filter_bin">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and filter binary data with support for structured arrays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the binary file to read</span>
<span class="sd">    ncols : int</span>
<span class="sd">        Number of columns expected in the data</span>
<span class="sd">    dtype : numpy.dtype or list, optional</span>
<span class="sd">        Data type(s) to use for the array, by default np.float32</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray or None</span>
<span class="sd">        2D float array containing only valid data, or None if</span>
<span class="sd">        the file doesn&#39;t exist or contains no valid data</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function performs four steps:</span>

<span class="sd">    1. Verifies the file exists</span>
<span class="sd">    2. Loads binary data using load_partial_file_bin</span>
<span class="sd">    3. Converts structured arrays to standard floating-point arrays if needed</span>
<span class="sd">    4. Filters out rows containing NaN or Inf values</span>

<span class="sd">    For structured arrays (when dtype is a list), each field is extracted and</span>
<span class="sd">    converted to float32 before filtering. This ensures consistent handling</span>
<span class="sd">    regardless of the original data types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> does not exist. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">load_partial_file_bin</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> had no valid data. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Handle structured arrays (from list dtype) differently</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="c1"># Convert structured array to a regular 2D array with all fields as float32</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">float_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Extract each field and convert to float</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">float_data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Replace structured array with regular float array</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">float_data</span>

        <span class="c1"># Apply isfinite to the standard array</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For regular arrays, just filter normally</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: After filtering, </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> had no valid rows. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="load_specific_columns_bin">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.load_specific_columns_bin">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_specific_columns_bin</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ncols_total</span><span class="p">,</span> <span class="n">cols_to_load</span><span class="p">,</span> <span class="n">dtype_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads specific columns from a flat binary file using memory mapping.</span>

<span class="sd">    This version uses numpy.memmap for efficiency with large files, reading</span>
<span class="sd">    only necessary data pages from disk into memory when columns are accessed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the binary file.</span>
<span class="sd">    ncols_total : int</span>
<span class="sd">        Total number of columns (fields) in each row of the file.</span>
<span class="sd">    cols_to_load : list[int]</span>
<span class="sd">        List of 0-based column indices to load and return.</span>
<span class="sd">    dtype_list : list</span>
<span class="sd">        List of numpy dtypes corresponding to *all* columns in the file,</span>
<span class="sd">        in order. E.g., [np.int32, np.float32, np.float32, ...].</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[np.ndarray] or None</span>
<span class="sd">        A list containing 1D numpy arrays (as float32) for each requested</span>
<span class="sd">        column, filtered for finite values based on the loaded columns.</span>
<span class="sd">        Returns None if the file doesn&#39;t exist, cannot be mapped,</span>
<span class="sd">        or contains no valid data in requested columns.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Requires the `dtype_list` specifying the type for *all* columns</span>
<span class="sd">    to correctly interpret the binary structure for memmap.</span>
<span class="sd">    Returned arrays are converted to float32 for consistency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memmap loader: File not found </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtype_list</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ncols_total</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memmap loader: Invalid dtype_list provided for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">. Expected list of length </span><span class="si">{</span><span class="n">ncols_total</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
         <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Define the structured dtype for the entire row</span>
        <span class="n">row_fields</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s1">&#39;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dtype_list</span><span class="p">)]</span>
        <span class="n">row_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">row_fields</span><span class="p">)</span>
        <span class="n">item_size</span> <span class="o">=</span> <span class="n">row_dtype</span><span class="o">.</span><span class="n">itemsize</span>

        <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_size</span> <span class="o">&lt;</span> <span class="n">item_size</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memmap loader: File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is smaller than one row.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Calculate number of rows based on file size and item size</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="n">file_size</span> <span class="o">//</span> <span class="n">item_size</span>
        <span class="k">if</span> <span class="n">num_rows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memmap loader: No complete rows found in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Memory-map the file</span>
        <span class="c1"># mode=&#39;r&#39; is read-only</span>
        <span class="n">mmap_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">row_dtype</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,))</span>

        <span class="c1"># Extract required columns using field names</span>
        <span class="c1"># Create copies to bring data into memory and ensure float32</span>
        <span class="n">extracted_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">col_names_to_load</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols_to_load</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names_to_load</span><span class="p">:</span>
            <span class="c1"># Access column via field name, convert to float32 and copy into RAM</span>
            <span class="c1"># Using copy() is crucial when the memmap will be closed.</span>
            <span class="n">extracted_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mmap_array</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="c1"># Filter based on finiteness of all loaded columns *together*</span>
        <span class="c1"># Stack columns temporarily for efficient masking</span>
        <span class="n">valid_cols_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">extracted_cols</span><span class="p">)</span>
        <span class="n">finite_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">valid_cols_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">valid_cols_data</span> <span class="c1"># Free temporary stack</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">finite_mask</span><span class="p">):</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memmap loader: No finite rows for requested columns in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="c1"># Clean up memmap object before returning</span>
             <span class="k">del</span> <span class="n">mmap_array</span>
             <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
             <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Apply mask to the list of extracted columns</span>
        <span class="n">filtered_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="n">finite_mask</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">extracted_cols</span><span class="p">]</span>

        <span class="c1"># Clean up memmap object explicitly (important!)</span>
        <span class="k">del</span> <span class="n">mmap_array</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">filtered_cols</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memmap loader: Error processing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="c1"># Ensure memmap is cleaned up if partially created</span>
        <span class="k">if</span> <span class="s1">&#39;mmap_array&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">mmap_array</span><span class="o">.</span><span class="n">_mmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">mmap_array</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="load_partial_file_10">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.load_partial_file_10">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_partial_file_10</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the first 10 lines from a text file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the file to read</span>
<span class="sd">    dtype : numpy.dtype, optional</span>
<span class="sd">        Data type to use for the array, by default np.float32</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray or None</span>
<span class="sd">        Array containing the data from the first 10 lines of the file,</span>
<span class="sd">        or None if the file doesn&#39;t exist or contains no valid data</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Useful for quickly previewing or analyzing the beginning of a large file</span>
<span class="sd">    without loading the entire dataset into memory. Only reads the first 10</span>
<span class="sd">    lines that contain valid data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Only read 10 lines</span>
                <span class="k">break</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Convert the lines to a numpy array</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="safe_load_and_filter_10">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.safe_load_and_filter_10">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_load_and_filter_10</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and filter the first 10 lines from a text file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the file to read</span>
<span class="sd">    dtype : numpy.dtype, optional</span>
<span class="sd">        Data type to use for the array, by default np.float32</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray or None</span>
<span class="sd">        Filtered array containing only valid data from the first 10 lines,</span>
<span class="sd">        or None if the file doesn&#39;t exist or contains no valid data</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Similar to safe_load_and_filter but only reads the first 10 lines.</span>
<span class="sd">    Useful for analyzing the beginning of large files efficiently.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> does not exist. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">load_partial_file_10</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> had no valid data. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Filter out any invalid (NaN/Inf) rows</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: After filtering, </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> had no valid rows. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="safe_load_and_filter_10_bin">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.safe_load_and_filter_10_bin">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_load_and_filter_10_bin</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load and filter the first 10 rows from a binary file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the binary file to read</span>
<span class="sd">    ncols : int</span>
<span class="sd">        Number of columns expected in the data</span>
<span class="sd">    dtype : numpy.dtype or list, optional</span>
<span class="sd">        Data type(s) to use for the array, by default np.float32</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray or None</span>
<span class="sd">        Filtered array containing only valid data from the first 10 rows,</span>
<span class="sd">        or None if the file doesn&#39;t exist or contains no valid data</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Performs the following steps:</span>

<span class="sd">    1. Checks if file exists</span>
<span class="sd">    2. Loads entire binary file via load_partial_file_bin</span>
<span class="sd">    3. Slices off the first 10 rows (if available)</span>
<span class="sd">    4. Filters out invalid rows (NaN/Inf)</span>
<span class="sd">    5. Returns the filtered array, or None if empty/no valid rows</span>

<span class="sd">    Useful for analyzing the beginning of large binary files efficiently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> does not exist. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">load_partial_file_bin</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> had no valid data (or is empty). Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Keep only the first 10 rows (or fewer if file has &lt;10 rows)</span>
    <span class="n">max_needed</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">max_needed</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Filter out any invalid (NaN/Inf) rows</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: After filtering, </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> had no valid rows. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="safe_load_particle_ids_bin">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.safe_load_particle_ids_bin">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_load_particle_ids_bin</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">particle_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load data for specific particle IDs from a flat binary file.</span>

<span class="sd">    Uses efficient file seeking for basic numpy dtypes (e.g., np.float32)</span>
<span class="sd">    to read only requested rows. Falls back to loading the full file via</span>
<span class="sd">    `load_partial_file_bin` for complex/structured dtypes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the binary file (assumed flat row data).</span>
<span class="sd">    ncols : int</span>
<span class="sd">        Number of columns per row.</span>
<span class="sd">    particle_ids : array-like</span>
<span class="sd">        Array of particle IDs (0-based row indices) to extract.</span>
<span class="sd">    dtype : numpy.dtype or list, optional</span>
<span class="sd">        Data type of file contents. Basic numpy dtypes trigger optimized</span>
<span class="sd">        seek-based reading. Lists/tuples trigger a full read and fallback</span>
<span class="sd">        extraction. Default is np.float32.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray or None</span>
<span class="sd">        Numpy array (float32) containing only the rows for the specified</span>
<span class="sd">        particle IDs (NaNs for missing/invalid IDs), or None if file</span>
<span class="sd">        doesn&#39;t exist or a fatal error occurs. Returns float32 array</span>
<span class="sd">        even if input dtype has different precision.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Basic validation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Check if we should use the optimized path</span>
    <span class="n">use_optimized_path</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;itemsize&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_optimized_path</span><span class="p">:</span>
         <span class="n">data</span> <span class="o">=</span> <span class="n">load_partial_file_bin</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="c1"># Existing full load</span>
         <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
             <span class="k">return</span> <span class="kc">None</span>
         <span class="c1"># Convert structured to float32 if needed (logic from safe_load_and_filter_bin)</span>
         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">float_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">):</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;f</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">float_data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">float_data</span>
         <span class="c1"># Now extract rows using boolean indexing (less efficient than direct seek)</span>
         <span class="n">num_particles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">particle_ids</span><span class="p">)</span>
         <span class="n">result_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_particles</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
         <span class="c1"># Need unique IDs and sort order for efficient lookup if using fallback</span>
         <span class="n">unique_ids</span><span class="p">,</span> <span class="n">original_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">particle_ids</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
         <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">unique_ids</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">unique_ids</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
         <span class="n">found_ids</span> <span class="o">=</span> <span class="n">unique_ids</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">extracted_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">found_ids</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c1"># Map back to original particle_ids order</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">pid</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">found_ids</span><span class="p">)}</span>
            <span class="n">original_mask_for_found</span> <span class="o">=</span> <span class="n">valid_mask</span><span class="p">[</span><span class="n">original_indices</span><span class="p">]</span>
            <span class="n">result_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">original_mask_for_found</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">source_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">mapping</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particle_ids</span><span class="p">)[</span><span class="n">original_mask_for_found</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                 <span class="n">result_array</span><span class="p">[</span><span class="n">result_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted_data</span><span class="p">[</span><span class="n">source_indices</span><span class="p">]</span>
         <span class="k">return</span> <span class="n">result_array</span>

    <span class="c1"># --- Start: Optimized path for basic dtypes like float32 ---</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">item_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="n">row_size</span> <span class="o">=</span> <span class="n">ncols</span> <span class="o">*</span> <span class="n">item_size</span>
        <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">max_rows</span> <span class="o">=</span> <span class="n">file_size</span> <span class="o">//</span> <span class="n">row_size</span>

        <span class="k">if</span> <span class="n">row_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">max_rows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">num_requested</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">particle_ids</span><span class="p">)</span>
        <span class="c1"># Ensure result array is float32, regardless of input dtype&#39;s precision</span>
        <span class="n">result_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_requested</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">found_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">particle_ids</span><span class="p">):</span>
                <span class="c1"># Check if pid is a valid row index for this file</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">pid</span> <span class="o">&lt;</span> <span class="n">max_rows</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">pid</span> <span class="o">*</span> <span class="n">row_size</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                    <span class="n">row_bytes</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">row_size</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row_bytes</span><span class="p">)</span> <span class="o">==</span> <span class="n">row_size</span><span class="p">:</span>
                        <span class="c1"># Convert bytes to numpy array of the specified dtype</span>
                        <span class="n">row_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">row_bytes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ncols</span><span class="p">)</span>
                        <span class="c1"># Store as float32</span>
                        <span class="n">result_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">found_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">found_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">result_array</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_density">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_density">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_density</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">rho_values</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot density profile as a function of radius and save to file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r_values : array-like</span>
<span class="sd">        Radius values in kpc</span>
<span class="sd">    rho_values : array-like</span>
<span class="sd">        Density values (rho) at each radius</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Path to save the output plot, by default &quot;density_profile.png&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved plot file</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Filters out any non-finite values before plotting.</span>
<span class="sd">    Creates a figure showing density as a function of radius with</span>
<span class="sd">    appropriate labels and grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r_values</span><span class="p">,</span> <span class="n">rho_values</span> <span class="o">=</span> <span class="n">filter_finite_rows</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">rho_values</span><span class="p">)</span>
    
    <span class="c1"># Filter for positive values only for log scale</span>
    <span class="n">positive_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rho_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">positive_mask</span><span class="p">):</span>
        <span class="n">r_pos</span> <span class="o">=</span> <span class="n">r_values</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>
        <span class="n">rho_pos</span> <span class="o">=</span> <span class="n">rho_values</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">r_pos</span><span class="p">,</span> <span class="n">rho_pos</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\rho(r)$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\rho(r)$ (M$_{\odot}$/kpc$^3$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Radial Density Profile $\rho(r)$ (Log-Log)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/density_profile</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback to empty plot if no valid data</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No valid data for log-log plot&#39;</span><span class="p">,</span> 
                 <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Radial Density Profile $\rho(r)$ (Log-Log)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/density_profile</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    
    <span class="n">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="plot_mass_enclosed">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_mass_enclosed">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_mass_enclosed</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">mass_values</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot enclosed mass as a function of radius and save to file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r_values : array-like</span>
<span class="sd">        Radius values in kpc</span>
<span class="sd">    mass_values : array-like</span>
<span class="sd">        Enclosed mass values at each radius in Msun</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Path to save the output plot, by default &quot;mass_enclosed.png&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved plot file</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Filters out any non-finite values before plotting. Creates a figure</span>
<span class="sd">    showing the mass enclosed within each radius with appropriate labels and grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r_values</span><span class="p">,</span> <span class="n">mass_values</span> <span class="o">=</span> <span class="n">filter_finite_rows</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">mass_values</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">mass_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$M(r)$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$M(r)$ (M$_\odot$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Enclosed Mass Profile $M(r)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/mass_enclosed</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="n">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="plot_psi">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_psi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_psi</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">psi_values</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot gravitational potential (Psi) as a function of radius and save to file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r_values : array-like</span>
<span class="sd">        Radius values in kpc</span>
<span class="sd">    psi_values : array-like</span>
<span class="sd">        Gravitational potential values at each radius (in km^2/s^2)</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Path to save the output plot, by default &quot;psi_profile.png&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Function does not return a value, but saves plot to the specified path</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Filters out any non-finite values before plotting.</span>
<span class="sd">    Creates a figure showing gravitational potential as a function of radius</span>
<span class="sd">    with appropriate labels and grid. Assumes psi_values are already scaled.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r_values</span><span class="p">,</span> <span class="n">psi_values</span> <span class="o">=</span> <span class="n">filter_finite_rows</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">psi_values</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">psi_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\Psi(r)$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Psi(r)$ (km$^2$/s$^2$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Gravitational Potential Profile $\Psi(r)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/psi_profile</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_dpsi_dr">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_dpsi_dr">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_dpsi_dr</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">dpsi_values</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;dpsi_dr.png&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot gravitational acceleration (dPsi/dr) as a function of radius and save to file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r_values : array-like</span>
<span class="sd">        Radius values in kpc</span>
<span class="sd">    dpsi_values : array-like</span>
<span class="sd">        Gravitational acceleration values at each radius</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Path to save the output plot, by default &quot;dpsi_dr.png&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Function does not return a value, but saves plot to the specified path</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Filters out any non-finite values before plotting.</span>
<span class="sd">    Creates a figure showing gravitational acceleration (dPsi/dr) as a</span>
<span class="sd">    function of radius with appropriate labels and grid.</span>
<span class="sd">    Units of dPsi/dr are typically (km/s)^2 / kpc.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r_values</span><span class="p">,</span> <span class="n">dpsi_values</span> <span class="o">=</span> <span class="n">filter_finite_rows</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">dpsi_values</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_values</span><span class="p">,</span> <span class="n">dpsi_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$d\Psi/dr$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$d\Psi/dr$ ((km/s)$^2$/kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Gravitational Acceleration Profile $d\Psi/dr$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_drho_dpsi">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_drho_dpsi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_drho_dpsi</span><span class="p">(</span><span class="n">psi_values</span><span class="p">,</span> <span class="n">drho_dpsi</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;drho_dpsi.png&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot derivative of density with respect to potential and save to file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    psi_values : array-like</span>
<span class="sd">        Gravitational potential values (in km^2/s^2)</span>
<span class="sd">    drho_dpsi : array-like</span>
<span class="sd">        Derivative of density with respect to potential</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Path to save the output plot, by default &quot;drho_dpsi.png&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Function does not return a value, but saves plot to the specified path</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Filters out any non-finite values before plotting.</span>
<span class="sd">    Creates a figure showing the derivative of density with respect to</span>
<span class="sd">    gravitational potential with appropriate labels and grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">psi_values</span><span class="p">,</span> <span class="n">drho_dpsi</span> <span class="o">=</span> <span class="n">filter_finite_rows</span><span class="p">(</span><span class="n">psi_values</span><span class="p">,</span> <span class="n">drho_dpsi</span><span class="p">)</span>

    <span class="c1"># Filter for positive values only for log scale</span>
    <span class="n">positive_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">psi_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">drho_dpsi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">positive_mask</span><span class="p">):</span>
        <span class="n">psi_pos</span> <span class="o">=</span> <span class="n">psi_values</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>
        <span class="n">drho_dpsi_pos</span> <span class="o">=</span> <span class="n">drho_dpsi</span><span class="p">[</span><span class="n">positive_mask</span><span class="p">]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">psi_pos</span><span class="p">,</span> <span class="n">drho_dpsi_pos</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$d\rho/d\Psi$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Psi$ (km$^2$/s$^2$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$d\rho/d\Psi$ ((M$_\odot$/kpc$^3$)/(km$^2$/s$^2$))&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Density Derivative $d\rho/d\Psi$ (Log-Log)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback to empty plot if no valid data</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;No valid data for log-log plot&#39;</span><span class="p">,</span>
                 <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Density Derivative $d\rho/d\Psi$ (Log-Log)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_f_of_E">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_f_of_E">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_f_of_E</span><span class="p">(</span><span class="n">E_values</span><span class="p">,</span> <span class="n">f_values</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;f_of_E.png&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot distribution function as a function of energy and save to file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    E_values : array-like</span>
<span class="sd">        Energy values</span>
<span class="sd">    f_values : array-like</span>
<span class="sd">        Distribution function values at each energy</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Path to save the output plot, by default &quot;f_of_E.png&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved plot file</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Filters out any non-finite values before plotting.</span>
<span class="sd">    Creates a figure showing the distribution function (f(E)) as a</span>
<span class="sd">    function of energy with appropriate labels and grid.</span>
<span class="sd">    Uses log-log scale for better visualization.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">E_values</span><span class="p">,</span> <span class="n">f_values</span> <span class="o">=</span> <span class="n">filter_finite_rows</span><span class="p">(</span><span class="n">E_values</span><span class="p">,</span> <span class="n">f_values</span><span class="p">)</span>
    
    <span class="c1"># Filter out zero or negative values for log-log plot</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">E_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">E_values</span> <span class="o">=</span> <span class="n">E_values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">f_values</span> <span class="o">=</span> <span class="n">f_values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">E_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No positive values to plot for f_of_E&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_file</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">E_values</span><span class="p">,</span> <span class="n">f_values</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$f(\mathcal</span><span class="si">{E}</span><span class="s1">)$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathcal</span><span class="si">{E}</span><span class="s1">$ (km$^2$/s$^2$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$f(\mathcal</span><span class="si">{E}</span><span class="s1">)$ ((km/s)$^{-3}$ kpc$^{-3}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Distribution Function $f(\mathcal</span><span class="si">{E}</span><span class="s1">)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
    
    <span class="c1"># Set log-log scale</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    
    <span class="n">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="plot_df_at_fixed_radius">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_df_at_fixed_radius">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_df_at_fixed_radius</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span> <span class="n">df_values</span><span class="p">,</span> <span class="n">r_fixed</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;df_fixed_radius.png&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the distribution function at a fixed radius.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v_values : array-like</span>
<span class="sd">        Velocity values</span>
<span class="sd">    df_values : array-like</span>
<span class="sd">        Distribution function values</span>
<span class="sd">    r_fixed : float or str</span>
<span class="sd">        The fixed radius value in kpc, or a string like &quot;2r_s&quot; for r_F = 2×scale_radius</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Path to save the output plot, by default &quot;df_fixed_radius.png&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved plot file</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Filters out any non-finite values before plotting.</span>
<span class="sd">    Creates a figure showing the distribution function at a specific</span>
<span class="sd">    fixed radius as a function of velocity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Only log warnings for critical issues</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">df_values</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;df_fixed_radius: All distribution function values are near zero&quot;</span><span class="p">)</span>
        <span class="c1"># Only if all values are exactly 0, set a small value to prevent empty plot</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">df_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">df_values</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span>

    <span class="c1"># Filter out non-finite values</span>
    <span class="n">v_values</span><span class="p">,</span> <span class="n">df_values</span> <span class="o">=</span> <span class="n">filter_finite_rows</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span> <span class="n">df_values</span><span class="p">)</span>

    <span class="c1"># Check if arrays are empty after filtering</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;df_fixed_radius: No valid data points after filtering&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Convert velocity from simulation units (kpc/Myr) to km/s</span>
    <span class="n">kmsec_to_kpcmyr</span> <span class="o">=</span> <span class="mf">1.02271e-3</span>
    <span class="n">v_values_kms</span> <span class="o">=</span> <span class="n">v_values</span> <span class="o">/</span> <span class="n">kmsec_to_kpcmyr</span>

    <span class="c1"># Calculate speed distribution P(v|r=r_F) by normalizing</span>
    <span class="c1"># Integrate over velocity to get normalization factor</span>
    <span class="c1"># Use trapezoidal rule for integration</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_values_kms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Sort by velocity for proper integration</span>
        <span class="n">sort_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">v_values_kms</span><span class="p">)</span>
        <span class="n">v_sorted</span> <span class="o">=</span> <span class="n">v_values_kms</span><span class="p">[</span><span class="n">sort_indices</span><span class="p">]</span>
        <span class="n">f_sorted</span> <span class="o">=</span> <span class="n">df_values</span><span class="p">[</span><span class="n">sort_indices</span><span class="p">]</span>
        
        <span class="c1"># Integrate using trapezoidal rule: ∫ f(v) dv</span>
        <span class="n">normalization</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">f_sorted</span><span class="p">,</span> <span class="n">v_sorted</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">normalization</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Normalize to get speed distribution P(v|r_F) with units km/s^(-1)</span>
            <span class="n">speed_dist</span> <span class="o">=</span> <span class="n">df_values</span> <span class="o">/</span> <span class="n">normalization</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback if normalization fails</span>
            <span class="n">speed_dist</span> <span class="o">=</span> <span class="n">df_values</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Normalization failed for speed distribution, using raw values&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">speed_dist</span> <span class="o">=</span> <span class="n">df_values</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Insufficient data points for normalization&quot;</span><span class="p">)</span>

    <span class="c1"># Use a simpler single-panel plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    
    <span class="c1"># Format the radius label based on whether it&#39;s numeric or string</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r_fixed</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">r_label</span> <span class="o">=</span> <span class="n">r_fixed</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;r_s&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;r_s&#39;</span><span class="p">)</span>  <span class="c1"># Format for LaTeX</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v_values_kms</span><span class="p">,</span> <span class="n">speed_dist</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$P(v|r_F = &#39;</span> <span class="o">+</span> <span class="n">r_label</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;)$&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Speed Distribution at Fixed Radius ($r_F = &#39;</span> <span class="o">+</span> <span class="n">r_label</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v_values_kms</span><span class="p">,</span> <span class="n">speed_dist</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$P(v|r_F = &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">r_fixed</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$ kpc)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Speed Distribution at Fixed Radius ($r_F = &#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">r_fixed</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$ kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$P(v|r_F)$ (km/s)$^{-1}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    
    <span class="n">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="plot_tangential_velocity_histogram">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_tangential_velocity_histogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_tangential_velocity_histogram</span><span class="p">(</span><span class="n">v_perp_data_initial</span><span class="p">,</span> <span class="n">v_perp_data_final</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;tangential_velocity_histogram_compare.png&quot;</span><span class="p">,</span> <span class="n">plot_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a comparison of initial and final tangential velocity distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v_perp_data_initial : array-like</span>
<span class="sd">        Array of initial tangential velocity magnitudes (km/s).</span>
<span class="sd">    v_perp_data_final : array-like</span>
<span class="sd">        Array of final tangential velocity magnitudes (km/s).</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Path to save the output plot.</span>
<span class="sd">    plot_range : tuple, optional</span>
<span class="sd">        Tuple (min, max) for the x-axis range of the histogram. Auto-ranged if None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved plot file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Or another appropriate number</span>

    <span class="c1"># Filter NaN/Inf values independently for initial and final, as they come from different processing steps</span>
    <span class="n">v_perp_data_initial</span> <span class="o">=</span> <span class="n">v_perp_data_initial</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">v_perp_data_initial</span><span class="p">)]</span>
    <span class="n">v_perp_data_final</span> <span class="o">=</span> <span class="n">v_perp_data_final</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">v_perp_data_final</span><span class="p">)]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_perp_data_initial</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_perp_data_final</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data for tangential velocity histogram. Skipping plot: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Determine common range if not specified, considering both datasets</span>
    <span class="k">if</span> <span class="n">plot_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">combined_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_perp_data_initial</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">combined_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">combined_data</span><span class="p">,</span> <span class="n">v_perp_data_initial</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_perp_data_final</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">combined_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">combined_data</span><span class="p">,</span> <span class="n">v_perp_data_final</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plot_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">combined_data</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">))</span> <span class="c1"># Start from 0, go to 99.5th percentile</span>
            <span class="k">if</span> <span class="n">plot_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">plot_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># Ensure max &gt; min</span>
                <span class="n">plot_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">plot_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">plot_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="c1"># Fallback range</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_perp_data_initial</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">v_perp_data_initial</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">plot_range</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Initial $v_{\perp}$&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_perp_data_final</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">v_perp_data_final</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">plot_range</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Final $v_{\perp}$&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v_{\perp}$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Comparison of Tangential Velocity Magnitude Distribution $N(v_{\perp})$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_perp_data_initial</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_perp_data_final</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Only add legend if there&#39;s data</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1"># Note: log_plot_saved will be called by the calling function (process_variable_histograms)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="plot_combined_histogram_from_file">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_combined_histogram_from_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_combined_histogram_from_file</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an overlay histogram comparing initial and final radial distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_file : str</span>
<span class="sd">        Path to the input data file containing combined histogram data</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Path to save the output plot</span>
<span class="sd">    config : Configuration, optional</span>
<span class="sd">        Configuration object containing plot settings. If provided,</span>
<span class="sd">        enables robust dynamic ranging for axes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved plot file</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The input file should contain three columns:</span>
<span class="sd">    - bin_centers: The center values of histogram bins</span>
<span class="sd">    - initial counts: Counts in each bin for the initial distribution</span>
<span class="sd">    - final counts: Counts in each bin for the final distribution</span>

<span class="sd">    The plot shows three categories using different colors:</span>
<span class="sd">    - Overlap between initial and final (purple)</span>
<span class="sd">    - Initial &gt; Final (blue)</span>
<span class="sd">    - Final &gt; Initial (red)</span>

<span class="sd">    This visualization helps identify which parts of the distribution</span>
<span class="sd">    remained stable and which parts changed during the simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">ncol_combined_histogram</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">bin_centers</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">hist_iradii</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">hist_fradii</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">hist_iradii</span><span class="p">,</span> <span class="n">hist_fradii</span><span class="p">)</span>
    <span class="n">initial_excess</span> <span class="o">=</span> <span class="n">hist_iradii</span> <span class="o">-</span> <span class="n">overlap</span>
    <span class="n">final_excess</span> <span class="o">=</span> <span class="n">hist_fradii</span> <span class="o">-</span> <span class="n">overlap</span>

    <span class="n">bin_width</span> <span class="o">=</span> <span class="n">bin_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bin_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mf">1.0</span>

    <span class="c1"># Calculate robust range for X-axis if config enables it</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;use_median_ranges&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">use_median_ranges</span><span class="p">:</span>
        <span class="c1"># Reconstruct radius distribution from histogram data</span>
        <span class="n">combined_counts</span> <span class="o">=</span> <span class="n">hist_iradii</span> <span class="o">+</span> <span class="n">hist_fradii</span>
        <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range_from_histogram</span><span class="p">(</span>
            <span class="n">bin_centers</span><span class="p">,</span> <span class="n">combined_counts</span><span class="p">,</span>
            <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile</span><span class="p">,</span>
            <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile_multiplier</span><span class="p">,</span>
            <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_x_range_abs</span><span class="p">,</span>
            <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">),</span>
            <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;combined radial histogram&quot;</span>
        <span class="p">)</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Auto-range</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">overlap</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Overlap&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">initial_excess</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial &gt; Final&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">,</span> <span class="n">final_excess</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Final &gt; Initial&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$N(r)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Comparison of Initial and Final Radial Distributions $N(r)$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    
    <span class="c1"># Apply robust ranging if calculated</span>
    <span class="k">if</span> <span class="n">x_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    
    <span class="n">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="plot_trajectories">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_trajectories">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_trajectories</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot particle trajectories (radius vs time) for multiple particles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_file : str</span>
<span class="sd">        Path to the input data file containing trajectory data.</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Path to save the output plot.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved plot file</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The input file should contain column groups with time and radial position</span>
<span class="sd">    for multiple particles over the simulation period.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">input_file</span><span class="p">,</span> <span class="n">ncol_trajectories</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nparticles</span> <span class="o">=</span> <span class="p">(</span><span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparticles</span><span class="p">):</span>
        <span class="n">r_col</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">p</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">r_col</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t$ (Myr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r(t)$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Particle Trajectories&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    
    <span class="n">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="plot_single_trajectory">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_single_trajectory">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_single_trajectory</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the orbital trajectory (radius vs time) for a single test particle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_file : str</span>
<span class="sd">        Path to the input data file containing trajectory data.</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Path to save the output plot.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved plot file</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The input file should contain columns with time and radial position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">input_file</span><span class="p">,</span> <span class="n">ncol_single_trajectory</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t$ (Myr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r(t)$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Single Particle Trajectory&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    
    <span class="n">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="plot_energy_time">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_energy_time">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_energy_time</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot energy vs. time for multiple particles, illustrating integration stability.</span>
<span class="sd">    NOTE: &#39;Current&#39; energy uses the initial static potential for evaluation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_file : str</span>
<span class="sd">        Path to the input data file containing energy data.</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Path to save the output plot.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved plot file</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The input file should contain time in the first column, followed by repeated groups</span>
<span class="sd">    of energy values (current energy evaluated with static potential, initial energy)</span>
<span class="sd">    for each particle. Loads full data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Load full data using the binary safe loader</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">input_file</span><span class="p">,</span> <span class="n">ncol_energy_and_angular_momentum_vs_time</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Log warning if data loading failed</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load or filter data from </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2"> for energy plot.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nparticles</span> <span class="o">=</span> <span class="p">(</span><span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span> <span class="c1"># Calculate number of particles based on columns</span>

    <span class="c1"># Check if there are enough columns for at least one particle</span>
    <span class="k">if</span> <span class="n">nparticles</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No particle data found in </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2"> after calculating columns.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="c1"># Get axis handle</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparticles</span><span class="p">):</span>
        <span class="n">E_col</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">p</span>   <span class="c1"># Column index for current energy (using static Psi)</span>
        <span class="n">E_i_col</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">p</span> <span class="c1"># Column index for initial energy</span>

        <span class="c1"># Ensure column indices are valid</span>
        <span class="k">if</span> <span class="n">E_i_col</span> <span class="o">&gt;=</span> <span class="n">ncols</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column index </span><span class="si">{</span><span class="n">E_i_col</span><span class="si">}</span><span class="s2"> out of bounds for particle </span><span class="si">{</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">continue</span> <span class="c1"># Skip this particle if indices are invalid</span>

        <span class="c1"># Plot current energy (using static Psi) and initial energy</span>
        <span class="c1"># Updated label to clarify E(t) uses static potential</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">E_col</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;$\mathcal</span><span class="se">{{</span><span class="s1">E</span><span class="se">}}</span><span class="s1">(t)$ (Static $\Psi_0$) P</span><span class="si">{</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">E_i_col</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;$\mathcal</span><span class="se">{{</span><span class="s1">E</span><span class="se">}}</span><span class="s1">_0$ P</span><span class="si">{</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Use LaTeX for axis labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t$ (Myr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathcal</span><span class="si">{E}</span><span class="s1">$ (km$^2$/s$^2$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Integration Stability: Energy Conservation Test&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1"># Add legend, adjust size and location as needed</span>
    <span class="c1"># Reduced font size slightly to avoid potential overlap with text box</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

    <span class="c1"># Add explanatory text</span>
    <span class="n">explanation</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;Tests numerical integration stability.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Solid: Energy evaluated at current state (r, v, L) using the *initial static potential*.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Dashed: Initial energy.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Note: This is not true energy conservation if the potential evolves over time.&quot;</span>
    <span class="p">)</span>
    <span class="c1"># Place text box in bottom left, slightly offset from axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">explanation</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.3&#39;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;aliceblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">))</span>

    <span class="c1"># Adjust layout slightly to prevent xlabel overlap with the text box</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="c1"># Added bottom margin (rect=[left, bottom, right, top])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> <span class="c1"># Close the specific figure</span>

    
    <span class="n">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="plot_angular_momentum_time">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_angular_momentum_time">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_angular_momentum_time</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot angular momentum vs. time for multiple particles, showing both current and initial values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_file : str</span>
<span class="sd">        Path to the input data file containing angular momentum data.</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Path to save the output plot.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Path to the saved plot file</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The input file should contain time in the first column, followed by repeated groups</span>
<span class="sd">    of values (current energy, initial energy, current angular momentum, initial angular momentum)</span>
<span class="sd">    for each particle.</span>
<span class="sd">    Loads full data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">input_file</span><span class="p">,</span> <span class="n">ncol_energy_and_angular_momentum_vs_time</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nparticles</span> <span class="o">=</span> <span class="p">(</span><span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nparticles</span><span class="p">):</span>
        <span class="n">L_col</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">p</span>
        <span class="n">L_i_col</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">p</span>
        <span class="c1"># Use LaTeX in legend (using \ell)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">L_col</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;$\ell(t)$ P</span><span class="si">{</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">L_i_col</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;$\ell_i$ P</span><span class="si">{</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Use LaTeX for axis labels</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t$ (Myr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$ (kpc$\cdot$km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Angular Momentum Conservation $\ell(t)$ vs $\ell_i$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    
    <span class="n">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="plot_lowestL_trajectories_3panel">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_lowestL_trajectories_3panel">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_lowestL_trajectories_3panel</span><span class="p">(</span><span class="n">input_file</span><span class="o">=</span><span class="s2">&quot;lowest_l_trajectories.dat&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;lowestl_3panel.png&quot;</span><span class="p">,</span> <span class="n">file_prefix</span><span class="o">=</span><span class="s2">&quot;lowestl&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a 3-panel plot showing trajectories of selected particles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_file : str, optional</span>
<span class="sd">        Path to the input data file containing trajectory data.</span>
<span class="sd">        Default is &quot;lowest_l_trajectories.dat&quot;.</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Path to save the output plot. Default is &quot;lowestl_3panel.png&quot;.</span>
<span class="sd">    file_prefix : str, optional</span>
<span class="sd">        Prefix to use for labeling (&quot;lowestl&quot; or &quot;chosenl&quot;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The input file should have columns in the format:</span>
<span class="sd">    time  r1  E1  L1   r2  E2  L2   ...   rN  EN  LN</span>

<span class="sd">    The function creates a 3-panel plot showing:</span>
<span class="sd">    1) Radii vs. time for each particle</span>
<span class="sd">    2) Energies vs. time for each particle</span>
<span class="sd">    3) Percentage deviation from average energy vs. time for each particle</span>

<span class="sd">    Label changes based on file type:</span>
<span class="sd">    - &quot;Lowest&quot; for lowest_l files</span>
<span class="sd">    - &quot;Chosen&quot; for chosen_l files</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Load the data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">input_file</span><span class="p">,</span> <span class="n">ncol_lowest_l_trajectories</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Filter out rows with NaN/Inf</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1"># time = first column</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># each lowest-L particle contributes 3 columns: (r, E, L)</span>
    <span class="c1"># so number of lowest-L particles = (ncols - 1)//3</span>
    <span class="n">nlowest</span> <span class="o">=</span> <span class="p">(</span><span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span>

    <span class="c1"># Prepare the figure with 3 side-by-side subplots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax_r</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax_e</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ax_dev</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Determine label text based on file prefix</span>
    <span class="n">label_descriptor</span> <span class="o">=</span> <span class="s2">&quot;Chosen&quot;</span> <span class="k">if</span> <span class="n">file_prefix</span> <span class="o">==</span> <span class="s2">&quot;chosenl&quot;</span> <span class="k">else</span> <span class="s2">&quot;Lowest&quot;</span>

    <span class="c1"># Extract initial L values from first timestep for legend</span>
    <span class="n">initial_L_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlowest</span><span class="p">):</span>
        <span class="n">L_col</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">p</span>  <span class="c1"># L is the third of each triplet</span>
        <span class="n">initial_L</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">L_col</span><span class="p">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="n">initial_L_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">initial_L</span><span class="p">)</span>

    <span class="c1"># 1) Radii vs. time</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlowest</span><span class="p">):</span>
        <span class="n">r_col</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">p</span>  <span class="c1"># r is the first of each triplet</span>
        <span class="n">ax_r</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">r_col</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;P</span><span class="si">{</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ($</span><span class="se">\\</span><span class="s2">ell_0$=</span><span class="si">{</span><span class="n">initial_L_values</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$t$ (Myr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ (kpc)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;Radius vs. Time (</span><span class="si">{</span><span class="n">label_descriptor</span><span class="si">}</span><span class="s2"> $\ell$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 2) Energies vs. time</span>
    <span class="c1">#   second of each triplet is the energy</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlowest</span><span class="p">):</span>
        <span class="n">e_col</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">p</span>
        <span class="n">ax_e</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">e_col</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;P</span><span class="si">{</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ($</span><span class="se">\\</span><span class="s2">ell_0$=</span><span class="si">{</span><span class="n">initial_L_values</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$t$ (Myr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathcal</span><span class="si">{E}</span><span class="s2">$ (km$^2$/s$^2$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;Energy vs. Time (</span><span class="si">{</span><span class="n">label_descriptor</span><span class="si">}</span><span class="s2"> $\ell$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 3) % deviation from average energy</span>
    <span class="c1">#   We&#39;ll build an array (nsteps x nlowest) of energies</span>
    <span class="n">nsteps</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsteps</span><span class="p">,</span> <span class="n">nlowest</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlowest</span><span class="p">):</span>
        <span class="n">e_col</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">p</span>
        <span class="n">energies</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">e_col</span><span class="p">]</span>
        <span class="c1"># compute each particle&#39;s time-averaged energy</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlowest</span><span class="p">):</span>
        <span class="c1"># average of that particle&#39;s energy over time</span>
        <span class="n">single_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">energies</span><span class="p">[:,</span> <span class="n">p</span><span class="p">])</span>
        <span class="n">pct_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">energies</span><span class="p">[:,</span> <span class="n">p</span><span class="p">]</span> <span class="o">-</span> <span class="n">single_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">single_mean</span> <span class="o">*</span> <span class="mf">100.0</span>
        <span class="n">ax_dev</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">pct_dev</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;P</span><span class="si">{</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> ($</span><span class="se">\\</span><span class="s2">ell_0$=</span><span class="si">{</span><span class="n">initial_L_values</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">ax_dev</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$t$ (Myr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_dev</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta\mathcal</span><span class="si">{E}</span><span class="s2">/\langle\mathcal</span><span class="si">{E}</span><span class="s2">\rangle$ (%)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_dev</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;Energy Deviation (</span><span class="si">{</span><span class="n">label_descriptor</span><span class="si">}</span><span class="s2"> $\ell$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax_dev</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">ax_dev</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Save &amp; close figure</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_debug_energy_compare">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_debug_energy_compare">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_debug_energy_compare</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;results/energy_compare.png&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create multi-panel diagnostic plot comparing energy calculation methods.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_file : str</span>
<span class="sd">        Path to the input data file containing energy comparison data.</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Path to save the output plot. Default is &quot;results/energy_compare.png&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Input file should have 8 columns:</span>
<span class="sd">    </span>
<span class="sd">    - 0: snapIdx - Snapshot index</span>
<span class="sd">    - 1: time(Myr) - Time in megayears</span>
<span class="sd">    - 2: radius(kpc) - Radius in kiloparsecs</span>
<span class="sd">    - 3: approxE - Approximated energy</span>
<span class="sd">    - 4: dynE - Dynamically calculated energy</span>
<span class="sd">    - 5: (dynE - approxE) - Difference between calculation methods</span>
<span class="sd">    - 6: KE - Kinetic Energy</span>
<span class="sd">    - 7: PE - Potential Energy</span>

<span class="sd">    Creates a 5-panel figure in a 2x3 layout:</span>
<span class="sd">    </span>
<span class="sd">    - Top row (3 panels):</span>
<span class="sd">      [0,0]: Radius vs. time</span>
<span class="sd">      [0,1]: Dynamic energy vs. time</span>
<span class="sd">      [0,2]: Energy deviation from mean (%) vs. time</span>
<span class="sd">    - Bottom row (2 panels + 1 blank):</span>
<span class="sd">      [1,0]: Kinetic energy vs. time</span>
<span class="sd">      [1,1]: Potential energy vs. time</span>
<span class="sd">      [1,2]: (empty placeholder)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">input_file</span><span class="p">,</span> <span class="n">ncol_debug_energy_compare</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2"> not found or no valid data. Skipping energy-compare plot.&quot;</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c1"># Filter out any invalid (NaN/Inf) rows</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: After filtering, </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2"> had no valid rows. Skipping.&quot;</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c1"># Extract data columns from the energy comparison file</span>
    <span class="n">snap_idx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>   <span class="c1"># Snapshot index</span>
    <span class="n">time_myr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>   <span class="c1"># Time in megayears</span>
    <span class="n">radius_kpc</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="c1"># Radius in kiloparsecs</span>
    <span class="n">approx_e</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>   <span class="c1"># Approximated energy</span>
    <span class="n">dyn_e</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>      <span class="c1"># Dynamically calculated energy</span>
    <span class="n">diff_e</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>     <span class="c1"># Difference between methods (dynE - approxE)</span>
    <span class="n">ke_vals</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span>    <span class="c1"># Kinetic energy</span>
    <span class="n">pe_vals</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span>    <span class="c1"># Potential energy</span>

    <span class="c1"># Create a 2-row by 3-column figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="c1"># Top row subplots</span>
    <span class="n">ax_r</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># radius vs time</span>
    <span class="n">ax_e</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># dynE vs time</span>
    <span class="n">ax_diff</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># energy deviation from mean</span>

    <span class="c1"># Bottom row subplots</span>
    <span class="n">ax_ke</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># KE vs time</span>
    <span class="n">ax_pe</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># PE vs time</span>
    <span class="c1"># The last panel [1,2] we turn off or leave blank</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="c1"># 1) Radius vs Time</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_myr</span><span class="p">,</span> <span class="n">radius_kpc</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$r$&quot;</span><span class="p">)</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$t$ (Myr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ (kpc)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Radius vs. Time&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax_r</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># 2) dynE vs. Time (Using \mathcal{E}) - negated</span>
    <span class="c1"># Plot the negated energy values first to get auto-scaling</span>
    <span class="n">neg_dyn_e</span> <span class="o">=</span> <span class="o">-</span><span class="n">dyn_e</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_myr</span><span class="p">,</span> <span class="n">neg_dyn_e</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$-\mathcal</span><span class="si">{E}</span><span class="s2">_{\rm dyn}$&quot;</span><span class="p">)</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$t$ (Myr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$-\mathcal</span><span class="si">{E}</span><span class="s2">$ (km$^2$/s$^2$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Energy vs. Time ($-\mathcal</span><span class="si">{E}</span><span class="s2">_{\rm dyn}$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    
    <span class="c1"># Get the auto-scaled range after plotting</span>
    <span class="n">epsilon_range_min</span><span class="p">,</span> <span class="n">epsilon_range_max</span> <span class="o">=</span> <span class="n">ax_e</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    
    <span class="c1"># Calculate appropriate variation scale based on potential energy variation</span>
    <span class="n">psi_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pe_vals</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pe_vals</span><span class="p">))</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">psi_range</span> <span class="o">/</span> <span class="mf">3.0</span>  <span class="c1"># Characteristic energy variation scale</span>
    <span class="n">neg_mean_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">neg_dyn_e</span><span class="p">)</span>  <span class="c1"># Mean of negated energy</span>
    
    <span class="c1"># Calculate new limits that preserve both the auto-scaled range and our calculated range</span>
    <span class="n">new_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">epsilon_range_min</span><span class="p">,</span> <span class="n">neg_mean_e</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">delta</span><span class="p">)</span>
    <span class="n">new_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">epsilon_range_max</span><span class="p">,</span> <span class="n">neg_mean_e</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">delta</span><span class="p">)</span>
    
    <span class="c1"># Set the expanded y-axis limits</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">new_min</span><span class="p">,</span> <span class="n">new_max</span><span class="p">)</span>
    
    <span class="n">ax_e</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax_e</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># 3) Energy deviation from mean (Using \mathcal{E})</span>
    <span class="c1"># Calculate average deviation from time average</span>
    <span class="n">mean_dyn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dyn_e</span><span class="p">)</span>

    <span class="c1"># Prevent division by zero by using a minimal denominator value</span>
    <span class="n">eps_d</span> <span class="o">=</span> <span class="n">mean_dyn</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mean_dyn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-30</span> <span class="k">else</span> <span class="mf">1e-30</span>

    <span class="n">dev_dyn_pct</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">dyn_e</span> <span class="o">-</span> <span class="n">mean_dyn</span><span class="p">)</span> <span class="o">/</span> <span class="n">eps_d</span>

    <span class="c1"># Plot shows the deviation percentage without negation</span>
    <span class="c1"># as this represents relative change which is independent of sign</span>
    <span class="n">ax_diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_myr</span><span class="p">,</span> <span class="n">dev_dyn_pct</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span>
                 <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$(\mathcal</span><span class="si">{E}</span><span class="s2">_{\rm dyn} - \langle\mathcal</span><span class="si">{E}</span><span class="s2">_{\rm dyn}\rangle)/\langle\mathcal</span><span class="si">{E}</span><span class="s2">_{\rm dyn}\rangle$ (%)&quot;</span><span class="p">)</span>
    <span class="n">ax_diff</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$t$ (Myr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_diff</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta\mathcal</span><span class="si">{E}</span><span class="s2">/\langle\mathcal</span><span class="si">{E}</span><span class="s2">\rangle$ (%)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_diff</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Energy Deviation from Mean&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax_diff</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax_diff</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># 4) Kinetic Energy vs. Time</span>
    <span class="n">ax_ke</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_myr</span><span class="p">,</span> <span class="n">ke_vals</span><span class="p">,</span> <span class="s1">&#39;c-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$K$&quot;</span><span class="p">)</span>
    <span class="n">ax_ke</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$t$ (Myr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_ke</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$K$ (km$^2$/s$^2$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_ke</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Kinetic Energy vs. Time&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax_ke</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax_ke</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># 5) Potential Energy vs. Time (negated)</span>
    <span class="n">ax_pe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_myr</span><span class="p">,</span> <span class="o">-</span><span class="n">pe_vals</span><span class="p">,</span> <span class="s1">&#39;y-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$-\Psi$&quot;</span><span class="p">)</span>
    <span class="n">ax_pe</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$t$ (Myr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_pe</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$-\Psi$ (km$^2$/s$^2$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax_pe</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Potential Energy vs. Time&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax_pe</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax_pe</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="c1"># Log to file only, console output handled by progress tracker</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="c1"># The calling function should use update_combined_progress instead</span>
    <span class="c1"># of this function directly updating the progress bar</span>

<div class="viewcode-block" id="Configuration">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.Configuration">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Configuration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configuration class that encapsulates all parameters and settings for the nsphere_plot.py script.</span>
<span class="sd">    This reduces the reliance on global variables and improves code maintainability and testability.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Configuration.__init__">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.Configuration.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the configuration with command line arguments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        args : argparse.Namespace, optional</span>
<span class="sd">            The parsed command line arguments.</span>
<span class="sd">            If None, arguments will be parsed from sys.argv.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Command line arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_arguments</span><span class="p">()</span>

        <span class="c1"># Set parameters from arguments, with validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_parameters</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse command line arguments for configuring the visualization options.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        argparse.Namespace</span>
<span class="sd">            The parsed command line arguments with visualization settings.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method creates an ArgumentParser with options for controlling which</span>
<span class="sd">        visualizations to generate and sets appropriate defaults based on lastparams.dat.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Note: showing_help flag is already set at the beginning of the script</span>

        <span class="c1"># Parse command line arguments</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Generate plots and animations from simulation data.&#39;</span><span class="p">,</span>
            <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span>
        <span class="p">)</span>

        <span class="c1"># Get default suffix from lastparams.dat</span>
        <span class="n">default_suffix</span> <span class="o">=</span> <span class="n">read_lastparams</span><span class="p">(</span><span class="n">return_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--suffix&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_suffix</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Suffix for data files (e.g., _adp.leap.adp.levi_30000_1001_5)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--start&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Starting snapshot number&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--end&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ending snapshot number (0 means use all available)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--step&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Step size between snapshots&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--fps&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Frames per second in the output animations&#39;</span><span class="p">)</span>
        <span class="c1"># Flags for only generating specific visualization groups</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--phase-space&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When used, ONLY generate phase space plots and animations&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--phase-comparison&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When used, ONLY generate initial vs. final phase space comparison&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--profile-plots&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When used, ONLY generate profile plots (density, mass, psi, etc.)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--trajectory-plots&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When used, ONLY generate trajectory and diagnostic plots&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--2d-histograms&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When used, ONLY generate 2D histograms&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--convergence-tests&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When used, ONLY generate convergence test plots&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--animations&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When used, ONLY generate animations&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--energy-plots&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When used, ONLY generate energy plots&#39;</span><span class="p">)</span>

        <span class="c1"># Flags for skipping specific visualization groups</span>
        <span class="c1"># Flag for generating 1D variable distributions</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--distributions&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When used, ONLY generate 1D variable distributions (Initial vs Final)&#39;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-phase-space&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip phase space plots and animations&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-phase-comparison&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip initial vs. final phase space comparison&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-profile-plots&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip profile plots (density, mass, psi, etc.)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-trajectory-plots&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip trajectory and diagnostic plots&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-histograms&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip 2D histograms&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-convergence-tests&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip convergence test plots&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-animations&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip animations&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-energy-plots&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip energy plots&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-distributions&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Skip 1D variable distributions (Initial vs Final)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--log&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable detailed logging to file (default: only errors and warnings)&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--paced&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Paced mode: enable delays between sections (default: fast mode with no delays)&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure parameters based on command line arguments and validate settings.</span>

<span class="sd">        This method initializes the following configuration properties:</span>
<span class="sd">        - suffix: File suffix for identifying data files</span>
<span class="sd">        - fps: Frames per second for animations</span>
<span class="sd">        - duration: Frame duration in milliseconds</span>
<span class="sd">        - start_snap, end_snap, step_snap: Snapshot filtering parameters</span>

<span class="sd">        It also handles global flags like enable_logging and paced_mode, and extracts</span>
<span class="sd">        additional parameters from the suffix (npts, Ntimes, tfinal_factor, file_tag).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">showing_help</span><span class="p">,</span> <span class="n">enable_logging</span>

        <span class="c1"># Set the suffix for data files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">suffix</span>

        <span class="c1"># Calculate frame duration from fps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">fps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fps</span>

        <span class="c1"># Set the start, end, and step parameters for filtering Rank files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_snap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">step</span>

        <span class="c1"># Handle logging flags (--log)</span>
        <span class="k">global</span> <span class="n">enable_logging</span><span class="p">,</span> <span class="n">paced_mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">enable_logging</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Handle paced mode flag (--paced)</span>
        <span class="k">global</span> <span class="n">section_delay</span><span class="p">,</span> <span class="n">progress_delay</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">paced</span><span class="p">:</span>
            <span class="n">paced_mode</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">section_delay</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># Delay between different sections in seconds when paced mode is enabled</span>
            <span class="n">progress_delay</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Delay between progress bars in seconds when paced mode is enabled</span>

        <span class="c1"># Parameter display is centralized in the main function banner</span>

        <span class="c1"># Configure percentile-based robust ranging system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_median_ranges</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Enable by default (now uses percentiles)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_percentile</span> <span class="o">=</span> <span class="mf">95.0</span>        <span class="c1"># Use 95th percentile for X-axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_percentile</span> <span class="o">=</span> <span class="mf">95.0</span>        <span class="c1"># Use 95th percentile for Y-axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_percentile_multiplier</span> <span class="o">=</span> <span class="mf">1.2</span>  <span class="c1"># Multiplier for percentile value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_percentile_multiplier</span> <span class="o">=</span> <span class="mf">1.65</span>  <span class="c1"># Multiplier for percentile value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_x_range_abs</span> <span class="o">=</span> <span class="mf">10.0</span>     <span class="c1"># Minimum radius range extent (kpc)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_y_range_abs</span> <span class="o">=</span> <span class="mf">20.0</span>     <span class="c1"># Minimum velocity range extent (km/s)</span>

        <span class="c1"># Extract parameters from suffix for compatibility with existing code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_params_from_suffix</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_params_from_suffix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the suffix string to extract simulation parameters.</span>

<span class="sd">        This method parses the suffix pattern &quot;_[file_tag]_npts_Ntimes_tfinal_factor&quot;</span>
<span class="sd">        to extract the following parameters:</span>
<span class="sd">        - npts: Number of particles in the simulation</span>
<span class="sd">        - Ntimes: Number of time steps in the simulation</span>
<span class="sd">        - tfinal_factor: Final time factor of the simulation</span>
<span class="sd">        - file_tag: Optional tag identifying the simulation run</span>

<span class="sd">        If parsing fails, it falls back to reading from lastparams.dat.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        These parameters are used throughout the code for file paths,</span>
<span class="sd">        plot labels, and determining output filenames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First, try to read parameters from the corresponding lastparams file</span>
        <span class="c1"># This is the most reliable source of truth for the parameters.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ntimes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfinal_factor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_tag</span> <span class="o">=</span> <span class="n">read_lastparams</span><span class="p">(</span>
                <span class="n">user_suffix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">return_suffix</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="c1"># Reconstruct the suffix from the authoritative source to ensure consistency</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_tag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tag</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Ntimes</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tfinal_factor</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Ntimes</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tfinal_factor</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded parameters for suffix &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&#39; from its lastparams file.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
            <span class="c1"># Fallback to parsing the suffix string itself if lastparams&lt;suffix&gt;.dat doesn&#39;t exist</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find lastparams file for suffix &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&#39;. Falling back to parsing suffix string.&quot;</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># Format: _tag_npts_ntimes_tfinal</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file_tag</span><span class="p">,</span> <span class="n">npts_str</span><span class="p">,</span> <span class="n">ntimes_str</span><span class="p">,</span> <span class="n">tfinal_str</span> <span class="o">=</span> <span class="n">parts</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># Format: _npts_ntimes_tfinal</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file_tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">npts_str</span><span class="p">,</span> <span class="n">ntimes_str</span><span class="p">,</span> <span class="n">tfinal_str</span> <span class="o">=</span> <span class="n">parts</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Suffix does not match expected format.&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">npts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npts_str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Ntimes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ntimes_str</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tfinal_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tfinal_str</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsed parameters from suffix string: npts=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">npts</span><span class="si">}</span><span class="s2">, tag=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tag</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Suffix &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&#39; is malformed and its lastparams file was not found.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Configuration.setup_file_paths">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.Configuration.setup_file_paths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_file_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a dictionary mapping file types to their full file paths.</span>
<span class="sd">        All filenames now correctly include the suffix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;particles&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/particles</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;particlesfinal&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/particlesfinal</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;integrand&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/integrand</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;density_profile&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/density_profile</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;massprofile&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/massprofile</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;psiprofile&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/Psiprofile</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dpsi_dr&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/dpsi_dr</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;drho_dpsi&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/drho_dpsi</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;f_of_E&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/f_of_E</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;df_fixed_radius&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/df_fixed_radius</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;combined_histogram&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/combined_histogram</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trajectories&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/trajectories</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;single_trajectory&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/single_trajectory</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;energy_and_angular_momentum&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/energy_and_angular_momentum_vs_time</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hist_init&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/2d_hist_initial</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hist_final&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/2d_hist_final</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lowest_l_trajectories&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/lowest_l_trajectories</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;debug_energy_compare&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/debug_energy_compare</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total_energy_vs_time&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/total_energy_vs_time</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lowest_radius_ids&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;data/lowest_radius_ids</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span> <span class="c1"># Added for energy plots</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Configuration.only_specific_visualizations">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.Configuration.only_specific_visualizations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">only_specific_visualizations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the user requested specific visualization types only.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if any &quot;only&quot; flag is specified (e.g., --phase-space, --profile-plots),</span>
<span class="sd">            False if running in normal mode where all visualizations are generated.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        When &quot;only&quot; flags are active, the script will generate only those specific</span>
<span class="sd">        visualization types and skip all others, regardless of --no-* flags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">phase_space</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">phase_comparison</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">profile_plots</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">trajectory_plots</span> <span class="ow">or</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;2d_histograms&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">convergence_tests</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">animations</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">energy_plots</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">distributions</span><span class="p">)</span></div>


<div class="viewcode-block" id="Configuration.need_to_process_rank_files">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.Configuration.need_to_process_rank_files">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">need_to_process_rank_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the visualization plan requires processing rank data files.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if rank files need to be processed for animations or energy plots,</span>
<span class="sd">            False if they can be skipped based on user-selected visualization options.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Rank files are needed for animations and energy plots. This method checks</span>
<span class="sd">        if either of these visualization types are specifically requested (via &quot;only&quot; flags)</span>
<span class="sd">        or if they haven&#39;t been explicitly excluded (via &quot;no-&quot; flags) in normal mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">only_flags_active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_specific_visualizations</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">animations</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">energy_plots</span> <span class="ow">or</span>
                <span class="p">(</span><span class="ow">not</span> <span class="n">only_flags_active</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_animations</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_energy_plots</span><span class="p">)))</span></div>
</div>


<div class="viewcode-block" id="plot_total_energy_diagnostics">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_total_energy_diagnostics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_total_energy_diagnostics</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;results/total_energy_diagnostics.png&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a three-panel diagnostic plot for total system energy conservation.</span>
<span class="sd">    </span>
<span class="sd">    Panel 1: Absolute values of KE, PE, and Total Energy vs time</span>
<span class="sd">    Panel 2: Percent change from initial values for all three quantities (auto-scaled)</span>
<span class="sd">    Panel 3: Percent change of total energy only (zoomed in for detail)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_file : str</span>
<span class="sd">        Path to the total_energy_vs_time binary file from nsphere</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Path to save the output plot (PNG format)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or None</span>
<span class="sd">        Path to the saved plot file, or None if plotting failed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total energy file </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Read the binary file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        
        <span class="c1"># The file is pure binary - fprintf_bin ignores the header string</span>
        <span class="c1"># because it has no format specifiers (%f, %g, etc.)</span>
        <span class="c1"># Data starts at byte 0: 5 floats per row (time, KE, PE, total_E, frac_change)</span>
        
        <span class="c1"># Parse binary data</span>
        <span class="n">num_floats</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">num_floats</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data size mismatch in </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">num_floats</span><span class="si">}</span><span class="s2"> floats, expected multiple of 5&quot;</span><span class="p">)</span>
            <span class="c1"># Try to proceed with what we have</span>
            <span class="n">num_floats</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_floats</span> <span class="o">//</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
        
        <span class="n">values</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_floats</span><span class="si">}</span><span class="s1">f&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="n">num_floats</span><span class="o">*</span><span class="mi">4</span><span class="p">])</span>
        
        <span class="c1"># Reshape into rows</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="n">num_floats</span> <span class="o">//</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">nrows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data rows in </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Extract columns</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">)])</span>
        <span class="n">total_ke</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">5</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">)])</span>
        <span class="n">total_pe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">5</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">)])</span>
        <span class="n">total_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">5</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">)])</span>
        
        <span class="c1"># Calculate mean values for percent change calculation</span>
        <span class="n">ke_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">total_ke</span><span class="p">)</span>
        <span class="n">pe_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">total_pe</span><span class="p">)</span>
        <span class="n">e_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">total_e</span><span class="p">)</span>
        
        <span class="c1"># Calculate percent changes from mean</span>
        <span class="n">ke_percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">total_ke</span> <span class="o">-</span> <span class="n">ke_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ke_mean</span><span class="p">)</span> <span class="k">if</span> <span class="n">ke_mean</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">total_ke</span><span class="p">)</span>
        <span class="n">pe_percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">total_pe</span> <span class="o">-</span> <span class="n">pe_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pe_mean</span><span class="p">)</span> <span class="k">if</span> <span class="n">pe_mean</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">total_pe</span><span class="p">)</span>
        <span class="n">e_percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">total_e</span> <span class="o">-</span> <span class="n">e_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e_mean</span><span class="p">)</span> <span class="k">if</span> <span class="n">e_mean</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">total_e</span><span class="p">)</span>
        
        <span class="c1"># Create the three-panel figure</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        
        <span class="c1"># Panel 1: True energy values (not absolute)</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">total_ke</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Kinetic Energy&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">total_pe</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Potential Energy&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">total_e</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total Energy&#39;</span><span class="p">)</span>
        
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (Myr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Energy (code units)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;System Energy Evolution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># Panel 2: Percent change of all quantities from mean (auto-scaled)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">ke_percent</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;KE </span><span class="si">% f</span><span class="s1">rom mean&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">pe_percent</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PE </span><span class="si">% f</span><span class="s1">rom mean&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">e_percent</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total E </span><span class="si">% f</span><span class="s1">rom mean&#39;</span><span class="p">)</span>
        
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (Myr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;% Change from Mean&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Relative Energy Changes from Mean&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="c1"># Panel 3: Total energy percent change from mean (zoomed)</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">e_percent</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total Energy </span><span class="si">% f</span><span class="s1">rom mean&#39;</span><span class="p">)</span>
        
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (Myr)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;% Change in Total Energy from Mean&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total Energy Conservation Detail&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        
        <span class="c1"># Set y-axis limits for better visibility</span>
        <span class="n">max_e_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e_percent</span><span class="p">))</span>
        <span class="n">y_margin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">max_e_var</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">)</span>  <span class="c1"># At least 0.001% margin</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">y_margin</span><span class="p">,</span> <span class="n">y_margin</span><span class="p">)</span>
        
        <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        
        <span class="c1"># Overall figure adjustments</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Total System Energy Diagnostics&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.995</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">])</span>
        
        <span class="c1"># Save the plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total energy diagnostics plot saved to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_file</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating total energy diagnostics plot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="parse_arguments">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.parse_arguments">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_arguments</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse command line arguments for the nsphere_plot.py script.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    argparse.Namespace</span>
<span class="sd">        The parsed arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span></div>


<div class="viewcode-block" id="setup_global_parameters">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.setup_global_parameters">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_global_parameters</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup global parameters based on command line arguments.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : argparse.Namespace</span>
<span class="sd">        The parsed command line arguments.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        The calculated parameters (suffix, start_snap, end_snap, step_snap, duration).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">start_snap</span><span class="p">,</span> <span class="n">end_snap</span><span class="p">,</span> <span class="n">step_snap</span><span class="p">,</span> <span class="n">duration</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">suffix</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">suffix</span>
    <span class="n">start_snap</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">start_snap</span>
    <span class="n">end_snap</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">end_snap</span>
    <span class="n">step_snap</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">step_snap</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">duration</span>

    <span class="k">return</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">start_snap</span><span class="p">,</span> <span class="n">end_snap</span><span class="p">,</span> <span class="n">step_snap</span><span class="p">,</span> <span class="n">duration</span></div>


<div class="viewcode-block" id="setup_file_paths">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.setup_file_paths">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_file_paths</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup file paths for all data files using the given suffix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        The suffix to use for all file names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary containing all file paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">()</span>
    <span class="n">temp_config</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span>

    <span class="k">return</span> <span class="n">temp_config</span><span class="o">.</span><span class="n">setup_file_paths</span><span class="p">()</span></div>


<div class="viewcode-block" id="process_profile_plots">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_profile_plots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_profile_plots</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process various profile data files and generate plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_paths : dict</span>
<span class="sd">        Dictionary of file paths for various data files.</span>
<span class="sd">    config : Configuration, optional</span>
<span class="sd">        Configuration object containing plot settings. If provided,</span>
<span class="sd">        enables robust dynamic ranging for plots.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">suffix</span>

    <span class="c1"># Create the results directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Calculate total number of data files to load (for progress tracking)</span>
    <span class="c1"># Potential data files to load: density, mass, psi, dpsi, drho, f_of_E, df_fixed, combined</span>
    <span class="n">total_data_files</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="c1"># Start progress tracking for data loading</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;profile_data_loading&quot;</span><span class="p">,</span> <span class="n">total_data_files</span><span class="p">)</span>

    <span class="c1"># Track plots to be generated</span>
    <span class="n">plots_to_generate</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># First, prepare all the data that needs to be plotted</span>
    <span class="n">prepared_plots</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Plot density profile (now using rho, not 4*pi*r^2*rho)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading density profile data from </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;density_profile&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;profile_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_density_profile&quot;</span><span class="p">)</span>
    <span class="n">dens_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;density_profile&quot;</span><span class="p">],</span> <span class="n">ncol_density_profile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dens_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dens_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dens_data</span> <span class="o">=</span> <span class="n">dens_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/density_profile</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">dens_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dens_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">output_file</span><span class="p">))</span>

    <span class="c1"># Plot mass profile</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading mass profile data from </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;massprofile&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;profile_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_mass_profile&quot;</span><span class="p">)</span>
    <span class="n">mass_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;massprofile&quot;</span><span class="p">],</span> <span class="n">ncol_mass_profile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mass_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mass_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mass_data</span> <span class="o">=</span> <span class="n">mass_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/mass_enclosed</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">mass_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mass_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">output_file</span><span class="p">))</span>

    <span class="c1"># Plot psi profile</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading psi profile data from </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;psiprofile&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;profile_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_psi_profile&quot;</span><span class="p">)</span>
    <span class="n">psi_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;psiprofile&quot;</span><span class="p">],</span> <span class="n">ncol_psi_profile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">psi_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">psi_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">psi_data</span> <span class="o">=</span> <span class="n">psi_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">VEL_CONV_SQ</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.02271e-3</span><span class="o">*</span><span class="mf">1.02271e-3</span><span class="p">)</span>
        <span class="n">psi_data_scaled</span> <span class="o">=</span> <span class="n">psi_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">VEL_CONV_SQ</span> <span class="c1"># Scale to km^2/s^2</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/psi_profile</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;psi&quot;</span><span class="p">,</span> <span class="n">psi_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">psi_data_scaled</span><span class="p">,</span> <span class="n">output_file</span><span class="p">))</span>

    <span class="c1"># Plot dpsi/dr profile</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading dpsi/dr profile data from </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;dpsi_dr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;profile_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_dpsi_dr_profile&quot;</span><span class="p">)</span>
    <span class="n">dpsi_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;dpsi_dr&quot;</span><span class="p">],</span> <span class="n">ncol_dpsi_dr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dpsi_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dpsi_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dpsi_data</span> <span class="o">=</span> <span class="n">dpsi_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/dpsi_dr</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;dpsi&quot;</span><span class="p">,</span> <span class="n">dpsi_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dpsi_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">output_file</span><span class="p">))</span>

    <span class="c1"># Plot drho/dpsi profile</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading drho/dpsi profile data from </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;drho_dpsi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;profile_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_drho_dpsi_profile&quot;</span><span class="p">)</span>
    <span class="n">drho_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;drho_dpsi&quot;</span><span class="p">],</span> <span class="n">ncol_drho_dpsi</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">drho_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">drho_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">drho_data</span> <span class="o">=</span> <span class="n">drho_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/drho_dpsi</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;drho&quot;</span><span class="p">,</span> <span class="n">drho_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">drho_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">output_file</span><span class="p">))</span>

    <span class="c1"># Plot f(E) profile</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading f(E) profile data from </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;f_of_E&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;profile_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_f_of_E_profile&quot;</span><span class="p">)</span>
    <span class="n">fE_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;f_of_E&quot;</span><span class="p">],</span> <span class="n">ncol_f_of_E</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fE_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">fE_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fE_data</span> <span class="o">=</span> <span class="n">fE_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/f_of_E</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;f_of_E&quot;</span><span class="p">,</span> <span class="n">fE_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">fE_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">output_file</span><span class="p">))</span>

    <span class="c1"># Plot df at fixed radius</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading df at fixed radius data from </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;df_fixed_radius&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;profile_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_df_fixed_radius_profile&quot;</span><span class="p">)</span>

    <span class="c1"># Load directly as float32 array - each row has two 4-byte floats</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load binary data</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;df_fixed_radius&quot;</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Reshape into rows of 2 columns</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Make sure we have at least one complete row</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">df_fixed_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded df_fixed_radius data: </span><span class="si">{</span><span class="n">rows</span><span class="si">}</span><span class="s2"> rows of velocity/distribution data&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough data in </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;df_fixed_radius&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">df_fixed_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading df_fixed_radius data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Fall back to standard loading method</span>
        <span class="n">df_fixed_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
            <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;df_fixed_radius&quot;</span><span class="p">],</span> <span class="n">ncol_df_fixed_radius</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_fixed_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="c1"># Filter out any NaN or Inf values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df_fixed_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df_fixed_data</span> <span class="o">=</span> <span class="n">df_fixed_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># Log detailed information about the data</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df_fixed_radius data loaded successfully, shape: </span><span class="si">{</span><span class="n">df_fixed_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_fixed_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df_fixed_radius data range - v: [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df_fixed_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_fixed_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">], &quot;</span> <span class="o">+</span>
                       <span class="sa">f</span><span class="s2">&quot;f: [</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df_fixed_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_fixed_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First 5 rows: </span><span class="si">{</span><span class="n">df_fixed_data</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/df_fixed_radius</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;df_fixed&quot;</span><span class="p">,</span> <span class="n">df_fixed_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">df_fixed_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">output_file</span><span class="p">))</span>

    <span class="c1"># Combined histogram</span>
    <span class="n">combined_histogram_file</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;combined_histogram&#39;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading combined histogram data from </span><span class="si">{</span><span class="n">combined_histogram_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;profile_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_combined_histogram&quot;</span><span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/combined_radial_distribution</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;combined&quot;</span><span class="p">,</span> <span class="n">combined_histogram_file</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="p">))</span>

    <span class="c1"># Now generate all the plots with progress tracking</span>
    <span class="n">total_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prepared_plots</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prepared_plots</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;density&quot;</span><span class="p">:</span>
                <span class="n">plot_density</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;mass&quot;</span><span class="p">:</span>
                <span class="n">plot_mass_enclosed</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;psi&quot;</span><span class="p">:</span>
                <span class="n">plot_psi</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;dpsi&quot;</span><span class="p">:</span>
                <span class="n">plot_dpsi_dr</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;drho&quot;</span><span class="p">:</span>
                <span class="n">plot_drho_dpsi</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;f_of_E&quot;</span><span class="p">:</span>
                <span class="n">plot_f_of_E</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;df_fixed&quot;</span><span class="p">:</span>
                <span class="c1"># Use 2×scale_radius (the actual radius is determined by C code)</span>
                <span class="n">plot_df_at_fixed_radius</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="s2">&quot;2r_s&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;combined&quot;</span><span class="p">:</span>
                <span class="n">plot_combined_histogram_from_file</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

            <span class="c1"># Log to file and update console display with progress</span>
            <span class="n">log_plot_saved</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total_plots</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating </span><span class="si">{</span><span class="n">plot_type</span><span class="si">}</span><span class="s2"> plot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating </span><span class="si">{</span><span class="n">plot_type</span><span class="si">}</span><span class="s2"> plot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span></div>


<div class="viewcode-block" id="process_trajectory_energy_plots">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_trajectory_energy_plots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_trajectory_energy_plots</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="n">include_angular_momentum</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process energy plots that are part of the trajectory plots but should also</span>
<span class="sd">    be included in the energy plots category.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_paths : dict</span>
<span class="sd">        Dictionary of file paths for various data files.</span>
<span class="sd">    include_angular_momentum : bool, optional</span>
<span class="sd">        Whether to include angular momentum plots. Default is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">suffix</span>

    <span class="c1"># Create the results directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Prepare plots to be generated</span>
    <span class="n">prepared_plots</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Energy vs time plot</span>
    <span class="n">energy_output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/energy_vs_time</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;energy_and_angular_momentum&quot;</span><span class="p">],</span> <span class="n">energy_output_file</span><span class="p">))</span>

    <span class="c1"># Angular momentum vs time (if requested)</span>
    <span class="k">if</span> <span class="n">include_angular_momentum</span><span class="p">:</span>
        <span class="n">angular_output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/angular_momentum_vs_time</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;angular&quot;</span><span class="p">,</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;energy_and_angular_momentum&quot;</span><span class="p">],</span> <span class="n">angular_output_file</span><span class="p">))</span>

    <span class="c1"># Debug energy comparison (if available)</span>
    <span class="n">debug_file</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;debug_energy_compare&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">debug_file</span><span class="p">):</span>
        <span class="c1"># Define output filename for the energy comparison plot</span>
        <span class="n">debug_output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/energy_compare</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">debug_file</span><span class="p">,</span> <span class="n">debug_output_file</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Energy compare file </span><span class="si">{</span><span class="n">debug_file</span><span class="si">}</span><span class="s2"> not found; skipping energy compare plot.&quot;</span><span class="p">)</span>

    <span class="c1"># Define a unique section key for this set of plots</span>
    <span class="n">section_key</span> <span class="o">=</span> <span class="s2">&quot;additional_energy_plots&quot;</span>
    <span class="n">total_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prepared_plots</span><span class="p">)</span>

    <span class="c1"># Start combined progress tracking for these plots</span>
    <span class="k">if</span> <span class="n">total_plots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">start_combined_progress</span><span class="p">(</span><span class="n">section_key</span><span class="p">,</span> <span class="n">total_plots</span><span class="p">)</span>

        <span class="c1"># Generate all plots with progress tracking</span>
        <span class="k">for</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span> <span class="ow">in</span> <span class="n">prepared_plots</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;energy&quot;</span><span class="p">:</span>
                    <span class="n">plot_energy_time</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;angular&quot;</span><span class="p">:</span>
                    <span class="n">plot_angular_momentum_time</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;debug&quot;</span><span class="p">:</span>
                    <span class="n">plot_debug_energy_compare</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

                <span class="c1"># When called from trajectory_plots, update the combined progress tracker</span>
                <span class="k">if</span> <span class="s2">&quot;trajectory_plots&quot;</span> <span class="ow">in</span> <span class="n">_combined_plot_trackers</span><span class="p">:</span>
                    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;trajectory_plots&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Otherwise, use our section tracker</span>
                    <span class="n">update_combined_progress</span><span class="p">(</span><span class="n">section_key</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating </span><span class="si">{</span><span class="n">plot_type</span><span class="si">}</span><span class="s2"> plot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating </span><span class="si">{</span><span class="n">plot_type</span><span class="si">}</span><span class="s2"> plot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If no plots to generate, just log and continue</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No additional energy plots to generate.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_trajectory_plots">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_trajectory_plots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_trajectory_plots</span><span class="p">(</span><span class="n">file_paths</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process trajectory and diagnostic plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_paths : dict</span>
<span class="sd">        Dictionary of file paths for various data files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">suffix</span>

    <span class="c1"># Create the results directory if it doesn&#39;t exist</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Calculate total number of data files to load (for progress tracking)</span>
    <span class="c1"># Four different data files to potentially load: trajectories, single_trajectory, lowest_l_trajectories, energy_and_angular_momentum</span>
    <span class="n">total_data_files</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># Start progress tracking for data loading</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;trajectory_data_loading&quot;</span><span class="p">,</span> <span class="n">total_data_files</span><span class="p">)</span>

    <span class="c1"># Prepare plots to be generated</span>
    <span class="n">prepared_plots</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Trajectory plots - check and load</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading trajectory data from </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;trajectories&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;trajectory_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_trajectories&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;trajectories&quot;</span><span class="p">]):</span>
        <span class="n">trajectories_output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/trajectories</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;trajectories&quot;</span><span class="p">,</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;trajectories&quot;</span><span class="p">],</span> <span class="n">trajectories_output</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trajectory file </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;trajectories&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found, skipping.&quot;</span><span class="p">)</span>

    <span class="c1"># Single trajectory - check and load</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading single trajectory data from </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;single_trajectory&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;trajectory_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_single_trajectory&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;single_trajectory&quot;</span><span class="p">]):</span>
        <span class="n">single_trajectory_output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/single_trajectory</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;single&quot;</span><span class="p">,</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;single_trajectory&quot;</span><span class="p">],</span> <span class="n">single_trajectory_output</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Single trajectory file </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;single_trajectory&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found, skipping.&quot;</span><span class="p">)</span>

    <span class="c1"># Lowest L or Chosen L 3-panel - check for both, prioritize chosen_l</span>
    <span class="n">chosen_l_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/chosen_l_trajectories</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
    <span class="n">lowest_l_file</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;lowest_l_trajectories&quot;</span><span class="p">]</span>

    <span class="n">actual_input_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">file_prefix_for_plot</span> <span class="o">=</span> <span class="s2">&quot;lowestl&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">chosen_l_file</span><span class="p">):</span>
        <span class="n">actual_input_file</span> <span class="o">=</span> <span class="n">chosen_l_file</span>
        <span class="n">file_prefix_for_plot</span> <span class="o">=</span> <span class="s2">&quot;chosenl&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading chosen L trajectories data from </span><span class="si">{</span><span class="n">chosen_l_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">lowest_l_file</span><span class="p">):</span>
        <span class="n">actual_input_file</span> <span class="o">=</span> <span class="n">lowest_l_file</span>
        <span class="n">file_prefix_for_plot</span> <span class="o">=</span> <span class="s2">&quot;lowestl&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading lowest L trajectories data from </span><span class="si">{</span><span class="n">lowest_l_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;trajectory_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_lowest_l_trajectories&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">actual_input_file</span><span class="p">:</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/</span><span class="si">{</span><span class="n">file_prefix_for_plot</span><span class="si">}</span><span class="s2">_3panel</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">prepared_plots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;lowest_l&quot;</span><span class="p">,</span> <span class="n">actual_input_file</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">file_prefix_for_plot</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Neither chosen_l nor lowest_l trajectories file found, skipping.&quot;</span><span class="p">)</span>

    <span class="c1"># Energy and angular momentum data - check and load</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading energy and angular momentum data from </span><span class="si">{</span><span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;energy_and_angular_momentum&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;trajectory_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_energy_angular_momentum&quot;</span><span class="p">)</span>

    <span class="c1"># Generate trajectory plots using the combined progress tracker</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prepared_plots</span><span class="p">:</span>
        <span class="n">plot_type</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">input_file</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;trajectories&quot;</span><span class="p">:</span>
                <span class="n">plot_trajectories</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
                <span class="n">plot_single_trajectory</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;lowest_l&quot;</span><span class="p">:</span>
                <span class="n">plot_lowestL_trajectories_3panel</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">file_prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>

            <span class="c1"># Update the combined progress tracker (shared with energy plots)</span>
            <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;trajectory_plots&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating </span><span class="si">{</span><span class="n">plot_type</span><span class="si">}</span><span class="s2"> plot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating </span><span class="si">{</span><span class="n">plot_type</span><span class="si">}</span><span class="s2"> plot: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

    <span class="c1"># Also generate the energy plots from this category</span>
    <span class="n">process_trajectory_energy_plots</span><span class="p">(</span><span class="n">file_paths</span><span class="p">)</span></div>


<span class="c1"># Global variables to store snapshot data for animation rendering</span>
<span class="n">mass_snapshots</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">density_snapshots</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">psi_snapshots</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Global variables to store max values for consistent scaling across frames</span>
<span class="n">mass_max_value</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">density_max_value</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">psi_max_value</span> <span class="o">=</span> <span class="mf">0.0</span>

<div class="viewcode-block" id="calculate_global_max_values">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.calculate_global_max_values">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_global_max_values</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the maximum values of mass, density, and potential across all snapshots.</span>
<span class="sd">    This ensures consistent scaling in animations.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (mass_max, density_max, psi_max) - Maximum values for each quantity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">mass_snapshots</span><span class="p">,</span> <span class="n">density_snapshots</span><span class="p">,</span> <span class="n">psi_snapshots</span>
    <span class="k">global</span> <span class="n">mass_max_value</span><span class="p">,</span> <span class="n">density_max_value</span><span class="p">,</span> <span class="n">psi_max_value</span>
    
    <span class="c1"># Find max mass value</span>
    <span class="k">if</span> <span class="n">mass_snapshots</span><span class="p">:</span>
        <span class="n">mass_max_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mass_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">mass_data</span> <span class="ow">in</span> <span class="n">mass_snapshots</span><span class="p">)</span>
        <span class="c1"># Add 5% margin</span>
        <span class="n">mass_max_value</span> <span class="o">*=</span> <span class="mf">1.05</span>
    
    <span class="c1"># Find max density value (4*pi*r^2*rho)</span>
    <span class="k">if</span> <span class="n">density_snapshots</span><span class="p">:</span>
        <span class="n">density_max_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">density_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">density_data</span> <span class="ow">in</span> <span class="n">density_snapshots</span><span class="p">)</span>
        <span class="c1"># Add 5% margin</span>
        <span class="n">density_max_value</span> <span class="o">*=</span> <span class="mf">1.05</span>
    
    <span class="c1"># Find max psi value</span>
    <span class="k">if</span> <span class="n">psi_snapshots</span><span class="p">:</span>
        <span class="n">psi_max_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psi_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">psi_data</span> <span class="ow">in</span> <span class="n">psi_snapshots</span><span class="p">)</span>
        <span class="c1"># Add 5% margin</span>
        <span class="n">psi_max_value</span> <span class="o">*=</span> <span class="mf">1.05</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Global max values: Mass=</span><span class="si">{</span><span class="n">mass_max_value</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, Density=</span><span class="si">{</span><span class="n">density_max_value</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">, Psi=</span><span class="si">{</span><span class="n">psi_max_value</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">mass_max_value</span><span class="p">,</span> <span class="n">density_max_value</span><span class="p">,</span> <span class="n">psi_max_value</span><span class="p">)</span></div>


<span class="c1"># Frame rendering functions for animation</span>
<div class="viewcode-block" id="render_mass_frame">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.render_mass_frame">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">render_mass_frame</span><span class="p">(</span><span class="n">frame_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a single frame of mass profile animation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    frame_data : tuple </span>
<span class="sd">        Tuple containing (snapshot_data, tfinal_factor, total_frames, r_range, m_range, project_root_path) where:</span>
<span class="sd">        - snapshot_data is the (snap, radius, mass) tuple from mass_snapshots</span>
<span class="sd">        - r_range is (r_min, r_max) tuple for x-axis</span>
<span class="sd">        - m_range is (m_min, m_max) tuple for y-axis</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Image data for the rendered frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># No longer need global mass_max_value as we pass ranges directly</span>

    <span class="c1"># Unpack the passed data tuple</span>
    <span class="n">snapshot_data</span><span class="p">,</span> <span class="n">tfinal_factor</span><span class="p">,</span> <span class="n">total_snapshots</span><span class="p">,</span> <span class="n">r_range</span><span class="p">,</span> <span class="n">m_range</span><span class="p">,</span> <span class="n">project_root_path</span> <span class="o">=</span> <span class="n">frame_data</span>
    <span class="c1"># Unpack the actual data from the snapshot tuple</span>
    <span class="n">snap</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">mass</span> <span class="o">=</span> <span class="n">snapshot_data</span>
    <span class="c1"># Unpack the range tuples</span>
    <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">r_range</span>
    <span class="n">m_min</span><span class="p">,</span> <span class="n">m_max</span> <span class="o">=</span> <span class="n">m_range</span>

    <span class="c1"># Calculate time in dynamical times using the passed total_snapshots</span>
    <span class="k">if</span> <span class="n">total_snapshots</span> <span class="ow">and</span> <span class="n">total_snapshots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">t_dyn_fraction</span> <span class="o">=</span> <span class="n">snap</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_snapshots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tfinal_factor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback if total_snapshots is 0 or 1</span>
        <span class="n">t_dyn_fraction</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Mass Profile Evolution&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ (kpc)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$M(r)$ (M$_\odot$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    
    
    <span class="c1"># Use the passed range values</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
    
    <span class="c1"># Use the passed mass range</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">m_min</span><span class="p">,</span> <span class="n">m_max</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add text in upper right corner showing time in dynamical times</span>
    <span class="c1"># Regular black text on semi-transparent white background for mass profile</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;$t = </span><span class="si">{</span><span class="n">t_dyn_fraction</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\\</span><span class="s2">,t_</span><span class="se">{{\\</span><span class="s2">rm dyn</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="render_density_frame">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.render_density_frame">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">render_density_frame</span><span class="p">(</span><span class="n">frame_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a single frame of density profile animation.</span>
<span class="sd">    Note: Assumes density_snapshots contains 4*pi*r^2*rho.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    frame_data : tuple</span>
<span class="sd">        Tuple containing (snapshot_data, tfinal_factor, total_frames, r_range, d_range, project_root_path) where</span>
<span class="sd">        snapshot_data is the (snap, radius, density) tuple from density_snapshots,</span>
<span class="sd">        r_range is (r_min, r_max) tuple for radius axis limits,</span>
<span class="sd">        d_range is (d_min, d_max) tuple for density axis limits.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Image data for the rendered frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># No longer need global density_max_value as it&#39;s passed in d_range</span>

    <span class="c1"># Unpack the passed data tuple</span>
    <span class="n">snapshot_data</span><span class="p">,</span> <span class="n">tfinal_factor</span><span class="p">,</span> <span class="n">total_snapshots</span><span class="p">,</span> <span class="n">r_range</span><span class="p">,</span> <span class="n">d_range</span><span class="p">,</span> <span class="n">project_root_path</span> <span class="o">=</span> <span class="n">frame_data</span>
    <span class="c1"># Unpack the actual data from the snapshot tuple</span>
    <span class="n">snap</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="n">snapshot_data</span> <span class="c1"># Assumed this is 4*pi*r^2*rho</span>

    <span class="c1"># Calculate time in dynamical times using the passed total_snapshots</span>
    <span class="k">if</span> <span class="n">total_snapshots</span> <span class="ow">and</span> <span class="n">total_snapshots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">t_dyn_fraction</span> <span class="o">=</span> <span class="n">snap</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_snapshots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tfinal_factor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback if total_snapshots is 0 or 1</span>
        <span class="n">t_dyn_fraction</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Density Profile Evolution&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ (kpc)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$4\pi r^2 \rho(r)$ (M$_\odot$/kpc)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="c1"># Label matches data</span>
    
    
    <span class="c1"># Use the passed range values</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">r_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># Use the passed density range</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">d_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="c1"># Directly plot the &#39;density&#39; variable, as it&#39;s assumed to be 4*pi*r^2*rho already</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add text in upper right corner showing time in dynamical times</span>
    <span class="c1"># Regular black text on semi-transparent white background for density profile</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;$t = </span><span class="si">{</span><span class="n">t_dyn_fraction</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\\</span><span class="s2">,t_</span><span class="se">{{\\</span><span class="s2">rm dyn</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="render_psi_frame">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.render_psi_frame">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">render_psi_frame</span><span class="p">(</span><span class="n">frame_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a single frame of psi profile animation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    frame_data : tuple</span>
<span class="sd">        Tuple containing (snapshot_data, tfinal_factor, total_frames, r_range, p_range, project_root_path) where</span>
<span class="sd">        snapshot_data is the (snap, radius, psi) tuple from psi_snapshots,</span>
<span class="sd">        r_range is (r_min, r_max) tuple for radius axis limits,</span>
<span class="sd">        p_range is (p_min, p_max) tuple for psi axis limits.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Image data for the rendered frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># No longer need global psi_max_value as it&#39;s passed in p_range</span>

    <span class="c1"># Unpack the passed data tuple</span>
    <span class="n">snapshot_data</span><span class="p">,</span> <span class="n">tfinal_factor</span><span class="p">,</span> <span class="n">total_snapshots</span><span class="p">,</span> <span class="n">r_range</span><span class="p">,</span> <span class="n">p_range</span><span class="p">,</span> <span class="n">project_root_path</span> <span class="o">=</span> <span class="n">frame_data</span>
    <span class="c1"># Unpack the actual data from the snapshot tuple</span>
    <span class="n">snap</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">snapshot_data</span>

    <span class="c1"># Calculate time in dynamical times using the passed total_snapshots</span>
    <span class="k">if</span> <span class="n">total_snapshots</span> <span class="ow">and</span> <span class="n">total_snapshots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">t_dyn_fraction</span> <span class="o">=</span> <span class="n">snap</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_snapshots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tfinal_factor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback if total_snapshots is 0 or 1</span>
        <span class="n">t_dyn_fraction</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Potential Profile Evolution&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$ (kpc)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Psi(r)$ (km$^2$/s$^2$)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    
    
    <span class="c1"># Use the passed range values</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">r_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="c1"># Use the passed psi range</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">p_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add text in upper right corner showing time in dynamical times</span>
    <span class="c1"># Regular black text on semi-transparent white background for potential profile</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;$t = </span><span class="si">{</span><span class="n">t_dyn_fraction</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\\</span><span class="s2">,t_</span><span class="se">{{\\</span><span class="s2">rm dyn</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="process_particle_data">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_particle_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_particle_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts key quantities and calculates total velocity.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : ndarray</span>
<span class="sd">        Particle data array</span>
<span class="sd">    n_cols : int</span>
<span class="sd">        Number of columns in the data</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (radius, radial_velocity, angular_momentum, total_velocity) for valid particles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># These use global constants defined at the top of the file</span>
    
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">n_cols</span> <span class="o">==</span> <span class="n">ncol_particles_initial</span><span class="p">:</span>
        <span class="n">radii</span><span class="p">,</span> <span class="n">radial_velocity</span><span class="p">,</span> <span class="n">angular_momentum</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">n_cols</span> <span class="o">==</span> <span class="n">ncol_Rank_Mass_Rad_VRad_unsorted</span><span class="p">:</span>
        <span class="n">radii</span><span class="p">,</span> <span class="n">radial_velocity</span><span class="p">,</span> <span class="n">angular_momentum</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Unsupported column count (</span><span class="si">{</span><span class="n">n_cols</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">radii</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">nonzero_mask</span><span class="p">):</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Warning: No particles with positive radius found.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">radii_nz</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">radial_velocity_nz</span> <span class="o">=</span> <span class="n">radial_velocity</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">angular_momentum_nz</span> <span class="o">=</span> <span class="n">angular_momentum</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">radii_nz</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Warning: Zero or negative radius found after mask?&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">tangential_velocity_sim</span> <span class="o">=</span> <span class="n">angular_momentum_nz</span> <span class="o">/</span> <span class="n">radii_nz</span>
        <span class="n">total_velocity_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tangential_velocity_sim</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">radial_velocity_nz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">kmsec_to_kpcmyr</span> <span class="o">=</span> <span class="mf">1.02271e-3</span>
    <span class="n">total_velocity_kms</span> <span class="o">=</span> <span class="n">total_velocity_sim</span> <span class="o">/</span> <span class="n">kmsec_to_kpcmyr</span>
    <span class="n">tangential_velocity_kms</span> <span class="o">=</span> <span class="n">tangential_velocity_sim</span> <span class="o">/</span> <span class="n">kmsec_to_kpcmyr</span> <span class="c1"># Convert v_perp to km/s</span>

    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">radii_nz</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">total_velocity_kms</span><span class="p">)</span> <span class="o">&amp;</span> \
                 <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">radial_velocity_nz</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">angular_momentum_nz</span><span class="p">)</span> <span class="o">&amp;</span> \
                 <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">tangential_velocity_kms</span><span class="p">)</span> <span class="o">&amp;</span> \
                 <span class="p">(</span><span class="n">total_velocity_kms</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">radii_nz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># v_total can be 0 if at rest</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">):</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Warning: No valid particles after filtering infinities/NaNs.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">final_radii</span> <span class="o">=</span> <span class="n">radii_nz</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
    <span class="n">final_vr_kms</span> <span class="o">=</span> <span class="p">(</span><span class="n">radial_velocity_nz</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span> <span class="o">/</span> <span class="n">kmsec_to_kpcmyr</span>
    <span class="n">final_L</span> <span class="o">=</span> <span class="n">angular_momentum_nz</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
    <span class="n">final_vtotal_kms</span> <span class="o">=</span> <span class="n">total_velocity_kms</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
    <span class="n">final_vperp_kms</span> <span class="o">=</span> <span class="n">tangential_velocity_kms</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">final_radii</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid particles.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_radii</span><span class="p">,</span> <span class="n">final_vr_kms</span><span class="p">,</span> <span class="n">final_L</span><span class="p">,</span> <span class="n">final_vtotal_kms</span><span class="p">,</span> <span class="n">final_vperp_kms</span></div>


<div class="viewcode-block" id="plot_particles_histograms">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_particles_histograms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_particles_histograms</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots 2D histograms from the particles files.</span>

<span class="sd">    • Reads the initial particles file: data/particles{suffix}.dat (expected 4 columns)</span>
<span class="sd">      and plots a histogram with plt.hist2d.</span>

<span class="sd">    • Reads the final particles file: data/particlesfinal{suffix}.dat (expected 4 columns);</span>
<span class="sd">      computes a derived velocity value and then plots a 2D histogram.</span>

<span class="sd">    Resulting images are saved to the &quot;results&quot; folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>
<span class="sd">    progress_callback : callable, optional</span>
<span class="sd">        Function to call after each plot is saved,</span>
<span class="sd">        with the output file path as argument.</span>
<span class="sd">    config : dict, optional</span>
<span class="sd">        Configuration dictionary with plot settings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Constants for expected number of columns</span>
    <span class="n">ncol_particles_initial</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">ncol_particles_final</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># Track plots we&#39;ll generate</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Start progress tracking for data loading (4 steps: check initial, load initial, check final, load final)</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;particles_histograms_data_loading&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># Plot the initial particles file histogram</span>
    <span class="n">particles_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/particles</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>

    <span class="c1"># Update progress - checking initial file</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;particles_histograms_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;checking_initial_file&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">particles_file</span><span class="p">):</span>
        <span class="c1"># Use the appropriate column count for initial particles</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading initial particles data from </span><span class="si">{</span><span class="n">particles_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Update progress - loading initial data</span>
        <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;particles_histograms_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_initial_data&quot;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
            <span class="n">particles_file</span><span class="p">,</span> <span class="n">ncol_particles_initial</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">particles_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">particles_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iradii</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">radialvelocities</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">ell</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="c1"># Avoid division by zero by filtering out non-positive radii.</span>
            <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">iradii</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">iradii</span> <span class="o">=</span> <span class="n">iradii</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
            <span class="n">radialvelocities</span> <span class="o">=</span> <span class="n">radialvelocities</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
            <span class="n">ell</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>

            <span class="c1"># Log data processing details</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing initial particles data, shape before filtering: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-zero radii: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nonzero_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nonzero_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Record original data size for debugging</span>
            <span class="k">global</span> <span class="n">particles_original_count</span>
            <span class="n">particles_original_count</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Particles 2D initial histogram - Original data size: </span><span class="si">{</span><span class="n">particles_original_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Log original array size before filtering</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original data array size (before filtering): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">iradii</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Compute the derived (total) velocity as given by:</span>
            <span class="c1"># ivelocities = sqrt(ell^2 + (radialvelocities^2 * iradii^2)) / iradii / 1.02271e-3</span>
            <span class="n">ivelocities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ell</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">radialvelocities</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                                  <span class="o">*</span> <span class="p">(</span><span class="n">iradii</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">iradii</span> <span class="o">/</span> <span class="mf">1.02271e-3</span>
            <span class="c1"># Filter out extreme values for visualization</span>
            <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivelocities</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ivelocities</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">)</span>
            <span class="n">iradii</span> <span class="o">=</span> <span class="n">iradii</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            <span class="n">ivelocities</span> <span class="o">=</span> <span class="n">ivelocities</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid velocities after filtering: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iradii</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;All initial radii/velocities invalid or empty.&quot;</span><span class="p">)</span>
                <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;All initial radii/velocities invalid or empty.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Calculate dynamic ranges using the robust range helper</span>
                <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
                    <span class="n">iradii</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile</span><span class="p">,</span> 
                    <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile_multiplier</span><span class="p">,</span>
                    <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_x_range_abs</span><span class="p">,</span>
                    <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;radius&quot;</span>
                <span class="p">)</span>
                
                <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
                    <span class="n">ivelocities</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile</span><span class="p">,</span>
                    <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile_multiplier</span><span class="p">,</span>
                    <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_y_range_abs</span><span class="p">,</span> 
                    <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">320.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;velocity&quot;</span>
                <span class="p">)</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
                <span class="n">hist_counts</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">iradii</span><span class="p">,</span> <span class="n">ivelocities</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> 
                                                   <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">],</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]])</span>
                
                <span class="c1"># Calculate color scale limits based on statistics of non-zero bins</span>
                <span class="n">nonzero_counts</span> <span class="o">=</span> <span class="n">hist_counts</span><span class="p">[</span><span class="n">hist_counts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonzero_counts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Use 2.5x the 75th percentile for color scale maximum</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">nonzero_counts</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.5</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span><span class="n">iradii</span><span class="p">,</span> <span class="n">ivelocities</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span>
                           <span class="p">[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">],</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Initial Phase Space Distribution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>
                <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/2d_histogram_initial</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>

                <span class="c1"># Save original data size before any filtering</span>
                <span class="n">original_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Calculate and store histogram statistics</span>
                <span class="n">hist_counts</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">iradii</span><span class="p">,</span> <span class="n">ivelocities</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">],</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]])</span>
                <span class="n">initial_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hist_counts</span><span class="p">)</span>
                <span class="n">initial_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">hist_counts</span><span class="p">)</span>
                <span class="n">initial_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist_counts</span><span class="p">)</span><span class="o">/</span><span class="n">initial_nonzero</span> <span class="k">if</span> <span class="n">initial_nonzero</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">initial_total_particles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iradii</span><span class="p">)</span>
                <span class="n">initial_histogram_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist_counts</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original particle count: </span><span class="si">{</span><span class="n">original_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered particle count: </span><span class="si">{</span><span class="n">initial_total_particles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram sum: </span><span class="si">{</span><span class="n">initial_histogram_sum</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Log detailed statistics</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial histogram statistics: Max=</span><span class="si">{</span><span class="n">initial_max</span><span class="si">}</span><span class="s2">, Mean=</span><span class="si">{</span><span class="n">initial_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Non-Zero Bins=</span><span class="si">{</span><span class="n">initial_nonzero</span><span class="si">}</span><span class="s2">, Total Particles=</span><span class="si">{</span><span class="n">initial_total_particles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">particles_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">particles_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># Plot final particles histogram</span>
    <span class="n">particlesfinal_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/particlesfinal</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>

    <span class="c1"># Update progress - checking final file</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;particles_histograms_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;checking_final_file&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">particlesfinal_file</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading final particles data from </span><span class="si">{</span><span class="n">particlesfinal_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Update progress - loading final data</span>
        <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;particles_histograms_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_final_data&quot;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
            <span class="n">particlesfinal_file</span><span class="p">,</span> <span class="n">ncol_particles_final</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">particlesfinal_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">particlesfinal_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fradii</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">radialvelocities</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">ell</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

            <span class="c1"># Log data processing details</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing final particles data, shape before filtering: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Record original data size for debugging</span>
            <span class="k">global</span> <span class="n">particles_final_original_count</span>
            <span class="n">particles_final_original_count</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Particles 2D final histogram - Original data size: </span><span class="si">{</span><span class="n">particles_final_original_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Avoid division by zero by filtering out non-positive radii.</span>
            <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">fradii</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">fradii</span> <span class="o">=</span> <span class="n">fradii</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
            <span class="n">radialvelocities</span> <span class="o">=</span> <span class="n">radialvelocities</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
            <span class="n">ell</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-zero radii: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nonzero_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nonzero_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Log original array size before filtering</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original data array size (before filtering): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fradii</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Compute the derived velocity as given by:</span>
            <span class="c1"># fvelocities = sqrt(ell^2 + (radialvelocities^2 * fradii^2)) / fradii / 1.02271e-3</span>
            <span class="n">fvelocities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">ell</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">radialvelocities</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">fradii</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">fradii</span> <span class="o">/</span> <span class="mf">1.02271e-3</span>
            <span class="c1"># Filter out extreme values for visualization</span>
            <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">fvelocities</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fvelocities</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">)</span>
            <span class="n">fradii</span> <span class="o">=</span> <span class="n">fradii</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            <span class="n">fvelocities</span> <span class="o">=</span> <span class="n">fvelocities</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valid velocities after filtering: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fradii</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;All final radii/velocities invalid or empty.&quot;</span><span class="p">)</span>
                <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;All final radii/velocities invalid or empty.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Calculate dynamic ranges using the robust range helper</span>
                <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
                    <span class="n">fradii</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile</span><span class="p">,</span>
                    <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile_multiplier</span><span class="p">,</span>
                    <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_x_range_abs</span><span class="p">,</span>
                    <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;radius&quot;</span>
                <span class="p">)</span>
                
                <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
                    <span class="n">fvelocities</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile</span><span class="p">,</span>
                    <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile_multiplier</span><span class="p">,</span>
                    <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_y_range_abs</span><span class="p">,</span> 
                    <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">320.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;velocity&quot;</span>
                <span class="p">)</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
                <span class="n">hist_counts_temp</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">fradii</span><span class="p">,</span> <span class="n">fvelocities</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> 
                                                        <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">],</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]])</span>
                
                <span class="c1"># Calculate color scale limits based on statistics of non-zero bins</span>
                <span class="n">nonzero_counts_temp</span> <span class="o">=</span> <span class="n">hist_counts_temp</span><span class="p">[</span><span class="n">hist_counts_temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonzero_counts_temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Use 2.5x the 75th percentile for color scale maximum</span>
                    <span class="n">vmax_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">nonzero_counts_temp</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.5</span>
                    <span class="n">vmin_color</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vmin_color</span><span class="p">,</span> <span class="n">vmax_color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span><span class="n">fradii</span><span class="p">,</span> <span class="n">fvelocities</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span>
                           <span class="p">[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">],</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin_color</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_color</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Final Phase Space Distribution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>
                <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/2d_histogram_final</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>

                <span class="c1"># Save original data size before any filtering</span>
                <span class="n">original_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Calculate and store histogram statistics</span>
                <span class="n">hist_counts</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">fradii</span><span class="p">,</span> <span class="n">fvelocities</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">],</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]])</span>
                <span class="n">final_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hist_counts</span><span class="p">)</span>
                <span class="n">final_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">hist_counts</span><span class="p">)</span>
                <span class="n">final_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist_counts</span><span class="p">)</span><span class="o">/</span><span class="n">final_nonzero</span> <span class="k">if</span> <span class="n">final_nonzero</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">final_total_particles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fradii</span><span class="p">)</span>
                <span class="n">final_histogram_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hist_counts</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original particle count: </span><span class="si">{</span><span class="n">original_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtered particle count: </span><span class="si">{</span><span class="n">final_total_particles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram sum: </span><span class="si">{</span><span class="n">final_histogram_sum</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Log detailed statistics</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final histogram statistics: Max=</span><span class="si">{</span><span class="n">final_max</span><span class="si">}</span><span class="s2">, Mean=</span><span class="si">{</span><span class="n">final_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Non-Zero Bins=</span><span class="si">{</span><span class="n">final_nonzero</span><span class="si">}</span><span class="s2">, Total Particles=</span><span class="si">{</span><span class="n">final_total_particles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">particlesfinal_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">particlesfinal_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="c1"># Print histogram statistics to console for valid data</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Particles histogram statistics:&quot;</span><span class="p">)</span>

        <span class="c1"># Display initial histogram statistics</span>
        <span class="k">if</span> <span class="s1">&#39;initial_max&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;initial_nonzero&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;initial_mean&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Data: Max. Value = </span><span class="si">{</span><span class="n">initial_max</span><span class="si">}</span><span class="s2">, Non-Zero Bins = </span><span class="si">{</span><span class="n">initial_nonzero</span><span class="si">}</span><span class="s2">, Mean Value (Non-Zero) = </span><span class="si">{</span><span class="n">initial_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;initial_total_particles&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;initial_histogram_sum&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="c1"># Only log the particle counts and histogram total to the log file</span>
                <span class="k">if</span> <span class="n">enable_logging</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Data: Original Size = </span><span class="si">{</span><span class="n">particles_original_count</span><span class="si">}</span><span class="s2">, Particles = </span><span class="si">{</span><span class="n">initial_total_particles</span><span class="si">}</span><span class="s2">, Histogram Total = </span><span class="si">{</span><span class="n">initial_histogram_sum</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Find initial file if we don&#39;t have statistics</span>
            <span class="n">initial_file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">output_files</span> <span class="k">if</span> <span class="s2">&quot;initial&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initial_file</span><span class="p">:</span>
                <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Data: Generated histogram saved to </span><span class="si">{</span><span class="n">initial_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Display final histogram statistics</span>
        <span class="k">if</span> <span class="s1">&#39;final_max&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;final_nonzero&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;final_mean&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Data:   Max. Value = </span><span class="si">{</span><span class="n">final_max</span><span class="si">}</span><span class="s2">, Non-Zero Bins = </span><span class="si">{</span><span class="n">final_nonzero</span><span class="si">}</span><span class="s2">, Mean Value (Non-Zero) = </span><span class="si">{</span><span class="n">final_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;final_total_particles&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;final_histogram_sum&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="c1"># Only log the particle counts and histogram total to the log file</span>
                <span class="k">if</span> <span class="n">enable_logging</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Data: Original Size = </span><span class="si">{</span><span class="n">particles_final_original_count</span><span class="si">}</span><span class="s2">, Particles = </span><span class="si">{</span><span class="n">final_total_particles</span><span class="si">}</span><span class="s2">, Histogram Total = </span><span class="si">{</span><span class="n">final_histogram_sum</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Find final file if we don&#39;t have statistics</span>
            <span class="n">final_file</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">output_files</span> <span class="k">if</span> <span class="s2">&quot;final&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">final_file</span><span class="p">:</span>
                <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Data:   Generated histogram saved to </span><span class="si">{</span><span class="n">final_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add separator line after statistics</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Once data loading is complete, start plot saving progress if needed</span>
    <span class="k">if</span> <span class="n">output_files</span><span class="p">:</span>
        <span class="c1"># Start a new progress tracker for saving plots</span>
        <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;particles_histograms_plots&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_files</span><span class="p">))</span>

    <span class="c1"># Log generated plots with progress indication</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="c1"># Use progress callback for unified progress tracking</span>
        <span class="k">for</span> <span class="n">output_file</span> <span class="ow">in</span> <span class="n">output_files</span><span class="p">:</span>
            <span class="n">progress_callback</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback to standard progress tracking</span>
        <span class="k">for</span> <span class="n">output_file</span> <span class="ow">in</span> <span class="n">output_files</span><span class="p">:</span>
            <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;particles_histograms_plots&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_nsphere_histograms">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_nsphere_histograms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_nsphere_histograms</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots 2D histograms from the nsphere.c-produced binary histogram files.</span>

<span class="sd">    Expects each file to contain 3 columns and 160000 records (reshaped to 400 × 400).</span>

<span class="sd">    • data/2d_hist_initial{suffix}.dat for the initial histogram.</span>
<span class="sd">    • data/2d_hist_final{suffix}.dat for the final histogram.</span>

<span class="sd">    The plots are created using plt.pcolormesh and saved into the &quot;results&quot; folder.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>
<span class="sd">    progress_callback : callable, optional</span>
<span class="sd">        Function to call after each plot is saved,</span>
<span class="sd">        with the output file path as argument.</span>
<span class="sd">    config : dict, optional</span>
<span class="sd">        Configuration dictionary with plot settings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ncols_hist</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">hist_dtype</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">]</span>

    <span class="c1"># Track plots we&#39;ll generate</span>
    <span class="n">output_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Start progress tracking for data loading (4 steps: check initial, load initial, check final, load final)</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;nsphere_histograms_data_loading&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># Plot nsphere initial histogram</span>
    <span class="n">hist_initial_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/2d_hist_initial</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>

    <span class="c1"># Update progress - checking initial file</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;nsphere_histograms_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;checking_initial_file&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hist_initial_file</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading initial histogram data from </span><span class="si">{</span><span class="n">hist_initial_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Update progress - loading initial data</span>
        <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;nsphere_histograms_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_initial_histogram&quot;</span><span class="p">)</span>

        <span class="n">data_init</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
            <span class="n">hist_initial_file</span><span class="p">,</span> <span class="n">ncols_hist</span><span class="p">,</span> <span class="n">hist_dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">hist_initial_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">hist_initial_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">160000</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected 160000 entries in </span><span class="si">{</span><span class="n">hist_initial_file</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">data_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">print_status</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: Expected 160000 entries in </span><span class="si">{</span><span class="n">hist_initial_file</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">data_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing initial histogram data, shape: </span><span class="si">{</span><span class="n">data_init</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">X_init</span> <span class="o">=</span> <span class="n">data_init</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
                    <span class="n">Y_init</span> <span class="o">=</span> <span class="n">data_init</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
                    <span class="n">C_init</span> <span class="o">=</span> <span class="n">data_init</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>

                    <span class="c1"># Calculate statistics for histogram</span>
                    <span class="n">hist_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">C_init</span><span class="p">)</span>
                    <span class="n">hist_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">C_init</span><span class="p">)</span>
                    <span class="n">hist_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_init</span><span class="p">)</span><span class="o">/</span><span class="n">hist_nonzero</span> <span class="k">if</span> <span class="n">hist_nonzero</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="c1"># Get total particles (sum of all counts)</span>
                    <span class="n">hist_total_particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_init</span><span class="p">)</span>

                    <span class="c1"># Record original data size for debugging</span>
                    <span class="n">hist_original_particles</span> <span class="o">=</span> <span class="n">data_init</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere initial histogram - Original data size: </span><span class="si">{</span><span class="n">hist_original_particles</span><span class="si">}</span><span class="s2">, Histogram sum: </span><span class="si">{</span><span class="n">hist_total_particles</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial histogram statistics: Min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">C_init</span><span class="p">)</span><span class="si">}</span><span class="s2">, Max=</span><span class="si">{</span><span class="n">hist_max</span><span class="si">}</span><span class="s2">, Mean=</span><span class="si">{</span><span class="n">hist_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Non-Zero Bins=</span><span class="si">{</span><span class="n">hist_nonzero</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Calculate robust ranges from histogram data if config available</span>
                    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;use_median_ranges&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">use_median_ranges</span><span class="p">:</span>
                        <span class="c1"># Get unique bin centers - the histogram is a meshgrid</span>
                        <span class="n">r_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X_init</span><span class="p">)</span>  <span class="c1"># Get unique radius values</span>
                        <span class="n">v_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Y_init</span><span class="p">)</span>  <span class="c1"># Get unique velocity values</span>
                        
                        
                        <span class="c1"># Sum histogram counts along axes to get 1D distributions</span>
                        <span class="c1"># From debug: X varies down rows (axis 0), Y varies across columns (axis 1)</span>
                        <span class="c1"># So C[i,j] represents counts at (r_centers[i], v_centers[j])</span>
                        <span class="n">r_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_init</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Sum across columns (v) to get r distribution</span>
                        <span class="n">v_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_init</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Sum across rows (r) to get v distribution</span>
                        
                        <span class="c1"># Calculate robust ranges</span>
                        <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range_from_histogram</span><span class="p">(</span>
                            <span class="n">r_centers</span><span class="p">,</span> <span class="n">r_counts</span><span class="p">,</span> 
                            <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile</span><span class="p">,</span>
                            <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile_multiplier</span><span class="p">,</span>
                            <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_x_range_abs</span><span class="p">,</span>
                            <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;radius (initial nsphere)&quot;</span>
                        <span class="p">)</span>
                        
                        <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range_from_histogram</span><span class="p">(</span>
                            <span class="n">v_centers</span><span class="p">,</span> <span class="n">v_counts</span><span class="p">,</span>
                            <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile</span><span class="p">,</span>
                            <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile_multiplier</span><span class="p">,</span>
                            <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_y_range_abs</span><span class="p">,</span>
                            <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">320.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;velocity (initial nsphere)&quot;</span>
                        <span class="p">)</span>
                        
                        <span class="c1"># For nsphere histograms, cap the range at the actual maximum populated bin</span>
                        <span class="c1"># to avoid showing excessive empty space from the fixed 320 km/s C code range</span>
                        <span class="n">nonzero_v_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_counts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonzero_v_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">max_populated_v</span> <span class="o">=</span> <span class="n">v_centers</span><span class="p">[</span><span class="n">nonzero_v_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">v_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v_max</span><span class="p">,</span> <span class="n">max_populated_v</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">)</span>  <span class="c1"># Allow 5% padding above max populated bin</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Use full data range</span>
                        <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_init</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_init</span><span class="p">)</span>
                        <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Y_init</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y_init</span><span class="p">)</span>
                    
                    <span class="c1"># Find indices within the calculated range limits</span>
                    <span class="n">r_vals</span> <span class="o">=</span> <span class="n">X_init</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Radius values from first row</span>
                    <span class="n">v_vals</span> <span class="o">=</span> <span class="n">Y_init</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Velocity values from first column</span>
                    
                    <span class="c1"># Find indices that fall within our calculated ranges</span>
                    <span class="n">r_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_vals</span> <span class="o">&gt;=</span> <span class="n">r_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r_vals</span> <span class="o">&lt;=</span> <span class="n">r_max</span><span class="p">)</span>
                    <span class="n">v_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_vals</span> <span class="o">&gt;=</span> <span class="n">v_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">v_vals</span> <span class="o">&lt;=</span> <span class="n">v_max</span><span class="p">)</span>
                    
                    <span class="c1"># Trim the data to only include bins within range</span>
                    <span class="n">X_trimmed</span> <span class="o">=</span> <span class="n">X_init</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">v_mask</span><span class="p">,</span> <span class="n">r_mask</span><span class="p">)]</span>
                    <span class="n">Y_trimmed</span> <span class="o">=</span> <span class="n">Y_init</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">v_mask</span><span class="p">,</span> <span class="n">r_mask</span><span class="p">)]</span>
                    <span class="n">C_trimmed</span> <span class="o">=</span> <span class="n">C_init</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">v_mask</span><span class="p">,</span> <span class="n">r_mask</span><span class="p">)]</span>
                    
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
                    <span class="n">pcm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X_trimmed</span><span class="p">,</span> <span class="n">Y_trimmed</span><span class="p">,</span> <span class="n">C_trimmed</span><span class="p">,</span>
                                         <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
                    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Initial Phase Space Distribution (nsphere.c)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>
                    <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/2d_hist_nsphere_initial</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reshaping data from </span><span class="si">{</span><span class="n">hist_initial_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reshaping data from </span><span class="si">{</span><span class="n">hist_initial_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">hist_initial_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">hist_initial_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># Plot nsphere final histogram</span>
    <span class="n">hist_final_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/2d_hist_final</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>

    <span class="c1"># Update progress - checking final file</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;nsphere_histograms_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;checking_final_file&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hist_final_file</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading final histogram data from </span><span class="si">{</span><span class="n">hist_final_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Update progress - loading final data</span>
        <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;nsphere_histograms_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;loading_final_histogram&quot;</span><span class="p">)</span>

        <span class="n">data_final</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
            <span class="n">hist_final_file</span><span class="p">,</span> <span class="n">ncols_hist</span><span class="p">,</span> <span class="n">hist_dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_final</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">hist_final_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">hist_final_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_final</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">160000</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected 160000 entries in </span><span class="si">{</span><span class="n">hist_final_file</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">data_final</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">print_status</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: Expected 160000 entries in </span><span class="si">{</span><span class="n">hist_final_file</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">data_final</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing final histogram data, shape: </span><span class="si">{</span><span class="n">data_final</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">X_final</span> <span class="o">=</span> <span class="n">data_final</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
                    <span class="n">Y_final</span> <span class="o">=</span> <span class="n">data_final</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
                    <span class="n">C_final</span> <span class="o">=</span> <span class="n">data_final</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>

                    <span class="c1"># Calculate statistics for histogram</span>
                    <span class="c1"># Use different variable names for final histogram to avoid overwriting initial values</span>
                    <span class="n">final_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">C_final</span><span class="p">)</span>
                    <span class="n">final_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">C_final</span><span class="p">)</span>
                    <span class="n">final_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_final</span><span class="p">)</span><span class="o">/</span><span class="n">final_nonzero</span> <span class="k">if</span> <span class="n">final_nonzero</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="c1"># Get total particles (sum of all counts)</span>
                    <span class="n">final_total_particles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_final</span><span class="p">)</span>

                    <span class="c1"># Record original data size for debugging</span>
                    <span class="n">final_original_particles</span> <span class="o">=</span> <span class="n">data_final</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final histogram - Original data size: </span><span class="si">{</span><span class="n">final_original_particles</span><span class="si">}</span><span class="s2">, Histogram sum: </span><span class="si">{</span><span class="n">final_total_particles</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final histogram statistics: Min=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">C_final</span><span class="p">)</span><span class="si">}</span><span class="s2">, Max=</span><span class="si">{</span><span class="n">final_max</span><span class="si">}</span><span class="s2">, Mean=</span><span class="si">{</span><span class="n">final_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Non-Zero Bins=</span><span class="si">{</span><span class="n">final_nonzero</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Calculate robust ranges from histogram data if config available</span>
                    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;use_median_ranges&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">use_median_ranges</span><span class="p">:</span>
                        <span class="c1"># Get unique bin centers - the histogram is a meshgrid</span>
                        <span class="n">r_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X_final</span><span class="p">)</span>  <span class="c1"># Get unique radius values</span>
                        <span class="n">v_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Y_final</span><span class="p">)</span>  <span class="c1"># Get unique velocity values</span>
                        
                        
                        <span class="c1"># Sum histogram counts along axes to get 1D distributions</span>
                        <span class="c1"># From debug: X varies down rows (axis 0), Y varies across columns (axis 1)</span>
                        <span class="c1"># So C[i,j] represents counts at (r_centers[i], v_centers[j])</span>
                        <span class="n">r_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_final</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Sum across columns (v) to get r distribution</span>
                        <span class="n">v_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_final</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Sum across rows (r) to get v distribution</span>
                        
                        <span class="c1"># Debug: Check if high-v particles are in C_final</span>
                        <span class="n">total_in_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_final</span><span class="p">)</span>
                        <span class="n">high_v_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_centers</span> <span class="o">&gt;</span> <span class="mi">210</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">particles_above_210_in_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_final</span><span class="p">[</span><span class="n">high_v_indices</span><span class="p">,</span> <span class="p">:])</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final: Total particles in 2D histogram = </span><span class="si">{</span><span class="n">total_in_2d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final: Particles with v&gt;210 in 2D histogram = </span><span class="si">{</span><span class="n">particles_above_210_in_2d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                        <span class="c1"># Find the actual maximum populated velocity bin</span>
                        <span class="n">nonzero_v_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">v_counts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonzero_v_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">max_populated_v_bin</span> <span class="o">=</span> <span class="n">nonzero_v_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">max_populated_v</span> <span class="o">=</span> <span class="n">v_centers</span><span class="p">[</span><span class="n">max_populated_v_bin</span><span class="p">]</span>
                            <span class="n">total_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v_counts</span><span class="p">)</span>
                            <span class="n">high_v_counts_200</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v_counts</span><span class="p">[</span><span class="n">v_centers</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">])</span>  <span class="c1"># Count particles above 200 km/s</span>
                            <span class="n">high_v_counts_210</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v_counts</span><span class="p">[</span><span class="n">v_centers</span> <span class="o">&gt;</span> <span class="mi">210</span><span class="p">])</span>  <span class="c1"># Count particles above 210 km/s</span>
                            <span class="n">high_v_counts_250</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v_counts</span><span class="p">[</span><span class="n">v_centers</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">])</span>  <span class="c1"># Count particles above 250 km/s</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final: Maximum populated velocity bin at </span><span class="si">{</span><span class="n">max_populated_v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final: Total particles = </span><span class="si">{</span><span class="n">total_counts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final: particles &gt; 200 km/s = </span><span class="si">{</span><span class="n">high_v_counts_200</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">high_v_counts_200</span><span class="o">/</span><span class="n">total_counts</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final: particles &gt; 210 km/s = </span><span class="si">{</span><span class="n">high_v_counts_210</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">high_v_counts_210</span><span class="o">/</span><span class="n">total_counts</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final: particles &gt; 250 km/s = </span><span class="si">{</span><span class="n">high_v_counts_250</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">high_v_counts_250</span><span class="o">/</span><span class="n">total_counts</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
                            
                            <span class="c1"># Check WHERE the high-velocity particles are in radius</span>
                            <span class="n">high_v_mask</span> <span class="o">=</span> <span class="n">v_centers</span> <span class="o">&gt;</span> <span class="mi">210</span>
                            <span class="c1"># Check within displayed range (r &lt; 120 kpc)</span>
                            <span class="n">displayed_r_mask</span> <span class="o">=</span> <span class="n">r_centers</span> <span class="o">&lt;</span> <span class="mi">120</span>
                            <span class="n">high_v_displayed_count</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">high_v_outside_count</span> <span class="o">=</span> <span class="mi">0</span>
                            
                            <span class="k">for</span> <span class="n">r_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_centers</span><span class="p">)):</span>
                                <span class="k">for</span> <span class="n">v_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">high_v_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="k">if</span> <span class="n">C_final</span><span class="p">[</span><span class="n">v_idx</span><span class="p">,</span> <span class="n">r_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">displayed_r_mask</span><span class="p">[</span><span class="n">r_idx</span><span class="p">]:</span>
                                            <span class="n">high_v_displayed_count</span> <span class="o">+=</span> <span class="n">C_final</span><span class="p">[</span><span class="n">v_idx</span><span class="p">,</span> <span class="n">r_idx</span><span class="p">]</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">high_v_outside_count</span> <span class="o">+=</span> <span class="n">C_final</span><span class="p">[</span><span class="n">v_idx</span><span class="p">,</span> <span class="n">r_idx</span><span class="p">]</span>
                            
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final: High-v particles (&gt;210 km/s) within r&lt;120 kpc = </span><span class="si">{</span><span class="n">high_v_displayed_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final: High-v particles (&gt;210 km/s) at r&gt;120 kpc = </span><span class="si">{</span><span class="n">high_v_outside_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
                            <span class="c1"># Find which radius bins contain the high-v particles</span>
                            <span class="n">high_v_by_radius</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">r_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r_centers</span><span class="p">)):</span>
                                <span class="n">count_at_r</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">for</span> <span class="n">v_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">high_v_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="n">count_at_r</span> <span class="o">+=</span> <span class="n">C_final</span><span class="p">[</span><span class="n">v_idx</span><span class="p">,</span> <span class="n">r_idx</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">count_at_r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">high_v_by_radius</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r_centers</span><span class="p">[</span><span class="n">r_idx</span><span class="p">],</span> <span class="n">count_at_r</span><span class="p">))</span>
                            
                            <span class="c1"># Sort by count and show top 5</span>
                            <span class="n">high_v_by_radius</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;NSphere final: Top 5 radius bins with high-v particles (&gt;210 km/s):&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">high_v_by_radius</span><span class="p">[:</span><span class="mi">5</span><span class="p">]):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  r=</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> kpc: </span><span class="si">{</span><span class="n">count</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> particles&quot;</span><span class="p">)</span>
                            
                            <span class="c1"># Check velocity distribution at r~55 kpc</span>
                            <span class="n">r_55_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r_centers</span> <span class="o">-</span> <span class="mf">55.0</span><span class="p">))</span>
                            <span class="n">v_dist_at_55</span> <span class="o">=</span> <span class="n">C_final</span><span class="p">[:,</span> <span class="n">r_55_idx</span><span class="p">]</span>
                            <span class="n">nonzero_v_at_55</span> <span class="o">=</span> <span class="n">v_centers</span><span class="p">[</span><span class="n">v_dist_at_55</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                            <span class="n">counts_at_55</span> <span class="o">=</span> <span class="n">v_dist_at_55</span><span class="p">[</span><span class="n">v_dist_at_55</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                            
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonzero_v_at_55</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1"># Reconstruct distribution for percentile calculation</span>
                                <span class="n">v_values_at_55</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">nonzero_v_at_55</span><span class="p">,</span> <span class="n">counts_at_55</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                                <span class="n">v_95_at_55</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">v_values_at_55</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
                                <span class="n">v_max_at_55</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nonzero_v_at_55</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final: At r=</span><span class="si">{</span><span class="n">r_centers</span><span class="p">[</span><span class="n">r_55_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> kpc:&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total particles: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts_at_55</span><span class="p">)</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  95th percentile velocity: </span><span class="si">{</span><span class="n">v_95_at_55</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Maximum velocity: </span><span class="si">{</span><span class="n">v_max_at_55</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">)</span>
                        
                        <span class="c1"># Calculate robust ranges</span>
                        <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range_from_histogram</span><span class="p">(</span>
                            <span class="n">r_centers</span><span class="p">,</span> <span class="n">r_counts</span><span class="p">,</span> 
                            <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile</span><span class="p">,</span>
                            <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile_multiplier</span><span class="p">,</span>
                            <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_x_range_abs</span><span class="p">,</span>
                            <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;radius (final nsphere)&quot;</span>
                        <span class="p">)</span>
                        
                        <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range_from_histogram</span><span class="p">(</span>
                            <span class="n">v_centers</span><span class="p">,</span> <span class="n">v_counts</span><span class="p">,</span>
                            <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile</span><span class="p">,</span>
                            <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile_multiplier</span><span class="p">,</span>
                            <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_y_range_abs</span><span class="p">,</span>
                            <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">320.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;velocity (final nsphere)&quot;</span>
                        <span class="p">)</span>
                        
                        <span class="c1"># For nsphere histograms, cap the range at the actual maximum populated bin</span>
                        <span class="c1"># to avoid showing excessive empty space from the fixed 320 km/s C code range</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonzero_v_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">max_populated_v</span> <span class="o">=</span> <span class="n">v_centers</span><span class="p">[</span><span class="n">nonzero_v_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">v_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v_max</span><span class="p">,</span> <span class="n">max_populated_v</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">)</span>  <span class="c1"># Allow 5% padding above max populated bin</span>
                        
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere final histogram velocity range: [</span><span class="si">{</span><span class="n">v_min</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">v_max</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] km/s&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Use full data range</span>
                        <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_final</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_final</span><span class="p">)</span>
                        <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Y_final</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y_final</span><span class="p">)</span>
                    
                    <span class="c1"># Find indices within the calculated range limits</span>
                    <span class="n">r_vals</span> <span class="o">=</span> <span class="n">X_final</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Radius values from first row</span>
                    <span class="n">v_vals</span> <span class="o">=</span> <span class="n">Y_final</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Velocity values from first column</span>
                    
                    <span class="c1"># Find indices that fall within our calculated ranges</span>
                    <span class="n">r_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_vals</span> <span class="o">&gt;=</span> <span class="n">r_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r_vals</span> <span class="o">&lt;=</span> <span class="n">r_max</span><span class="p">)</span>
                    <span class="n">v_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_vals</span> <span class="o">&gt;=</span> <span class="n">v_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">v_vals</span> <span class="o">&lt;=</span> <span class="n">v_max</span><span class="p">)</span>
                    
                    <span class="c1"># Trim the data to only include bins within range</span>
                    <span class="n">X_trimmed</span> <span class="o">=</span> <span class="n">X_final</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">v_mask</span><span class="p">,</span> <span class="n">r_mask</span><span class="p">)]</span>
                    <span class="n">Y_trimmed</span> <span class="o">=</span> <span class="n">Y_final</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">v_mask</span><span class="p">,</span> <span class="n">r_mask</span><span class="p">)]</span>
                    <span class="n">C_trimmed</span> <span class="o">=</span> <span class="n">C_final</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">v_mask</span><span class="p">,</span> <span class="n">r_mask</span><span class="p">)]</span>
                    
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
                    <span class="n">pcm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X_trimmed</span><span class="p">,</span> <span class="n">Y_trimmed</span><span class="p">,</span> <span class="n">C_trimmed</span><span class="p">,</span>
                                         <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
                    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Final Phase Space Distribution (nsphere.c)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>
                    <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/2d_hist_nsphere_final</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reshaping data from </span><span class="si">{</span><span class="n">hist_final_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reshaping data from </span><span class="si">{</span><span class="n">hist_final_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">hist_final_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">hist_final_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="c1"># Print histogram statistics to console for valid data</span>
    <span class="k">if</span> <span class="s1">&#39;hist_max&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;hist_nonzero&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;hist_mean&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;NSphere histogram statistics:&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Data: Max. Value = </span><span class="si">{</span><span class="n">hist_max</span><span class="si">}</span><span class="s2">, Non-Zero Bins = </span><span class="si">{</span><span class="n">hist_nonzero</span><span class="si">}</span><span class="s2">, Mean Value (Non-Zero) = </span><span class="si">{</span><span class="n">hist_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Only log the particle counts to the log file</span>
        <span class="k">if</span> <span class="n">enable_logging</span> <span class="ow">and</span> <span class="s1">&#39;hist_total_particles&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;hist_original_particles&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere Initial: Original Size = </span><span class="si">{</span><span class="n">hist_original_particles</span><span class="si">}</span><span class="s2">, Total Particles = </span><span class="si">{</span><span class="n">hist_total_particles</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;final_max&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;final_nonzero&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;final_mean&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Data:   Max. Value = </span><span class="si">{</span><span class="n">final_max</span><span class="si">}</span><span class="s2">, Non-Zero Bins = </span><span class="si">{</span><span class="n">final_nonzero</span><span class="si">}</span><span class="s2">, Mean Value (Non-Zero) = </span><span class="si">{</span><span class="n">final_mean</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Only log the particle counts to the log file</span>
            <span class="k">if</span> <span class="n">enable_logging</span> <span class="ow">and</span> <span class="s1">&#39;final_total_particles&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;final_original_particles&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSphere Final: Original Size = </span><span class="si">{</span><span class="n">final_original_particles</span><span class="si">}</span><span class="s2">, Total Particles = </span><span class="si">{</span><span class="n">final_total_particles</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add separator line after statistics</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># The particles histogram statistics are now displayed in the main histogram statistics section</span>

    <span class="c1"># Once data loading is complete, start plot saving progress if needed</span>
    <span class="k">if</span> <span class="n">output_files</span><span class="p">:</span>
        <span class="c1"># Start a new progress tracker for saving plots</span>
        <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;nsphere_histograms_plots&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_files</span><span class="p">))</span>

    <span class="c1"># Log generated plots with progress indication</span>
    <span class="k">if</span> <span class="n">progress_callback</span><span class="p">:</span>
        <span class="c1"># Use progress callback for unified progress tracking</span>
        <span class="k">for</span> <span class="n">output_file</span> <span class="ow">in</span> <span class="n">output_files</span><span class="p">:</span>
            <span class="n">progress_callback</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback to standard progress tracking</span>
        <span class="k">for</span> <span class="n">output_file</span> <span class="ow">in</span> <span class="n">output_files</span><span class="p">:</span>
            <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;nsphere_histograms_plots&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span></div>



<span class="c1"># Storage for tracked particle IDs used in energy analysis</span>
<span class="n">tracked_ids_for_energy</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Helper function to process each file with tracked particle IDs for energy-time plot</span>
<div class="viewcode-block" id="process_sorted_energy_file">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_sorted_energy_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_sorted_energy_file</span><span class="p">(</span><span class="n">task_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process an unsorted rank file for energy-time plot, extracting data for specific tracked particle IDs.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    task_data : tuple</span>
<span class="sd">        A tuple containing (fname, local_suffix) where:</span>
<span class="sd">        - fname is the path to the unsorted Rank data file</span>
<span class="sd">        - local_suffix is the suffix for file identification</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple or None</span>
<span class="sd">        (snapshot_number, energy_data) if successful or None if there was an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Unpack arguments</span>
    <span class="n">fname</span><span class="p">,</span> <span class="n">local_suffix</span> <span class="o">=</span> <span class="n">task_data</span>
    <span class="k">global</span> <span class="n">ncol_Rank_Mass_Rad_VRad_unsorted</span>

    <span class="c1"># Use the suffix-aware helper</span>
    <span class="n">snap</span> <span class="o">=</span> <span class="n">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">local_suffix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">snap</span> <span class="o">==</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regex failed for sorted energy file </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> with suffix &#39;</span><span class="si">{</span><span class="n">local_suffix</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Reload tracked IDs inside the worker</span>
    <span class="n">lowest_radius_ids_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/lowest_radius_ids</span><span class="si">{</span><span class="n">local_suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
    <span class="n">id_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">lowest_radius_ids_file</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">id_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Worker failed to load IDs from </span><span class="si">{</span><span class="n">lowest_radius_ids_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
         <span class="k">return</span> <span class="kc">None</span>
    <span class="n">max_particles</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">id_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">local_tracked_ids</span> <span class="o">=</span> <span class="n">id_data</span><span class="p">[:</span><span class="n">max_particles</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Use helper function to load data for specific particle IDs</span>
    <span class="n">tracked_energy_data</span> <span class="o">=</span> <span class="n">safe_load_particle_ids_bin</span><span class="p">(</span>
        <span class="n">fname</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncol_Rank_Mass_Rad_VRad_unsorted</span><span class="p">,</span> <span class="n">particle_ids</span><span class="o">=</span><span class="n">local_tracked_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">tracked_energy_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tracked_energy_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">tracked_energy_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<span class="c1"># Helper function for phase space plotting</span>
<div class="viewcode-block" id="phase_space_process_rank_file">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.phase_space_process_rank_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">phase_space_process_rank_file</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a single sorted Rank file for phase space plotting.</span>

<span class="sd">    Extracts snapshot number and reads data using the appropriate</span>
<span class="sd">    data types and safe loader.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        The filename of the sorted Rank file to process.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple or None</span>
<span class="sd">        (snapshot_number, data) if successful, otherwise None.</span>
<span class="sd">        &#39;data&#39; is a structured numpy array containing the file contents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use the suffix-aware helper</span>
    <span class="n">snap</span> <span class="o">=</span> <span class="n">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">snap</span> <span class="o">==</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Constants for the expected number of columns</span>
    <span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="c1"># Read the sorted file using safe loader</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_unsorted_rank_file">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_unsorted_rank_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_unsorted_rank_file</span><span class="p">(</span><span class="n">task_data_with_suffix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process an unsorted rank file and return the snapshot number and energy values.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    task_data_with_suffix : tuple</span>
<span class="sd">        A tuple containing (fname, project_root_path, local_suffix) where:</span>
<span class="sd">        - fname is the path to the unsorted Rank data file</span>
<span class="sd">        - project_root_path is the explicit path to the project root directory</span>
<span class="sd">        - local_suffix is the suffix for file identification</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple or None</span>
<span class="sd">        (snapshot_number, energy_values) if successful or None if there was an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Unpack arguments</span>
    <span class="n">fname</span><span class="p">,</span> <span class="n">project_root_path</span><span class="p">,</span> <span class="n">local_suffix</span> <span class="o">=</span> <span class="n">task_data_with_suffix</span>
    
    <span class="c1"># Use the suffix-aware helper</span>
    <span class="n">snap</span> <span class="o">=</span> <span class="n">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">local_suffix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">snap</span> <span class="o">==</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Regex failed for unsorted file </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> with suffix &#39;</span><span class="si">{</span><span class="n">local_suffix</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Constants for the expected number of columns</span>
    <span class="n">ncol</span> <span class="o">=</span> <span class="n">ncol_Rank_Mass_Rad_VRad_unsorted</span> <span class="c1"># Should be 7</span>

    <span class="c1"># --- Start: Optimized Seek-Based Read Logic ---</span>
    <span class="c1"># Get IDs for the first 10 particles</span>
    <span class="n">num_particles_to_get</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">particle_ids_to_get</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_particles_to_get</span><span class="p">))</span>

    <span class="c1"># Use safe_load_particle_ids_bin which uses seek for basic dtypes</span>
    <span class="c1"># Pass np.float32 to ensure it takes the optimized path</span>
    <span class="n">data_subset</span> <span class="o">=</span> <span class="n">safe_load_particle_ids_bin</span><span class="p">(</span>
        <span class="n">fname</span><span class="p">,</span>
        <span class="n">ncols</span><span class="o">=</span><span class="n">ncol</span><span class="p">,</span>
        <span class="n">particle_ids</span><span class="o">=</span><span class="n">particle_ids_to_get</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="c1"># IMPORTANT: Use basic dtype for seek path</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">data_subset</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data_subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Extract Energy (column 5) from the loaded subset</span>
    <span class="c1"># Handle cases where fewer than 10 particles were actually found (rows might contain NaN)</span>
    <span class="c1"># We only want valid energy values</span>
    <span class="n">valid_energy_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_subset</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">E_values</span> <span class="o">=</span> <span class="n">data_subset</span><span class="p">[</span><span class="n">valid_energy_mask</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">E_values</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># --- End: Optimized Seek-Based Read Logic ---</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">E_values</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_sorted_energy">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_sorted_energy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_sorted_energy</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a rank file for energy plots. This function extracts energy values for</span>
<span class="sd">    specific particles based on their IDs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        The filename to process.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple or None</span>
<span class="sd">        (snapshot_number, energy_values) if successful or None if there was an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use the suffix-aware helper</span>
    <span class="n">snap</span> <span class="o">=</span> <span class="n">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">snap</span> <span class="o">==</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Load the particle IDs to track (particles with lowest initial radius)</span>
    <span class="n">lowest_radius_ids_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/lowest_radius_ids</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>

    <span class="c1"># Load the lowest_radius_ids file using the binary file handler</span>
    <span class="n">id_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">lowest_radius_ids_file</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">id_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load particle IDs from </span><span class="si">{</span><span class="n">lowest_radius_ids_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Extract the first 10 particles to track (or fewer if less available)</span>
    <span class="n">max_particles</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">id_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">tracked_ids</span> <span class="o">=</span> <span class="n">id_data</span><span class="p">[:</span><span class="n">max_particles</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># Convert to integers for use as indices</span>

    <span class="c1"># Now find the corresponding unsorted file for this snapshot</span>
    <span class="n">unsorted_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/Rank_Mass_Rad_VRad_unsorted_t</span><span class="si">{</span><span class="n">snap</span><span class="si">:</span><span class="s2">05d</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">unsorted_fname</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Use helper function to load data for specific particle IDs</span>
    <span class="n">tracked_energy_data</span> <span class="o">=</span> <span class="n">safe_load_particle_ids_bin</span><span class="p">(</span>
        <span class="n">unsorted_fname</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncol_Rank_Mass_Rad_VRad_unsorted</span><span class="p">,</span> <span class="n">particle_ids</span><span class="o">=</span><span class="n">tracked_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">tracked_energy_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tracked_energy_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Extract energy values (column 5)</span>
    <span class="n">energy_values</span> <span class="o">=</span> <span class="n">tracked_energy_data</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">energy_values</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_rank_file">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_rank_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_rank_file</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a rank file and return the snapshot number and decimated data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        The filename to process.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple or None</span>
<span class="sd">        (snapshot_number, decimated_data) if successful or None if there was an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use the suffix-aware helper</span>
    <span class="n">snap</span> <span class="o">=</span> <span class="n">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">snap</span> <span class="o">==</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Read the file using the safe loader</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span><span class="p">,</span>
                                  <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data to process in </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># Process the data</span>
    <span class="n">decimated</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">del</span> <span class="n">data</span>  <span class="c1"># Free full-resolution data</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">decimated</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_rank_file_for_1d_anim">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_rank_file_for_1d_anim">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_rank_file_for_1d_anim</span><span class="p">(</span><span class="n">task_data_with_suffix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes a single sorted Rank snapshot file for 1D animations.</span>
<span class="sd">    Now accepts suffix explicitly.</span>

<span class="sd">    Loads only the required columns (Mass, Radius, Psi, Density), sorts by</span>
<span class="sd">    radius, filters invalid data, fits linear splines to Mass, Psi and Density,</span>
<span class="sd">    performs downsampling to a common radius grid, and returns the processed data</span>
<span class="sd">    ready for animation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    task_data_with_suffix : tuple</span>
<span class="sd">        A tuple containing (fname, project_root_path, local_suffix) where:</span>
<span class="sd">        - fname is the path to the sorted Rank data file</span>
<span class="sd">        - project_root_path is the explicit path to the project root directory</span>
<span class="sd">        - local_suffix is the suffix for file identification</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple or None</span>
<span class="sd">        On success, returns a tuple:</span>
<span class="sd">        (snap_num, sampled_radii, sampled_mass, sampled_density, sampled_psi)</span>
<span class="sd">        where arrays have the downsampled length.</span>
<span class="sd">        Returns None if loading, processing, or spline fitting fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Unpack arguments including the suffix</span>
    <span class="n">fname</span><span class="p">,</span> <span class="n">project_root_path</span><span class="p">,</span> <span class="n">local_suffix</span> <span class="o">=</span> <span class="n">task_data_with_suffix</span>
    <span class="c1"># No longer need: global suffix</span>
    <span class="k">global</span> <span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span> <span class="c1"># Keep this global if needed elsewhere in function</span>
    
    <span class="c1"># Define the dtype list for the *entire* row of the sorted file</span>
    <span class="n">sorted_rank_dtype_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>

    <span class="c1"># Columns needed: Radius (2, sort key), Mass (1), Psi (4), Density (7)</span>
    <span class="c1"># Indices passed to loader must be sorted for some selection methods</span>
    <span class="n">cols_to_load_indices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
    <span class="c1"># Map back to original meaning after loading</span>
    <span class="n">load_idx_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span> <span class="c1"># Original Col -&gt; Index in loaded data</span>
    <span class="n">radius_load_idx</span> <span class="o">=</span> <span class="n">load_idx_map</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># Index of Radius within loaded data</span>

    <span class="c1"># Extract snapshot number from filename</span>
    <span class="n">snap_num</span> <span class="o">=</span> <span class="n">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">local_suffix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">snap_num</span> <span class="o">==</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract valid snapshot number from </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> using suffix &#39;</span><span class="si">{</span><span class="n">local_suffix</span><span class="si">}</span><span class="s2">&#39; for 1D anim. Skipping.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load only the necessary columns</span>
        <span class="n">loaded_cols</span> <span class="o">=</span> <span class="n">load_specific_columns_bin</span><span class="p">(</span>
            <span class="n">fname</span><span class="p">,</span>
            <span class="n">ncols_total</span><span class="o">=</span><span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span><span class="p">,</span> <span class="c1"># Total cols in file (8)</span>
            <span class="n">cols_to_load</span><span class="o">=</span><span class="n">cols_to_load_indices</span><span class="p">,</span>
            <span class="n">dtype_list</span><span class="o">=</span><span class="n">sorted_rank_dtype_list</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">loaded_cols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded_cols</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols_to_load_indices</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load required columns for snap </span><span class="si">{</span><span class="n">snap_num</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Combine into a temporary array for sorting/filtering</span>
        <span class="c1"># Order: Mass, Radius, Psi, Density (based on sorted cols_to_load_indices)</span>
        <span class="n">temp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">loaded_cols</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">loaded_cols</span> <span class="c1"># Free memory</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Sort by Radius (which is at index radius_load_idx)</span>
        <span class="n">sort_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">temp_data</span><span class="p">[:,</span> <span class="n">radius_load_idx</span><span class="p">])</span>
        <span class="n">temp_data_sorted</span> <span class="o">=</span> <span class="n">temp_data</span><span class="p">[</span><span class="n">sort_indices</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">del</span> <span class="n">temp_data</span><span class="p">,</span> <span class="n">sort_indices</span> <span class="c1"># Free memory</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Separate columns after sorting</span>
        <span class="n">radius_sorted</span> <span class="o">=</span> <span class="n">temp_data_sorted</span><span class="p">[:,</span> <span class="n">radius_load_idx</span><span class="p">]</span>
        <span class="n">mass_sorted</span> <span class="o">=</span> <span class="n">temp_data_sorted</span><span class="p">[:,</span> <span class="n">load_idx_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">psi_sorted</span> <span class="o">=</span> <span class="n">temp_data_sorted</span><span class="p">[:,</span> <span class="n">load_idx_map</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
        <span class="n">density_sorted</span> <span class="o">=</span> <span class="n">temp_data_sorted</span><span class="p">[:,</span> <span class="n">load_idx_map</span><span class="p">[</span><span class="mi">7</span><span class="p">]]</span>
        <span class="k">del</span> <span class="n">temp_data_sorted</span> <span class="c1"># Free memory</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

        <span class="c1"># Filter out duplicates in radius (needed for spline) and non-finite values</span>
        <span class="n">unique_radii</span><span class="p">,</span> <span class="n">unique_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">radius_sorted</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Keep only data corresponding to unique radii</span>
        <span class="n">radius_unique</span> <span class="o">=</span> <span class="n">unique_radii</span>
        <span class="n">mass_unique</span> <span class="o">=</span> <span class="n">mass_sorted</span><span class="p">[</span><span class="n">unique_indices</span><span class="p">]</span>
        <span class="n">psi_unique</span> <span class="o">=</span> <span class="n">psi_sorted</span><span class="p">[</span><span class="n">unique_indices</span><span class="p">]</span>
        <span class="n">density_unique</span> <span class="o">=</span> <span class="n">density_sorted</span><span class="p">[</span><span class="n">unique_indices</span><span class="p">]</span>

        <span class="c1"># Filter for finite values in all arrays</span>
        <span class="n">finite_mask</span> <span class="o">=</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">radius_unique</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mass_unique</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">psi_unique</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">density_unique</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">finite_mask</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No finite data after filtering for snap </span><span class="si">{</span><span class="n">snap_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">radius_final</span> <span class="o">=</span> <span class="n">radius_unique</span><span class="p">[</span><span class="n">finite_mask</span><span class="p">]</span>
        <span class="n">mass_final</span> <span class="o">=</span> <span class="n">mass_unique</span><span class="p">[</span><span class="n">finite_mask</span><span class="p">]</span>
        <span class="n">psi_final</span> <span class="o">=</span> <span class="n">psi_unique</span><span class="p">[</span><span class="n">finite_mask</span><span class="p">]</span>
        <span class="n">density_final</span> <span class="o">=</span> <span class="n">density_unique</span><span class="p">[</span><span class="n">finite_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radius_final</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="c1"># Need enough points for spline</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too few points (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">radius_final</span><span class="p">)</span><span class="si">}</span><span class="s2">) for spline fitting snap </span><span class="si">{</span><span class="n">snap_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># --- Spline Fitting ---</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use k=1 for linear interpolation, s=0 to force interpolation</span>
            <span class="n">spl_mass</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">radius_final</span><span class="p">,</span> <span class="n">mass_final</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span>
            <span class="n">spl_psi</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">radius_final</span><span class="p">,</span> <span class="n">psi_final</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span>
            <span class="n">spl_density</span> <span class="o">=</span> <span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">radius_final</span><span class="p">,</span> <span class="n">density_final</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;raise&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">spline_e</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spline fitting failed for snap </span><span class="si">{</span><span class="n">snap_num</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">spline_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="k">return</span> <span class="kc">None</span>


        <span class="c1"># --- Downsampling ---</span>
        <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">radius_final</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">radius_final</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1"># Ensure min/max reasonable</span>
        <span class="k">if</span> <span class="n">r_min</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">r_max</span> <span class="o">&lt;=</span> <span class="n">r_min</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid radius range [</span><span class="si">{</span><span class="n">r_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">r_max</span><span class="si">}</span><span class="s2">] for snap </span><span class="si">{</span><span class="n">snap_num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="k">return</span> <span class="kc">None</span>

        <span class="n">n_particles_approx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">radius_final</span><span class="p">)</span> <span class="c1"># Use length after filtering</span>
        <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_particles_approx</span> <span class="o">/</span> <span class="mi">100</span><span class="p">),</span> <span class="mi">10000</span><span class="p">)</span> <span class="c1"># Downsample factor 100, min 10k points</span>

        <span class="n">sampled_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>

        <span class="c1"># --- Evaluate Splines ---</span>
        <span class="n">sampled_mass</span> <span class="o">=</span> <span class="n">spl_mass</span><span class="p">(</span><span class="n">sampled_radii</span><span class="p">)</span>
        <span class="n">sampled_psi</span> <span class="o">=</span> <span class="n">spl_psi</span><span class="p">(</span><span class="n">sampled_radii</span><span class="p">)</span>
        <span class="n">sampled_density</span> <span class="o">=</span> <span class="n">spl_density</span><span class="p">(</span><span class="n">sampled_radii</span><span class="p">)</span>

        <span class="c1"># Return the downsampled data</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">snap_num</span><span class="p">,</span> <span class="n">sampled_radii</span><span class="p">,</span> <span class="n">sampled_mass</span><span class="p">,</span> <span class="n">sampled_density</span><span class="p">,</span> <span class="n">sampled_psi</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> for 1D anim: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span> <span class="c1"># Cleanup worker memory</span></div>


<div class="viewcode-block" id="preprocess_phase_space_file">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.preprocess_phase_space_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">preprocess_phase_space_file</span><span class="p">(</span><span class="n">rank_file_data_with_suffix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocess a single Rank file for phase space animation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rank_file_data_with_suffix : tuple</span>
<span class="sd">        Tuple containing (rank_file, placeholder, ncol, max_r_all, max_v_all, nbins, </span>
<span class="sd">        kmsec_to_kpcmyr, project_root_path, local_suffix).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple or None</span>
<span class="sd">        (snap_num, H, frame_vmax) if successful or None if processing failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Unpack arguments including the suffix</span>
    <span class="n">rank_file</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">max_r_all</span><span class="p">,</span> <span class="n">max_v_all</span><span class="p">,</span> <span class="n">nbins</span><span class="p">,</span> <span class="n">kmsec_to_kpcmyr</span><span class="p">,</span> <span class="n">project_root_path</span><span class="p">,</span> <span class="n">local_suffix</span> <span class="o">=</span> <span class="n">rank_file_data_with_suffix</span>

    <span class="c1"># Extract snapshot number for labeling</span>
    <span class="n">snap_num</span> <span class="o">=</span> <span class="n">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">rank_file</span><span class="p">,</span> <span class="n">local_suffix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">snap_num</span> <span class="o">==</span> <span class="mi">999999999</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract valid snapshot number from </span><span class="si">{</span><span class="n">rank_file</span><span class="si">}</span><span class="s2"> using suffix &#39;</span><span class="si">{</span><span class="n">local_suffix</span><span class="si">}</span><span class="s2">&#39; for phase space. Skipping.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Load the snapshot data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">rank_file</span><span class="p">,</span>
        <span class="n">ncol</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Extract radius and velocity data from sorted data with columns:</span>
    <span class="c1"># Rank(0), Mass(1), Radius(2), Vrad(3), Psi(4), Energy(5), L(6), Density(7)</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>          <span class="c1"># Column index 2 holds radius (r) - simulation units</span>
    <span class="n">radial_velocity</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Column index 3 holds radial velocity (v_r) - simulation units</span>
    <span class="n">angular_momentum</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># Column index 6 holds angular momentum (L) - simulation units</span>

    <span class="c1"># Filter out non-positive radii to avoid division by zero</span>
    <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">radii</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">radial_velocity</span> <span class="o">=</span> <span class="n">radial_velocity</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">angular_momentum</span> <span class="o">=</span> <span class="n">angular_momentum</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>

    <span class="c1"># Skip if not enough data points</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Compute the total velocity - ALL IN SIMULATION UNITS</span>
    <span class="c1"># v_total_sim = sqrt((L/r)^2 + v_r^2)</span>
    <span class="n">tangential_velocity_sim</span> <span class="o">=</span> <span class="n">angular_momentum</span> <span class="o">/</span> <span class="n">radii</span>  <span class="c1"># Tangential velocity in simulation units</span>
    <span class="n">total_velocity_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tangential_velocity_sim</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">radial_velocity</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Total velocity in simulation units</span>

    <span class="c1"># Convert to km/s at the end</span>
    <span class="n">total_velocity</span> <span class="o">=</span> <span class="n">total_velocity_sim</span> <span class="o">/</span> <span class="n">kmsec_to_kpcmyr</span>  <span class="c1"># Convert to km/s</span>

    <span class="c1"># Filter out extreme values for visualization</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_velocity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">total_velocity</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">)</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
    <span class="n">total_velocity</span> <span class="o">=</span> <span class="n">total_velocity</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

    <span class="c1"># Skip if not enough valid data points</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Create the 2D histogram</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span>
        <span class="n">radii</span><span class="p">,</span>
        <span class="n">total_velocity</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">nbins</span><span class="p">,</span> <span class="n">nbins</span><span class="p">],</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_r_all</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_v_all</span><span class="p">]]</span>
    <span class="p">)</span>

    <span class="c1"># Calculate a reasonable vmax for the frame</span>
    <span class="n">frame_vmax</span> <span class="o">=</span> <span class="n">calculate_reasonable_vmax</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>

    <span class="c1"># Clean up memory before returning</span>
    <span class="k">del</span> <span class="n">radii</span><span class="p">,</span> <span class="n">total_velocity</span><span class="p">,</span> <span class="n">radial_velocity</span><span class="p">,</span> <span class="n">angular_momentum</span><span class="p">,</span> <span class="n">data</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">snap_num</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">frame_vmax</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_phase_space_animation">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.generate_phase_space_animation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_phase_space_animation</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an animation showing the evolution of the phase space distribution over time.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : object</span>
<span class="sd">        Configuration object containing suffix and plot settings.</span>
<span class="sd">    fps : int, optional</span>
<span class="sd">        Frames per second for the animation, by default 10.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if animation was created successfully, False otherwise.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses parallel processing for preprocessing histogram data and rendering frames.</span>
<span class="sd">    Saves the animation incrementally using `imageio.get_writer` to reduce</span>
<span class="sd">    peak memory usage compared to collecting all frames first.</span>
<span class="sd">    Requires imageio v2 (`pip install imageio==2.*`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find all Rank sorted files with the exact suffix</span>
    <span class="n">rank_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data/Rank_Mass_Rad_VRad_sorted_t*</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">)</span>

    <span class="c1"># Filter to keep ONLY files that match the exact pattern:</span>
    <span class="c1"># data/Rank_Mass_Rad_VRad_sorted_t00001_40000_1001_5.dat</span>
    <span class="c1"># without any extra characters between &quot;t00001&quot; and the suffix</span>
    <span class="n">correct_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;data/Rank_Mass_Rad_VRad_sorted_t\d+&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\.dat$&#39;</span><span class="p">)</span>
    <span class="n">rank_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">rank_files</span> <span class="k">if</span> <span class="n">correct_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>

    <span class="c1"># Debug output</span>
    <span class="k">global</span> <span class="n">enable_logging</span>
    <span class="k">if</span> <span class="n">enable_logging</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rank_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> rank files with pattern: data/Rank_Mass_Rad_VRad_sorted_t*</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat (after filtering)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rank_files</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No Rank sorted files found. Cannot create phase space animation.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Sort files by snapshot number to ensure correct animation sequence</span>
    <span class="n">rank_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">fname</span><span class="p">:</span> <span class="n">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">))</span>

    <span class="c1"># Log the exact file count (to log file only)</span>
    <span class="n">file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rank_files</span><span class="p">)</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">file_count</span><span class="si">}</span><span class="s2"> rank files for phase space animation.&quot;</span><span class="p">)</span>

    <span class="c1"># For debugging - list the first few files</span>
    <span class="k">if</span> <span class="n">file_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Example files (first 3): </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rank_files</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Constants</span>
    <span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># This remains a file structure constant</span>
    <span class="n">kmsec_to_kpcmyr_local</span> <span class="o">=</span> <span class="n">kmsec_to_kpcmyr</span> <span class="c1"># Use the global kmsec_to_kpcmyr</span>

    <span class="c1"># Default histogram parameters (used if not median-based or if median calc fails)</span>
    <span class="n">default_max_r_anim</span> <span class="o">=</span> <span class="mf">250.0</span>
    <span class="n">default_max_v_anim</span> <span class="o">=</span> <span class="mf">320.0</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1"># Keep nbins fixed for now</span>

    <span class="c1"># Initialize ranges to defaults</span>
    <span class="n">current_plot_range_r_anim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">default_max_r_anim</span><span class="p">)</span>
    <span class="n">current_plot_range_v_anim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">default_max_v_anim</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;use_median_ranges&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">use_median_ranges</span><span class="p">:</span>
        <span class="c1"># Determine a subset of files for range calculation if too many</span>
        <span class="c1"># For example, take a sample or first/last N files.</span>
        <span class="c1"># Here, using all filtered rank_files, but could be refined.</span>
        <span class="n">files_for_range_calc</span> <span class="o">=</span> <span class="n">rank_files</span> 
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_for_range_calc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span> <span class="c1"># Heuristic: if more than 50 files, sample ~20-30%</span>
             <span class="n">sample_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files_for_range_calc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">))</span>
             <span class="n">files_for_range_calc</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">files_for_range_calc</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>


        <span class="n">r_range_tuple</span><span class="p">,</span> <span class="n">v_range_tuple</span> <span class="o">=</span> <span class="n">_calculate_global_animation_ranges</span><span class="p">(</span>
            <span class="n">rank_files_subset</span><span class="o">=</span><span class="n">files_for_range_calc</span><span class="p">,</span>
            <span class="n">r_min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_x_range_abs</span><span class="p">,</span>
            <span class="n">v_min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_y_range_abs</span><span class="p">,</span>
            <span class="n">r_default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">default_max_r_anim</span><span class="p">),</span>
            <span class="n">v_default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">default_max_v_anim</span><span class="p">),</span>
            <span class="n">kmsec_to_kpcmyr</span><span class="o">=</span><span class="n">kmsec_to_kpcmyr_local</span><span class="p">,</span>
            <span class="n">current_suffix_for_logging</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span>
            <span class="n">axis_name_prefix</span><span class="o">=</span><span class="s2">&quot;phase_anim_global&quot;</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span>
        <span class="p">)</span>
        <span class="n">current_plot_range_r_anim</span> <span class="o">=</span> <span class="n">r_range_tuple</span>
        <span class="n">current_plot_range_v_anim</span> <span class="o">=</span> <span class="n">v_range_tuple</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase Anim Global Ranges: R=</span><span class="si">{</span><span class="n">current_plot_range_r_anim</span><span class="si">}</span><span class="s2">, V=</span><span class="si">{</span><span class="n">current_plot_range_v_anim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase Anim Global Ranges: Using fixed R=</span><span class="si">{</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">default_max_r_anim</span><span class="p">)</span><span class="si">}</span><span class="s2">, V=</span><span class="si">{</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">default_max_v_anim</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Defaults current_plot_range_r_anim and current_plot_range_v_anim are already set</span>

    <span class="c1"># Prepare data for parallel preprocessing</span>
    <span class="c1"># Log to file only, keep console output minimal</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rank_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files for phase space animation...&quot;</span><span class="p">)</span>

    <span class="c1"># Prepare data for parallel preprocessing, ensuring suffix is explicitly passed</span>
    <span class="n">preprocess_args_with_suffix</span> <span class="o">=</span> <span class="p">[(</span>
        <span class="n">rank_file</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Placeholder</span>
        <span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span><span class="p">,</span>
        <span class="n">current_plot_range_r_anim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># Pass determined max R for hist range</span>
        <span class="n">current_plot_range_v_anim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1"># Pass determined max V for hist range</span>
        <span class="n">nbins</span><span class="p">,</span>
        <span class="n">kmsec_to_kpcmyr_local</span><span class="p">,</span> <span class="c1"># Use local var</span>
        <span class="n">PROJECT_ROOT</span><span class="p">,</span>
        <span class="n">config</span><span class="o">.</span><span class="n">suffix</span> <span class="c1"># Use config.suffix</span>
    <span class="p">)</span> <span class="k">for</span> <span class="n">rank_file</span> <span class="ow">in</span> <span class="n">rank_files</span><span class="p">]</span>

    <span class="c1"># Process all files in parallel</span>
    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="c1"># Use a custom tqdm instance with two progress displays</span>
        <span class="c1"># First, create a standard tqdm for the counter on the first line</span>
        <span class="c1"># Determine description and format dynamically</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">term_width</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">term_width</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Fallback width</span>
        <span class="n">selected_desc</span><span class="p">,</span> <span class="n">selected_bar_format</span> <span class="o">=</span> <span class="n">select_tqdm_format</span><span class="p">(</span><span class="s1">&#39;preproc_phase&#39;</span><span class="p">,</span> <span class="n">term_width</span><span class="p">)</span>
        
        <span class="n">counter_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rank_files</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">selected_desc</span><span class="p">,</span> <span class="c1"># Use dynamic description</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">miniters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="n">selected_bar_format</span>
        <span class="p">)</span>


        <span class="n">bar_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rank_files</span><span class="p">),</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{bar}</span><span class="s2"> </span><span class="si">{percentage:3.1f}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="n">ascii</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Process the files with a custom callback to update both progress bars</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Use the modified arguments list</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">preprocess_phase_space_file</span><span class="p">,</span> <span class="n">preprocess_args_with_suffix</span><span class="p">):</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


        <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Add delay after progress bars if enabled</span>
        <span class="k">if</span> <span class="n">progress_delay</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">paced_mode</span><span class="p">:</span>
            <span class="n">show_progress_delay</span><span class="p">(</span><span class="n">progress_delay</span><span class="p">)</span>

    <span class="c1"># Log to file only</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">([</span><span class="n">r</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="p">])</span><span class="si">}</span><span class="s2"> phase space files successfully&quot;</span><span class="p">)</span>

    <span class="c1"># Filter out None results and calculate global vmax</span>
    <span class="n">frame_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">frame_data_list</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No valid frames found. Cannot create phase space animation.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Find the global maximum value for consistent color scaling</span>
    <span class="n">initial_vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vmax</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">vmax</span> <span class="ow">in</span> <span class="n">frame_data_list</span><span class="p">)</span>

    <span class="c1"># Extract tfinal_factor from suffix if possible</span>
    <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Default value</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="c1"># Use config.suffix</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="n">total_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_data_list</span><span class="p">)</span>
    <span class="c1"># Augment frame_data_list to include the determined plot ranges for rendering</span>
    <span class="n">frame_data_list</span> <span class="o">=</span> <span class="p">[(</span>
        <span class="n">snap_num</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">initial_vmax</span><span class="p">,</span> <span class="c1"># initial_vmax is for color scale</span>
        <span class="n">tfinal_factor</span><span class="p">,</span> <span class="n">total_frames</span><span class="p">,</span>
        <span class="n">current_plot_range_r_anim</span><span class="p">,</span>    <span class="c1"># Pass tuple (min_r, max_r)</span>
        <span class="n">current_plot_range_v_anim</span>     <span class="c1"># Pass tuple (min_v, max_v)</span>
    <span class="p">)</span> <span class="k">for</span> <span class="n">snap_num</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">frame_data_list</span><span class="p">]</span> <span class="c1"># Assuming frame_data_list was populated from preprocess_phase_space_file results</span>

    <span class="c1"># Render frames in parallel</span>
    <span class="c1"># Still set the global for backward compatibility, though workers won&#39;t use it</span>
    <span class="k">global</span> <span class="n">total_snapshots</span>
    <span class="n">total_snapshots</span> <span class="o">=</span> <span class="n">total_frames</span>
    <span class="c1"># Log detailed info to file only</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating phase space frames for </span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2"> snapshots...&quot;</span><span class="p">)</span>

    <span class="c1"># Set up imageio writer</span>
    <span class="n">phase_anim_output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/Phase_Space_Animation</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.gif&quot;</span>
    <span class="c1"># Use seconds per frame for imageio v2 duration</span>
    <span class="n">frame_duration_sec_v2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">fps</span>  <span class="c1"># fps is frames per second, duration is seconds per frame</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use mode=&#39;I&#39; for multiple images, loop=0 for infinite loop</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">get_writer</span><span class="p">(</span>
            <span class="n">phase_anim_output</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GIF-PIL&#39;</span><span class="p">,</span>        <span class="c1"># Explicitly use Pillow</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="c1"># quantizer=&#39;nq&#39;,          # Temporarily removed</span>
            <span class="n">palettesize</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>         <span class="c1"># Ensure full palette</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">frame_duration_sec_v2</span><span class="p">,</span>
            <span class="n">loop</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating GIF writer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span> <span class="c1"># Cannot proceed without writer</span>

    <span class="c1"># Use multiple processes to render frames</span>
    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="c1"># Use a custom tqdm instance with two progress displays</span>
        <span class="c1"># First, create a standard tqdm for the counter on the first line</span>
        <span class="c1"># Determine description and format dynamically</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">term_width</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">term_width</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Fallback width</span>
        <span class="n">selected_desc</span><span class="p">,</span> <span class="n">selected_bar_format</span> <span class="o">=</span> <span class="n">select_tqdm_format</span><span class="p">(</span><span class="s1">&#39;render_phase&#39;</span><span class="p">,</span> <span class="n">term_width</span><span class="p">)</span>
        
        <span class="n">counter_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_frames</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">selected_desc</span><span class="p">,</span> <span class="c1"># Use dynamic description</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">,</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">miniters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="n">selected_bar_format</span>
        <span class="p">)</span>


        <span class="n">bar_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_frames</span><span class="p">,</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{bar}</span><span class="s2"> </span><span class="si">{percentage:3.1f}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="n">ascii</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Process the frames with a custom callback to update both progress bars</span>
        <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">frame_image</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">render_phase_frame</span><span class="p">,</span> <span class="n">frame_data_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">frame_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">frame_image</span><span class="p">)</span> <span class="c1"># Append to writer</span>
                    <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error appending frame </span><span class="si">{</span><span class="n">frame_count</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                    <span class="c1"># Decide whether to break or continue</span>
                    <span class="k">break</span>
            <span class="c1"># Update progress bars</span>
            <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


        <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Close the writer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing GIF writer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

        <span class="c1"># Add delay after progress bars if enabled</span>
        <span class="k">if</span> <span class="n">progress_delay</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">paced_mode</span><span class="p">:</span>
            <span class="n">show_progress_delay</span><span class="p">(</span><span class="n">progress_delay</span><span class="p">)</span>

    <span class="c1"># Log to file only</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated and saved </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2"> phase space frames successfully to </span><span class="si">{</span><span class="n">phase_anim_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frame_count</span> <span class="o">==</span> <span class="n">total_frames</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Animation saved: </span><span class="si">{</span><span class="n">get_file_prefix</span><span class="p">(</span><span class="n">phase_anim_output</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Clean up</span>
        <span class="k">del</span> <span class="n">frame_data_list</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Animation partially saved (</span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">get_file_prefix</span><span class="p">(</span><span class="n">phase_anim_output</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Clean up</span>
        <span class="k">del</span> <span class="n">frame_data_list</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="generate_all_1D_animations">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.generate_all_1D_animations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_all_1D_animations</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate all three 1D profile animations (mass, density, psi) with optimized parallel processing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>
<span class="sd">    duration : float</span>
<span class="sd">        Duration of each frame in milliseconds.</span>
<span class="sd">    config : object, optional</span>
<span class="sd">        Configuration object containing plot settings. If provided and has</span>
<span class="sd">        use_median_ranges=True, will use robust ranging for axes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function runs each animation in sequence to ensure clean console output,</span>
<span class="sd">    but each animation internally uses parallel processing for generating and encoding</span>
<span class="sd">    frames. This gets the best performance while maintaining readable output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate 1D profile animations sequentially for clean console output</span>
    <span class="c1"># Each animation creation function internally uses parallel processing for frames</span>
    <span class="n">animations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">create_mass_animation</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">create_density_animation</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;psi&quot;</span><span class="p">,</span> <span class="n">create_psi_animation</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Track animation success</span>
    <span class="n">success_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Process each animation in sequence</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">create_func</span> <span class="ow">in</span> <span class="n">animations</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> animation generation&quot;</span><span class="p">)</span>
            <span class="n">create_func</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
            <span class="n">success_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> animation successfully&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> animation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> animation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Continue with the next animation despite errors</span>

    <span class="c1"># Return success status</span>
    <span class="k">return</span> <span class="n">success_count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">animations</span><span class="p">)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract snapshot number from a rank file name.</span>
<span class="sd">    Now handles both sorted and unsorted file patterns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try sorted pattern first</span>
    <span class="n">pattern_sorted</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Rank_Mass_Rad_VRad_sorted_t(\d+)&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\.dat$&#39;</span>
    <span class="n">mo</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_sorted</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mo</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Fallback to unsorted pattern</span>
    <span class="n">pattern_unsorted</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Rank_Mass_Rad_VRad_unsorted_t(\d+)&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\.dat$&#39;</span>
    <span class="n">mo</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern_unsorted</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mo</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="mi">999999999</span>

<div class="viewcode-block" id="calculate_reasonable_vmax">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.calculate_reasonable_vmax">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_reasonable_vmax</span><span class="p">(</span><span class="n">H</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate an appropriate maximum value for colorbar scaling based on histogram data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    H : ndarray</span>
<span class="sd">        The 2D histogram data array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        A reasonable maximum value for the colorbar, based on the 99.5th percentile</span>
<span class="sd">        of non-zero values, rounded to a visually pleasing number.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function helps avoid having too much empty space in the colorbar while still</span>
<span class="sd">    maintaining a consistent scale across different frames in animations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get non-zero values from the histogram</span>
    <span class="n">nonzero_values</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">H</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonzero_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">100</span>  <span class="c1"># Default if no non-zero values</span>

    <span class="c1"># Calculate the 99.5th percentile of non-zero values</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">nonzero_values</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)</span>

    <span class="c1"># Round up to a nice number</span>
    <span class="k">if</span> <span class="n">vmax</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">elif</span> <span class="n">vmax</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vmax</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">vmax</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span>

    <span class="k">return</span> <span class="n">vmax</span></div>


<div class="viewcode-block" id="render_phase_frame">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.render_phase_frame">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">render_phase_frame</span><span class="p">(</span><span class="n">frame_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renders a single frame for the phase space animation.</span>
<span class="sd">    This function needs to be at the module level for multiprocessing to work.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    frame_data : tuple</span>
<span class="sd">        A tuple containing (snap_num, H, vmax, tfinal_factor, total_snapshots)</span>

<span class="sd">        snap_num : int</span>
<span class="sd">            The snapshot number for labeling.</span>
<span class="sd">        H : ndarray</span>
<span class="sd">            The 2D histogram data.</span>
<span class="sd">        vmax : float</span>
<span class="sd">            The maximum value for the colorbar (consistent across all frames).</span>
<span class="sd">        tfinal_factor : int</span>
<span class="sd">            Factor relating simulation time steps to dynamical times.</span>
<span class="sd">        total_snapshots : int</span>
<span class="sd">            Total number of frames/snapshots for calculating normalized time.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Image data for the rendered frame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">snap_num</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">vmax_colorscale</span><span class="p">,</span> <span class="n">tfinal_factor</span><span class="p">,</span> <span class="n">total_snapshots</span><span class="p">,</span> <span class="n">plot_range_r_tuple</span><span class="p">,</span> <span class="n">plot_range_v_tuple</span> <span class="o">=</span> <span class="n">frame_data</span>

    <span class="c1"># Set up histogram parameters using passed full ranges</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># H was binned using these ranges in preprocess</span>

    <span class="c1"># Recreate the meshgrid for pcolormesh using the exact min/max from tuples</span>
    <span class="n">xedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">plot_range_r_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot_range_r_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">plot_range_v_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot_range_v_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nbins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xedges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Transpose for correct orientation</span>

    <span class="c1"># Create a figure for this frame</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="c1"># Plot the phase space - Get the colormap from this call to use consistently</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span>  <span class="c1"># Default colormap</span>
    <span class="n">pcm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_colorscale</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Phase Space Distribution Evolution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">plot_range_r_tuple</span><span class="p">)</span> <span class="c1"># Pass the tuple directly</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">plot_range_v_tuple</span><span class="p">)</span> <span class="c1"># Pass the tuple directly</span>

    <span class="c1"># Calculate time in dynamical times using the tfinal_factor and passed total_snapshots</span>
    <span class="k">if</span> <span class="n">total_snapshots</span> <span class="ow">and</span> <span class="n">total_snapshots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">normalized_snap</span> <span class="o">=</span> <span class="n">snap_num</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_snapshots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Approximate by assuming snapshots range from 0-100</span>
        <span class="c1"># (snapshots often use a zero-padded 5-digit format with max around 00100)</span>
        <span class="n">normalized_snap</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">snap_num</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Scale by tfinal_factor to get time in dynamical units</span>
    <span class="n">t_dyn_fraction</span> <span class="o">=</span> <span class="n">normalized_snap</span> <span class="o">*</span> <span class="n">tfinal_factor</span>

    <span class="c1"># Add text in upper right corner showing time in dynamical times</span>
    <span class="c1"># Use the same colormap as the plot for consistency</span>
    <span class="c1"># Get colors directly from the current colormap</span>
    <span class="c1"># Map min value to background (usually dark blue/purple in viridis)</span>
    <span class="c1"># Map max value to text (usually yellow in viridis)</span>
    <span class="n">bg_color</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">.</span><span class="n">cmap</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Background color = min value in colormap</span>
    <span class="n">text_color</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">.</span><span class="n">cmap</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># Text color = max value in colormap</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;$t = </span><span class="si">{</span><span class="n">t_dyn_fraction</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\\</span><span class="s2">,t_</span><span class="se">{{\\</span><span class="s2">rm dyn</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">text_color</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">bg_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

    <span class="c1"># Convert figure to image in memory</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Clean up the figure to avoid memory leaks</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Return the image</span>
    <span class="k">return</span> <span class="n">imageio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_initial_phase_histogram">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.generate_initial_phase_histogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_initial_phase_histogram</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a phase space histogram from the initial particles.dat file.</span>
<span class="sd">    This represents the true initial distribution.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for file naming</span>
<span class="sd">    config : dict, optional</span>
<span class="sd">        Configuration dictionary with plot settings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Constants for expected number of columns</span>
    <span class="n">ncol_particles_initial</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="c1"># Path to the initial particles file</span>
    <span class="n">particles_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/particles</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">particles_file</span><span class="p">):</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial particles file </span><span class="si">{</span><span class="n">particles_file</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Start loading the initial data with timing information</span>
    <span class="c1"># Log to file only</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading initial phase space histogram: </span><span class="si">{</span><span class="n">get_file_prefix</span><span class="p">(</span><span class="n">particles_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Start progress tracking for data loading</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_data_loading&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Update progress - loading initial data (use filename prefix format)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_data_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;particles_data&quot;</span><span class="p">)</span>

    <span class="c1"># Load the data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">particles_file</span><span class="p">,</span> <span class="n">ncol_particles_initial</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">particles_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Log to file only</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial histogram loaded successfully [</span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s]&quot;</span><span class="p">)</span>

    <span class="c1"># Extract data columns - using first 3 relevant columns</span>
    <span class="n">iradii</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">radialvelocities</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Avoid division by zero by filtering out non-positive radii</span>
    <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">iradii</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">iradii</span> <span class="o">=</span> <span class="n">iradii</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">radialvelocities</span> <span class="o">=</span> <span class="n">radialvelocities</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>

    <span class="c1"># Compute the derived (total) velocity - ALL IN SIMULATION UNITS</span>
    <span class="c1"># v_total_sim = sqrt((L/r)^2 + v_r^2)</span>
    <span class="n">tangential_velocity_sim</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">/</span> <span class="n">iradii</span>  <span class="c1"># Tangential velocity in simulation units</span>
    <span class="n">total_velocity_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tangential_velocity_sim</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">radialvelocities</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Total velocity in simulation units</span>

    <span class="c1"># Convert to km/s ONLY at the end</span>
    <span class="n">kmsec_to_kpcmyr</span> <span class="o">=</span> <span class="mf">1.02271e-3</span>  <span class="c1"># Conversion factor</span>
    <span class="n">ivelocities</span> <span class="o">=</span> <span class="n">total_velocity_sim</span> <span class="o">/</span> <span class="n">kmsec_to_kpcmyr</span>  <span class="c1"># Convert to km/s</span>

    <span class="c1"># Filter out invalid values</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">iradii</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">iradii</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ivelocities</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ivelocities</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">)</span>
    <span class="n">iradii</span> <span class="o">=</span> <span class="n">iradii</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
    <span class="n">ivelocities</span> <span class="o">=</span> <span class="n">ivelocities</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iradii</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;All initial radii/velocities invalid or empty.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Log statistics to file only</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Velocity range: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ivelocities</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ivelocities</span><span class="p">)</span><span class="si">}</span><span class="s2"> km/s&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Radius range: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">iradii</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">iradii</span><span class="p">)</span><span class="si">}</span><span class="s2"> kpc&quot;</span><span class="p">)</span>

    <span class="c1"># Set up output path</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/phase_space_initial</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>

    <span class="c1"># Start progress tracking for plot saving</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_plots&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Set up histogram parameters using robust ranging</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="mi">200</span>
    
    <span class="c1"># Calculate dynamic ranges using the robust range helper</span>
    <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
        <span class="n">iradii</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile</span><span class="p">,</span>
        <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile_multiplier</span><span class="p">,</span>
        <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_x_range_abs</span><span class="p">,</span>
        <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;radius&quot;</span>
    <span class="p">)</span>
    
    <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
        <span class="n">ivelocities</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile</span><span class="p">,</span>
        <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile_multiplier</span><span class="p">,</span>
        <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_y_range_abs</span><span class="p">,</span> 
        <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">320.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;velocity&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Create the 2D histogram</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span>
        <span class="n">iradii</span><span class="p">,</span>
        <span class="n">ivelocities</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">nbins</span><span class="p">,</span> <span class="n">nbins</span><span class="p">],</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">],</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]]</span>
    <span class="p">)</span>

    <span class="c1"># Create meshgrid for pcolormesh</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xedges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yedges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Transpose for correct orientation</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="c1"># Use pcolormesh with shading=&#39;auto&#39; like in nsphere plot</span>
    <span class="c1"># Calculate a reasonable vmax based on the histogram data</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">calculate_reasonable_vmax</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="n">pcm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>

    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Initial Phase Space Distribution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1"># Set consistent limits using calculated ranges</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>


    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="c1"># Update progress for saving plot</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_plots&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

    <span class="c1"># Log completion message to file only, not to console</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phase space histogram saved: </span><span class="si">{</span><span class="n">get_file_prefix</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s]&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>


    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial phase space histogram saved to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="generate_comparison_plot">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.generate_comparison_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_comparison_plot</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a side-by-side comparison of the initial and last available snapshot phase space histograms.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for file naming</span>
<span class="sd">    config : dict, optional</span>
<span class="sd">        Configuration dictionary with plot settings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Constants for expected number of columns</span>
    <span class="n">ncol_particles_initial</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="c1"># Path to the initial particles file</span>
    <span class="n">particles_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/particles</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>

    <span class="c1"># Find the last available snapshot file</span>
    <span class="n">rank_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data/Rank_Mass_Rad_VRad_sorted_t*</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rank_files</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No snapshot files found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Sort files by snapshot number and get the last one</span>
    <span class="n">rank_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">fname</span><span class="p">:</span> <span class="n">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">))</span>
    <span class="n">last_snap_file</span> <span class="o">=</span> <span class="n">rank_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">last_snap_num</span> <span class="o">=</span> <span class="n">_extract_Rank_snapnum</span><span class="p">(</span><span class="n">last_snap_file</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>

    <span class="c1"># Log the file search details to the log file, not the console</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Looking for initial file: </span><span class="si">{</span><span class="n">particles_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Looking for last snapshot file: </span><span class="si">{</span><span class="n">last_snap_file</span><span class="si">}</span><span class="s2"> (snapshot </span><span class="si">{</span><span class="n">last_snap_num</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">particles_file</span><span class="p">):</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial particles file </span><span class="si">{</span><span class="n">particles_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">last_snap_file</span><span class="p">):</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last snapshot file </span><span class="si">{</span><span class="n">last_snap_file</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Start progress tracking for data loading (5 steps: 2 for loading, 3 for processing/histograms)</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_loading&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Update progress - both files found, starting to load (use filename prefix)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;particles_data&quot;</span><span class="p">)</span>

    <span class="c1"># Load the initial data</span>
    <span class="n">initial_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">particles_file</span><span class="p">,</span> <span class="n">ncol_particles_initial</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">initial_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">initial_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">particles_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Log the data shape details to the log file</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial data loaded, shape: </span><span class="si">{</span><span class="n">initial_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Update progress - loaded initial data (use filename prefix)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;particles_done&quot;</span><span class="p">)</span>

    <span class="c1"># Load the last snapshot data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span>
        <span class="n">last_snap_file</span><span class="p">,</span>
        <span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data in </span><span class="si">{</span><span class="n">last_snap_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Log the data shape details to the log file</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final snapshot data loaded, shape: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Update progress - loaded last snapshot data (use filename prefix)</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;snapshot_data&quot;</span><span class="p">)</span>

    <span class="c1"># Update progress for processing initial data - use file prefix format</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;initial_data&quot;</span><span class="p">)</span>
    <span class="c1"># Extract data columns - using first 3 relevant columns</span>
    <span class="n">iradii</span> <span class="o">=</span> <span class="n">initial_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">radialvelocities</span> <span class="o">=</span> <span class="n">initial_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">initial_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Log detailed processing steps to log file</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing initial data - extracting columns and calculating velocities&quot;</span><span class="p">)</span>

    <span class="c1"># Avoid division by zero by filtering out non-positive radii</span>
    <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">iradii</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">iradii</span> <span class="o">=</span> <span class="n">iradii</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">radialvelocities</span> <span class="o">=</span> <span class="n">radialvelocities</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">ell</span> <span class="o">=</span> <span class="n">ell</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>

    <span class="c1"># Compute the derived (total) velocity - ALL IN SIMULATION UNITS</span>
    <span class="c1"># v_total_sim = sqrt((L/r)^2 + v_r^2)</span>
    <span class="n">tangential_velocity_sim</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">/</span> <span class="n">iradii</span>  <span class="c1"># Tangential velocity in simulation units</span>
    <span class="n">total_velocity_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tangential_velocity_sim</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">radialvelocities</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Total velocity in simulation units</span>

    <span class="c1"># Convert to km/s ONLY at the end</span>
    <span class="n">kmsec_to_kpcmyr</span> <span class="o">=</span> <span class="mf">1.02271e-3</span>  <span class="c1"># Conversion factor</span>
    <span class="n">ivelocities</span> <span class="o">=</span> <span class="n">total_velocity_sim</span> <span class="o">/</span> <span class="n">kmsec_to_kpcmyr</span>  <span class="c1"># Convert to km/s</span>

    <span class="c1"># Filter out invalid values</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">iradii</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">iradii</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ivelocities</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ivelocities</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">)</span>
    <span class="n">iradii</span> <span class="o">=</span> <span class="n">iradii</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
    <span class="n">ivelocities</span> <span class="o">=</span> <span class="n">ivelocities</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iradii</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;All initial radii/velocities invalid or empty.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Update progress after processing initial data - use file prefix format</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_loading&quot;</span><span class="p">,</span> <span class="s2">&quot;final_data&quot;</span><span class="p">)</span>

    <span class="c1"># Process last snapshot data</span>
    <span class="c1"># Extract radius and velocity data from sorted data with columns:</span>
    <span class="c1"># Rank(0), Mass(1), Radius(2), Vrad(3), Psi(4), Energy(5), L(6), Density(7)</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>          <span class="c1"># Column index 2 holds radius (r) - simulation units</span>
    <span class="n">radial_velocity</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Column index 3 holds radial velocity (v_r) - simulation units</span>
    <span class="n">angular_momentum</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span>  <span class="c1"># Column index 6 holds angular momentum (L) - simulation units</span>


    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing final snapshot data - extracting columns and calculating velocities&quot;</span><span class="p">)</span>

    <span class="c1"># Filter out non-positive radii to avoid division by zero</span>
    <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">radii</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">radial_velocity</span> <span class="o">=</span> <span class="n">radial_velocity</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">angular_momentum</span> <span class="o">=</span> <span class="n">angular_momentum</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>

    <span class="c1"># Compute the total velocity - ALL IN SIMULATION UNITS</span>
    <span class="c1"># v_total_sim = sqrt((L/r)^2 + v_r^2)</span>
    <span class="n">tangential_velocity_sim</span> <span class="o">=</span> <span class="n">angular_momentum</span> <span class="o">/</span> <span class="n">radii</span>  <span class="c1"># Tangential velocity in simulation units</span>
    <span class="n">total_velocity_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tangential_velocity_sim</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">radial_velocity</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Total velocity in simulation units</span>

    <span class="c1"># Convert to km/s ONLY at the end</span>
    <span class="n">total_velocity</span> <span class="o">=</span> <span class="n">total_velocity_sim</span> <span class="o">/</span> <span class="n">kmsec_to_kpcmyr</span>  <span class="c1"># Convert to km/s</span>

    <span class="c1"># Filter out invalid values</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">radii</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">radii</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">total_velocity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">total_velocity</span> <span class="o">&lt;</span> <span class="mf">1e8</span><span class="p">)</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
    <span class="n">total_velocity</span> <span class="o">=</span> <span class="n">total_velocity</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;All final snapshot radii/velocities invalid or empty.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Update progress after processing both datasets - use a data file format for display</span>
    <span class="n">histogram_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/creating_histograms</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
    <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_loading&quot;</span><span class="p">,</span> <span class="n">histogram_file</span><span class="p">)</span>

    <span class="c1"># Set up histogram parameters using robust ranging</span>
    <span class="n">nbins</span> <span class="o">=</span> <span class="mi">200</span>
    
    <span class="c1"># Calculate global ranges covering both datasets</span>
    <span class="n">combined_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">iradii</span><span class="p">,</span> <span class="n">radii</span><span class="p">])</span>
    <span class="n">combined_velocities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ivelocities</span><span class="p">,</span> <span class="n">total_velocity</span><span class="p">])</span>
    
    <span class="c1"># Calculate dynamic ranges using the robust range helper</span>
    <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
        <span class="n">combined_radii</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile</span><span class="p">,</span>
        <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile_multiplier</span><span class="p">,</span>
        <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_x_range_abs</span><span class="p">,</span>
        <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;radius&quot;</span>
    <span class="p">)</span>
    
    <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
        <span class="n">combined_velocities</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile</span><span class="p">,</span>
        <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile_multiplier</span><span class="p">,</span>
        <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_y_range_abs</span><span class="p">,</span> 
        <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">320.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;velocity&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Create the 2D histograms</span>
    <span class="n">H_initial</span><span class="p">,</span> <span class="n">xedges_initial</span><span class="p">,</span> <span class="n">yedges_initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span>
        <span class="n">iradii</span><span class="p">,</span>
        <span class="n">ivelocities</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">nbins</span><span class="p">,</span> <span class="n">nbins</span><span class="p">],</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">],</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]]</span>
    <span class="p">)</span>

    <span class="n">H_last_snap</span><span class="p">,</span> <span class="n">xedges_last_snap</span><span class="p">,</span> <span class="n">yedges_last_snap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span>
        <span class="n">radii</span><span class="p">,</span>
        <span class="n">total_velocity</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">nbins</span><span class="p">,</span> <span class="n">nbins</span><span class="p">],</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">],</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]]</span>
    <span class="p">)</span>

    <span class="c1"># Print histogram statistics for comparison</span>
    <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Comparison of histogram statistics:&quot;</span><span class="p">)</span>
    <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Data: Max. Value = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">H_initial</span><span class="p">)</span><span class="si">}</span><span class="s2">, Non-Zero Bins = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">H_initial</span><span class="p">)</span><span class="si">}</span><span class="s2">, Mean Value (Non-Zero) = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">H_initial</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">H_initial</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Data:   Max. Value = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">H_last_snap</span><span class="p">)</span><span class="si">}</span><span class="s2">, Non-Zero Bins = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">H_last_snap</span><span class="p">)</span><span class="si">}</span><span class="s2">, Mean Value (Non-Zero) = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">H_last_snap</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">H_last_snap</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Add separator line after statistics</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create meshgrids for pcolormesh</span>
    <span class="n">X_initial</span><span class="p">,</span> <span class="n">Y_initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xedges_initial</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yedges_initial</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">C_initial</span> <span class="o">=</span> <span class="n">H_initial</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Transpose for correct orientation</span>

    <span class="n">X_last_snap</span><span class="p">,</span> <span class="n">Y_last_snap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xedges_last_snap</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">yedges_last_snap</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">C_last_snap</span> <span class="o">=</span> <span class="n">H_last_snap</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Transpose for correct orientation</span>

    <span class="c1"># Create the side-by-side plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set vmin and vmax to use a consistent color scale across both plots</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="n">calculate_reasonable_vmax</span><span class="p">(</span><span class="n">H_initial</span><span class="p">)</span>

    
    <span class="n">pcm1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X_initial</span><span class="p">,</span> <span class="n">Y_initial</span><span class="p">,</span> <span class="n">C_initial</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Initial Phase Space&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>

    
    <span class="n">pcm2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X_last_snap</span><span class="p">,</span> <span class="n">Y_last_snap</span><span class="p">,</span> <span class="n">C_last_snap</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;Final Phase Space (Snapshot $t=</span><span class="si">{</span><span class="n">last_snap_num</span><span class="si">}</span><span class="s1">$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>

    
    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.92</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>  <span class="c1"># [left, bottom, width, height]</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm2</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Comparison of Phase Space Distributions: Initial vs Final&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="c1"># Use fig.subplots_adjust instead of tight_layout for better control</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Ensure the results directory exists</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    
    <span class="n">output_files</span> <span class="o">=</span> <span class="p">[]</span>

    
    <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/phase_space_comparison</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

    <span class="c1"># Create a difference plot to highlight changes</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="c1"># Calculate the difference (last_snap - initial)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">C_last_snap</span> <span class="o">-</span> <span class="n">C_initial</span>

    <span class="c1"># Use a diverging colormap for the difference plot with adjusted scale</span>
    <span class="c1"># Calculate a reasonable scale based on the data</span>
    <span class="n">abs_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">diff</span><span class="p">)),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diff</span><span class="p">)))</span>
    <span class="c1"># Ensure we have a non-zero scale and use a slightly larger value to avoid clipping</span>
    <span class="n">vmax_diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">abs_max</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="n">pcm_diff</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X_initial</span><span class="p">,</span> <span class="n">Y_initial</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
                           <span class="n">vmin</span><span class="o">=-</span><span class="n">vmax_diff</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_diff</span><span class="p">)</span>  <span class="c1"># Dynamic symmetric scale for differences</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">fr</span><span class="s1">&#39;Phase Space Difference (Final - Initial)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>

    
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm_diff</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Difference in Counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    
    <span class="n">diff_output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/phase_space_difference</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">diff_output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff_output_file</span><span class="p">)</span>

    <span class="c1"># Start combined progress tracking for the plots</span>
    <span class="n">total_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_files</span><span class="p">)</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_plots&quot;</span><span class="p">,</span> <span class="n">total_plots</span><span class="p">)</span>

    <span class="c1"># Log both plots with progress indication</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">output_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_files</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;phase_space_plots&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="plot_convergence_test">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.plot_convergence_test">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_convergence_test</span><span class="p">(</span><span class="n">Nint_arr</span><span class="p">,</span> <span class="n">Nspl_arr</span><span class="p">,</span> <span class="n">basefile</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate convergence test plots comparing different integration and spline parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Nint_arr : list</span>
<span class="sd">        List of integration parameter values.</span>
<span class="sd">    Nspl_arr : list</span>
<span class="sd">        List of spline parameter values.</span>
<span class="sd">    basefile : str</span>
<span class="sd">        Base filename to use.</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>
<span class="sd">    xlabel : str</span>
<span class="sd">        X-axis label (already formatted LaTeX string).</span>
<span class="sd">    ylabel : str</span>
<span class="sd">        Y-axis label (already formatted LaTeX string).</span>
<span class="sd">    title : str</span>
<span class="sd">        Plot title (already formatted LaTeX string).</span>
<span class="sd">    output_file : str</span>
<span class="sd">        Output file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="c1"># Determine number of columns based on basefile</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">ncol_convergence</span> <span class="c1"># Default for most convergence files</span>
    <span class="k">if</span> <span class="n">basefile</span> <span class="o">==</span> <span class="s2">&quot;density_profile&quot;</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="n">ncol_density_profile</span>
    <span class="k">elif</span> <span class="n">basefile</span> <span class="o">==</span> <span class="s2">&quot;massprofile&quot;</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="n">ncol_mass_profile</span>
    <span class="k">elif</span> <span class="n">basefile</span> <span class="o">==</span> <span class="s2">&quot;Psiprofile&quot;</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="n">ncol_psi_profile</span>
    <span class="k">elif</span> <span class="n">basefile</span> <span class="o">==</span> <span class="s2">&quot;f_of_E&quot;</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="n">ncol_f_of_E</span>
    <span class="k">elif</span> <span class="n">basefile</span> <span class="o">==</span> <span class="s2">&quot;integrand&quot;</span><span class="p">:</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="n">ncol_integrand</span>

    <span class="n">has_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">Nint</span> <span class="ow">in</span> <span class="n">Nint_arr</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">Nspl</span> <span class="ow">in</span> <span class="n">Nspl_arr</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">basefile</span><span class="si">}</span><span class="s2">_Ni</span><span class="si">{</span><span class="n">Nint</span><span class="si">}</span><span class="s2">_Ns</span><span class="si">{</span><span class="n">Nspl</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Filter out rows with NaN or Inf values</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Additional filtering for log-log plots: remove zero or negative values</span>
            <span class="n">log_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">filtered_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">filtered_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="p">[</span><span class="n">log_mask</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">filtered_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">filtered_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$N_{\rm int}=</span><span class="si">%d</span><span class="s2">$, $N_{\rm spl}=</span><span class="si">%d</span><span class="s2">$&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Nint</span><span class="p">,</span> <span class="n">Nspl</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">has_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">has_data</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
        
        <span class="c1"># Set log-log scale</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Log to file only, no console output</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data found for convergence test plot: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="c1"># Progress tracking is handled by the caller</span>

<div class="viewcode-block" id="generate_convergence_test_plots">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.generate_convergence_test_plots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_convergence_test_plots</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate all convergence test plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define parameter arrays for testing</span>
    <span class="n">Nint_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>
    <span class="n">Nspl_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">]</span>

    <span class="c1"># Define plot specifications (basefile, labels, title, output)</span>
    <span class="n">plot_specs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># Psi profile convergence test</span>
        <span class="p">(</span><span class="s2">&quot;Psiprofile&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$r$ (kpc)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\Psi$ (km$^2$/s$^2$)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\Psi(r)$ Profile Convergence Test&quot;</span><span class="p">,</span>
         <span class="sa">f</span><span class="s2">&quot;results/Psiprofile_convergence_test</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">),</span>
        <span class="c1"># Integrand convergence test - updated labels based on C code analysis</span>
        <span class="p">(</span><span class="s2">&quot;integrand&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\sqrt{\mathcal</span><span class="si">{E}</span><span class="s1">_</span><span class="si">{max}</span><span class="s1"> - \Psi}$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$2 \, d\rho/d\Psi$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;Integrand Convergence Test&quot;</span><span class="p">,</span>
         <span class="sa">f</span><span class="s2">&quot;results/integrand_convergence_test</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">),</span>
        <span class="c1"># Distribution function convergence test - corrected units and symbol</span>
        <span class="p">(</span><span class="s2">&quot;f_of_E&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\mathcal</span><span class="si">{E}</span><span class="s2">$ (km$^2$/s$^2$)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$f(\mathcal</span><span class="si">{E}</span><span class="s2">)$ ((km/s)$^{-3}$ kpc$^{-3}$)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$f(\mathcal</span><span class="si">{E}</span><span class="s2">)$ Convergence Test&quot;</span><span class="p">,</span>
         <span class="sa">f</span><span class="s2">&quot;results/f_of_E_convergence_test</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">),</span>
        <span class="c1"># Mass profile convergence test</span>
        <span class="p">(</span><span class="s2">&quot;massprofile&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$r$ (kpc)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$M(r)$ (M$_\odot$)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$M(r)$ Profile Convergence Test&quot;</span><span class="p">,</span>
         <span class="sa">f</span><span class="s2">&quot;results/massprofile_convergence_test</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">),</span>
        <span class="c1"># Density profile convergence test - uses rho, not 4*pi*r^2*rho</span>
        <span class="p">(</span><span class="s2">&quot;density_profile&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$r$ (kpc)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\rho(r)$ (M$_\odot$/kpc$^3$)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;Density Profile $\rho(r)$ Convergence Test&quot;</span><span class="p">,</span>
         <span class="sa">f</span><span class="s2">&quot;results/density_profile_convergence_test</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Start progress tracking for data loading</span>
    <span class="n">total_data_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_specs</span><span class="p">)</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;convergence_data_loading&quot;</span><span class="p">,</span> <span class="n">total_data_files</span><span class="p">)</span>

    <span class="c1"># First check for data files and log loading progress</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">basefile</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_specs</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Check for different Nint/Nspl combinations to see if any files exist</span>
        <span class="n">found_files</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">Nint</span> <span class="ow">in</span> <span class="n">Nint_arr</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">Nspl</span> <span class="ow">in</span> <span class="n">Nspl_arr</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">basefile</span><span class="si">}</span><span class="s2">_Ni</span><span class="si">{</span><span class="n">Nint</span><span class="si">}</span><span class="s2">_Ns</span><span class="si">{</span><span class="n">Nspl</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                    <span class="n">found_files</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found convergence test file: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">found_files</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">found_files</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading data for </span><span class="si">{</span><span class="n">basefile</span><span class="si">}</span><span class="s2"> convergence test&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data files found for </span><span class="si">{</span><span class="n">basefile</span><span class="si">}</span><span class="s2"> convergence test&quot;</span><span class="p">)</span>

        <span class="c1"># Update progress with a more filename-like format</span>
        <span class="k">if</span> <span class="n">found_files</span><span class="p">:</span>
            <span class="c1"># Use the first found file as the reference</span>
            <span class="k">for</span> <span class="n">Nint</span> <span class="ow">in</span> <span class="n">Nint_arr</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">Nspl</span> <span class="ow">in</span> <span class="n">Nspl_arr</span><span class="p">:</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">basefile</span><span class="si">}</span><span class="s2">_Ni</span><span class="si">{</span><span class="n">Nint</span><span class="si">}</span><span class="s2">_Ns</span><span class="si">{</span><span class="n">Nspl</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                        <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;convergence_data_loading&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If no files were found, still use a filename-like format</span>
            <span class="n">dummy_filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/</span><span class="si">{</span><span class="n">basefile</span><span class="si">}</span><span class="s2">_convergence</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
            <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;convergence_data_loading&quot;</span><span class="p">,</span> <span class="n">dummy_filepath</span><span class="p">)</span>

    <span class="c1"># Initialize combined progress tracking for plot generation</span>
    <span class="n">total_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_specs</span><span class="p">)</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;convergence_tests&quot;</span><span class="p">,</span> <span class="n">total_plots</span><span class="p">)</span>

    <span class="c1"># Generate all plots with combined progress tracking</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">basefile</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_specs</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">plot_convergence_test</span><span class="p">(</span><span class="n">Nint_arr</span><span class="p">,</span> <span class="n">Nspl_arr</span><span class="p">,</span> <span class="n">basefile</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

            <span class="c1"># Update the combined progress bar</span>
            <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;convergence_tests&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating </span><span class="si">{</span><span class="n">basefile</span><span class="si">}</span><span class="s2"> convergence test: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating </span><span class="si">{</span><span class="n">basefile</span><span class="si">}</span><span class="s2"> convergence test: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span></div>


<div class="viewcode-block" id="process_rank_files">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_rank_files">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_rank_files</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">start_snap</span><span class="p">,</span> <span class="n">end_snap</span><span class="p">,</span> <span class="n">step_snap</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processes sorted and unsorted Rank snapshot files using multiprocessing.</span>

<span class="sd">    - **Sorted Files:** Calls worker `process_rank_file_for_1d_anim` for each</span>
<span class="sd">      filtered sorted file. This worker loads necessary columns, uses</span>
<span class="sd">      linear interpolation/downsampling, and returns processed arrays. The</span>
<span class="sd">      results are used to populate the global `mass_snapshots`,</span>
<span class="sd">      `density_snapshots`, and `psi_snapshots` lists directly.</span>
<span class="sd">    - **Unsorted Files:** Calls worker `process_unsorted_rank_file` for each</span>
<span class="sd">      unsorted file. This worker uses optimized seeking to load energy</span>
<span class="sd">      data for the first few particles.</span>
<span class="sd">    - Progress is displayed using tqdm.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for data files.</span>
<span class="sd">    start_snap : int</span>
<span class="sd">        First snapshot number to include.</span>
<span class="sd">    end_snap : int</span>
<span class="sd">        Last snapshot number to include (0 means use max available).</span>
<span class="sd">    step_snap : int</span>
<span class="sd">        Step size between snapshots.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (None, unsorted_energy_list): The first element is always None as</span>
<span class="sd">        sorted data is placed directly into global lists. The second element</span>
<span class="sd">        is a list of (snap, energy_values) tuples from unsorted files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">mass_snapshots</span><span class="p">,</span> <span class="n">density_snapshots</span><span class="p">,</span> <span class="n">psi_snapshots</span>

    <span class="c1"># Clear global snapshot data first to ensure we start fresh</span>
    <span class="n">mass_snapshots</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">density_snapshots</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">psi_snapshots</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Find and process sorted rank files</span>
    <span class="n">Rank_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/Rank_Mass_Rad_VRad_sorted_t*</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
    <span class="n">all_rank_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">Rank_pattern</span><span class="p">)</span>

    <span class="c1"># Filter to keep ONLY files that match the exact pattern:</span>
    <span class="c1"># data/Rank_Mass_Rad_VRad_sorted_t00001_40000_1001_5.dat</span>
    <span class="c1"># without any extra characters between &quot;t00001&quot; and the suffix</span>
    <span class="n">correct_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;data/Rank_Mass_Rad_VRad_sorted_t\d+&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\.dat$&#39;</span><span class="p">)</span>
    <span class="n">all_rank_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_rank_files</span> <span class="k">if</span> <span class="n">correct_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>

    <span class="c1"># Debug output</span>
    <span class="k">global</span> <span class="n">enable_logging</span>
    <span class="k">if</span> <span class="n">enable_logging</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_rank_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> rank files after filtering.&quot;</span><span class="p">)</span>

    <span class="c1"># Find and process unsorted rank files</span>
    <span class="n">unsorted_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/Rank_Mass_Rad_VRad_unsorted_t*</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
    <span class="n">unsorted_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">unsorted_pattern</span><span class="p">)</span>

    <span class="c1"># Filter unsorted files as well</span>
    <span class="n">correct_unsorted_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;data/Rank_Mass_Rad_VRad_unsorted_t\d+&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\.dat$&#39;</span><span class="p">)</span>
    <span class="n">unsorted_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">unsorted_files</span> <span class="k">if</span> <span class="n">correct_unsorted_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
    <span class="n">correct_unsorted_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;data/Rank_Mass_Rad_VRad_unsorted_t\d+&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\.dat$&#39;</span><span class="p">)</span>
    <span class="n">unsorted_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">unsorted_files</span> <span class="k">if</span> <span class="n">correct_unsorted_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_rank_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> rank sorted snapshot files and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unsorted_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> unsorted snapshot files.&quot;</span><span class="p">)</span>

    <span class="c1"># Process sorted files for 1D Animations</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_rank_files</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No rank sorted snapshot files found for animation.&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No rank sorted snapshot files found for animation.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Sort files by snapshot number</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Rank_Mass_Rad_VRad_sorted_t(\d+)&#39;</span><span class="p">)</span>
        <span class="n">all_rank_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">filename</span><span class="p">:</span> <span class="n">get_snapshot_number</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span>

        <span class="c1"># Filter files based on start/end/step if specified</span>
        <span class="n">filtered_rank_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">all_rank_files</span><span class="p">:</span>
            <span class="n">snap</span> <span class="o">=</span> <span class="n">get_snapshot_number</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
            <span class="c1"># Skip files outside the requested range</span>
            <span class="k">if</span> <span class="n">start_snap</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">snap</span> <span class="o">&lt;</span> <span class="n">start_snap</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">end_snap</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">snap</span> <span class="o">&gt;</span> <span class="n">end_snap</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Skip files not on the requested step</span>
            <span class="k">if</span> <span class="n">step_snap</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snap</span> <span class="o">-</span> <span class="n">start_snap</span><span class="p">)</span> <span class="o">%</span> <span class="n">step_snap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">filtered_rank_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_rank_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> sorted files for 1D animations...&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="c1"># Setup tqdm bars</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">term_width</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">term_width</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Fallback width</span>
            <span class="n">selected_desc</span><span class="p">,</span> <span class="n">selected_bar_format</span> <span class="o">=</span> <span class="n">select_tqdm_format</span><span class="p">(</span><span class="s1">&#39;proc_sorted_snaps&#39;</span><span class="p">,</span> <span class="n">term_width</span><span class="p">)</span>
            
            <span class="n">counter_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_rank_files</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">selected_desc</span><span class="p">,</span> <span class="c1"># Use dynamic description</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span>
                <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">miniters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># Allow adapting to terminal width</span>
                <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">bar_format</span><span class="o">=</span><span class="n">selected_bar_format</span>
            <span class="p">)</span>

            <span class="c1"># For alignment with the counter line</span>
            <span class="n">bar_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_rank_files</span><span class="p">),</span>
                <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{bar}</span><span class="s2"> </span><span class="si">{percentage:3.1f}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="n">ascii</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Use Unicode block characters</span>
            <span class="p">)</span>

            <span class="c1"># Process files and handle results as they arrive</span>
            <span class="n">processed_count_1d</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Prepare arguments including the suffix for the 1D animation worker</span>
            <span class="n">args_for_1d_anim</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fname</span><span class="p">,</span> <span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">filtered_rank_files</span><span class="p">]</span>
            <span class="c1"># Pass the modified arguments list to imap_unordered</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">process_rank_file_for_1d_anim</span><span class="p">,</span> <span class="n">args_for_1d_anim</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">snap</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">result</span>
                    <span class="c1"># Append directly to global lists</span>
                    <span class="n">mass_snapshots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">snap</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">mass</span><span class="p">))</span>
                    <span class="n">density_snapshots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">snap</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">density</span><span class="p">))</span>
                    <span class="n">psi_snapshots</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">snap</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span>
                    <span class="n">processed_count_1d</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># Update progress bars</span>
                <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">n</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span> <span class="c1"># Periodic GC in main</span>

            <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span> <span class="c1"># Collect after pool</span>

        <span class="c1"># Add separator line after tqdm progress bar</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Sort the snapshot lists by snap number AFTER collecting all results</span>
        <span class="n">mass_snapshots</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">density_snapshots</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">psi_snapshots</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished processing </span><span class="si">{</span><span class="n">processed_count_1d</span><span class="si">}</span><span class="s2"> sorted files for 1D animations.&quot;</span><span class="p">)</span>

    <span class="c1"># Process unsorted files</span>
    <span class="n">unsorted_energy_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">unsorted_files</span><span class="p">:</span>
        <span class="c1"># Process unsorted files for basic energy plot in parallel</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unsorted_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> unsorted snapshot files...&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="c1"># Use a custom tqdm instance with two progress displays</span>
            <span class="c1"># First, create a standard tqdm for the counter on the first line</span>
            <span class="c1"># Determine description and format dynamically</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">term_width</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">term_width</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Fallback width</span>
            <span class="n">selected_desc</span><span class="p">,</span> <span class="n">selected_bar_format</span> <span class="o">=</span> <span class="n">select_tqdm_format</span><span class="p">(</span><span class="s1">&#39;proc_unsorted_snaps&#39;</span><span class="p">,</span> <span class="n">term_width</span><span class="p">)</span>
            
            <span class="n">counter_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unsorted_files</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">selected_desc</span><span class="p">,</span> <span class="c1"># Use dynamic description</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span>
                <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">miniters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># Allow adapting to terminal width</span>
                <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">bar_format</span><span class="o">=</span><span class="n">selected_bar_format</span>
            <span class="p">)</span>

            <span class="c1"># For alignment with the counter line, we&#39;ll use a fixed width</span>
            <span class="n">bar_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unsorted_files</span><span class="p">),</span>
                <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{bar}</span><span class="s2"> </span><span class="si">{percentage:3.1f}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="n">ascii</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Use Unicode block characters</span>
            <span class="p">)</span>

            <span class="c1"># Process the files with a custom callback to update both progress bars</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Prepare arguments including suffix for the unsorted worker</span>
            <span class="n">args_for_unsorted</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fname</span><span class="p">,</span> <span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">unsorted_files</span><span class="p">]</span>
            <span class="c1"># Pass modified args to imap</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">process_unsorted_rank_file</span><span class="p">,</span> <span class="n">args_for_unsorted</span><span class="p">):</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


            <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Add delay after progress bars if enabled</span>
            <span class="k">if</span> <span class="n">progress_delay</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">paced_mode</span><span class="p">:</span>
                <span class="n">show_progress_delay</span><span class="p">(</span><span class="n">progress_delay</span><span class="p">)</span>

            <span class="n">unsorted_energy_list</span> <span class="o">=</span> <span class="n">results</span>

        <span class="c1"># Add separator line after tqdm progress bar</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Remove any files that failed to process</span>
        <span class="n">unsorted_energy_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unsorted_energy_list</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unsorted_energy_list</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid unsorted energy data found.&quot;</span><span class="p">)</span>
            <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No valid unsorted energy data found.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No unsorted snapshot files found for energy plots.&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No unsorted snapshot files found for energy plots.&quot;</span><span class="p">)</span>

    <span class="c1"># Get the maximum available snapshot number</span>
    <span class="n">max_available_snap</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">all_rank_files</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">all_rank_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">max_available_snap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># If end_snap is 0, use the maximum available snapshot</span>
    <span class="n">local_end_snap</span> <span class="o">=</span> <span class="n">end_snap</span>
    <span class="k">if</span> <span class="n">local_end_snap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">local_end_snap</span> <span class="o">=</span> <span class="n">max_available_snap</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using snapshot range: </span><span class="si">{</span><span class="n">start_snap</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">local_end_snap</span><span class="si">}</span><span class="s2"> with step </span><span class="si">{</span><span class="n">step_snap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Filter files based on start, end, and step parameters</span>
    <span class="n">filtered_rank_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_rank_files</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">snap_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">start_snap</span> <span class="o">&lt;=</span> <span class="n">snap_num</span> <span class="o">&lt;=</span> <span class="n">local_end_snap</span> <span class="ow">and</span> <span class="p">(</span><span class="n">snap_num</span> <span class="o">-</span> <span class="n">start_snap</span><span class="p">)</span> <span class="o">%</span> <span class="n">step_snap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">filtered_rank_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_rank_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> rank sorted snapshot files in the specified range.&quot;</span><span class="p">)</span>

    <span class="c1"># Sort unsorted energy data by snapshot number</span>
    <span class="k">if</span> <span class="n">unsorted_energy_list</span><span class="p">:</span>
        <span class="n">unsorted_energy_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


    <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Particle snapshot data processing complete.&quot;</span><span class="p">)</span>
    <span class="c1"># Add blank line after completion message</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Return the processed data</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">unsorted_energy_list</span></div>


<div class="viewcode-block" id="generate_unsorted_energy_plot">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.generate_unsorted_energy_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_unsorted_energy_plot</span><span class="p">(</span><span class="n">unsorted_energy_list</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate energy plot from unsorted rank files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    unsorted_energy_list : list</span>
<span class="sd">        Pre-processed unsorted energy data.</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or None</span>
<span class="sd">        Path to the generated plot file, or None if no plot was generated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unsorted_energy_list</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No unsorted energy data available for plotting.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Get snapshot numbers</span>
    <span class="n">unsorted_snaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">snap</span> <span class="k">for</span> <span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="n">unsorted_energy_list</span><span class="p">]</span>

    <span class="c1"># Extract tfinal_factor from suffix if possible</span>
    <span class="c1"># Format is typically _[file_tag]_npts_Ntimes_tfinal_factor</span>
    <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Default value</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="c1"># Use default if parsing fails</span>
            <span class="k">pass</span>

    <span class="c1"># Convert snapshot numbers to dynamical times</span>
    <span class="n">total_snapshots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unsorted_snaps</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total_snapshots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dyn_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">snap</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_snapshots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tfinal_factor</span> <span class="k">for</span> <span class="n">snap</span> <span class="ow">in</span> <span class="n">unsorted_snaps</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dyn_times</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Default if only one snapshot</span>

    
    <span class="n">unsorted_E_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span> <span class="k">for</span> <span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="n">unsorted_energy_list</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">unsorted_E_matrix</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">unsorted_E_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">unsorted_E_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">unsorted_E_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dyn_times</span><span class="p">,</span> <span class="n">unsorted_E_matrix</span><span class="p">[:,</span> <span class="n">row_idx</span><span class="p">])</span> <span class="c1"># Labels removed for clarity</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t$ ($t_{\rm dyn}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathcal</span><span class="si">{E}</span><span class="s1">$ (km$^2$/s$^2$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Energy vs. Time (Random Sample)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="c1"># Legend removed</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/Energy_vs_timestep_unsorted</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved unsorted energy plot: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Return the output file path for progress tracking</span>
        <span class="k">return</span> <span class="n">output_file</span>

    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="generate_sorted_energy_plot">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.generate_sorted_energy_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_sorted_energy_plot</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate energy plot from sorted rank files (particles with lowest initial radius).</span>

<span class="sd">    Uses the efficient `process_sorted_energy_file` worker which employs </span>
<span class="sd">    seek-based loading to extract energy data only for specific particles. </span>
<span class="sd">    Processes results iteratively to build the final matrix, avoiding </span>
<span class="sd">    intermediate data accumulation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or None</span>
<span class="sd">        Path to the generated plot file, or None if no plot was generated.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function uses memory-efficient file reading by:</span>
<span class="sd">    1. Identifying specific particle IDs to track</span>
<span class="sd">    2. Using optimized file reading that seeks to specific rows</span>
<span class="sd">    3. Processing data incrementally to avoid large intermediate arrays</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load the particle IDs to track (particles with lowest initial radius)</span>
        <span class="n">lowest_radius_ids_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/lowest_radius_ids</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>

        <span class="c1"># Load the lowest_radius_ids file using the binary file handler</span>
        <span class="n">id_data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">lowest_radius_ids_file</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">id_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load particle IDs from </span><span class="si">{</span><span class="n">lowest_radius_ids_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Extract the first 10 particles to track (or fewer if less available)</span>
        <span class="n">max_particles</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">id_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">tracked_radii</span> <span class="o">=</span> <span class="n">id_data</span><span class="p">[:</span><span class="n">max_particles</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Update the global tracked_ids_for_energy</span>
        <span class="k">global</span> <span class="n">tracked_ids_for_energy</span>
        <span class="n">tracked_ids_for_energy</span> <span class="o">=</span> <span class="n">id_data</span><span class="p">[:</span><span class="n">max_particles</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Collect unsorted data for these specific particles in parallel</span>
        <span class="n">unsorted_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/Rank_Mass_Rad_VRad_unsorted_t*</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
        <span class="n">unsorted_files_for_sort</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">unsorted_pattern</span><span class="p">)</span>

        <span class="c1"># Filter to keep ONLY files that match the exact pattern without any extra characters between &quot;t00001&quot; and the suffix</span>
        <span class="n">correct_unsorted_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;data/Rank_Mass_Rad_VRad_unsorted_t\d+&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\.dat$&#39;</span><span class="p">)</span>
        <span class="n">unsorted_files_for_sort</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">unsorted_files_for_sort</span> <span class="k">if</span> <span class="n">correct_unsorted_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>

        <span class="c1"># Log the number of files found after filtering</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unsorted_files_for_sort</span><span class="p">)</span><span class="si">}</span><span class="s2"> files for sorted energy plot after filtering.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">unsorted_files_for_sort</span><span class="p">:</span>
            <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No unsorted files found for sorted energy plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Process files in parallel using the global function</span>
        <span class="c1"># Log detailed info to file but show condensed version on console</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unsorted_files_for_sort</span><span class="p">)</span><span class="si">}</span><span class="s2"> files for energy-time plot...&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="c1"># Use a custom tqdm instance with two progress displays</span>
            <span class="c1"># First, create a standard tqdm for the counter on the first line</span>
            <span class="c1"># Determine description and format dynamically</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">term_width</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">term_width</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Fallback width</span>
            <span class="n">selected_desc</span><span class="p">,</span> <span class="n">selected_bar_format</span> <span class="o">=</span> <span class="n">select_tqdm_format</span><span class="p">(</span><span class="s1">&#39;proc_energy_series&#39;</span><span class="p">,</span> <span class="n">term_width</span><span class="p">)</span>
            
            <span class="n">counter_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unsorted_files_for_sort</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">selected_desc</span><span class="p">,</span>
                <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span>
                <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Position 0 to be the first bar shown</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Keep the progress bar visible after completion</span>
                <span class="n">miniters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># Allow adapting to terminal width</span>
                <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">bar_format</span><span class="o">=</span><span class="n">selected_bar_format</span>
            <span class="p">)</span>


            <span class="n">bar_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unsorted_files_for_sort</span><span class="p">),</span>
                <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># Position 1 to appear below the counter</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Keep the progress bar visible after completion</span>
                <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{bar}</span><span class="s2"> </span><span class="si">{percentage:3.1f}</span><span class="s2">%&quot;</span><span class="p">,</span>
                <span class="n">ascii</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># Use Unicode block characters</span>
            <span class="p">)</span>

            <span class="c1"># Process the files with a custom callback to update both progress bars</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Prepare arguments for the worker, including the suffix</span>
            <span class="n">args_for_sorted_energy</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fname</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">unsorted_files_for_sort</span><span class="p">]</span>
            <span class="c1"># Pass the modified arguments</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">process_sorted_energy_file</span><span class="p">,</span> <span class="n">args_for_sorted_energy</span><span class="p">):</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


            <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># Add delay after progress bars if enabled</span>
            <span class="k">if</span> <span class="n">progress_delay</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">paced_mode</span><span class="p">:</span>
                <span class="n">show_progress_delay</span><span class="p">(</span><span class="n">progress_delay</span><span class="p">)</span>

            <span class="c1"># Add a separator line after processing</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>

            <span class="n">sorted_energy_list</span> <span class="o">=</span> <span class="n">results</span>

        <span class="c1"># Remove any files that failed to process</span>
        <span class="n">sorted_energy_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sorted_energy_list</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sorted_energy_list</span><span class="p">:</span>
            <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No valid data found for energy-time sorted plot.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">sorted_energy_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sorted_snaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">snap</span> <span class="k">for</span> <span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sorted_energy_list</span><span class="p">]</span>

        <span class="c1"># Preallocate a matrix of NaN values with shape (num_snapshots, num_particles)</span>
        <span class="n">num_snapshots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_energy_list</span><span class="p">)</span>
        <span class="n">expected_particles</span> <span class="o">=</span> <span class="n">max_particles</span>

        <span class="c1"># Create a matrix filled with NaN values initially</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating energy matrix for </span><span class="si">{</span><span class="n">num_snapshots</span><span class="si">}</span><span class="s2"> snapshots and </span><span class="si">{</span><span class="n">expected_particles</span><span class="si">}</span><span class="s2"> particles&quot;</span><span class="p">)</span>
        <span class="n">sorted_E_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_snapshots</span><span class="p">,</span> <span class="n">expected_particles</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Fill in the actual values from each snapshot</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">snap</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_energy_list</span><span class="p">):</span>
            <span class="c1"># Log useful information about the data shape</span>
            <span class="n">particle_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">expected_particles</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Snapshot </span><span class="si">{</span><span class="n">snap</span><span class="si">}</span><span class="s2">: Found </span><span class="si">{</span><span class="n">particle_count</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">expected_particles</span><span class="si">}</span><span class="s2"> expected particles&quot;</span><span class="p">)</span>

            <span class="c1"># Fill in available data (may be fewer than expected_particles)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">expected_particles</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># Make sure we don&#39;t exceed the data bounds</span>
                    <span class="n">sorted_E_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="c1"># Column 5 is energy</span>

        <span class="c1"># Log the final data shape</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final energy matrix shape: </span><span class="si">{</span><span class="n">sorted_E_matrix</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Extract tfinal_factor from suffix for time conversion</span>
        <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Default value</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="c1"># Use default if parsing fails</span>
                <span class="k">pass</span>

        <span class="c1"># Convert snapshot numbers to dynamical times once (for all particles)</span>
        <span class="n">total_snapshots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_snaps</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total_snapshots</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dyn_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">snap</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_snapshots</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tfinal_factor</span> <span class="k">for</span> <span class="n">snap</span> <span class="ow">in</span> <span class="n">sorted_snaps</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dyn_times</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Default if only one snapshot</span>

        <span class="c1"># Extract initial energies from the first snapshot</span>
        <span class="n">initial_energies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">sorted_energy_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_energy_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">first_snap</span><span class="p">,</span> <span class="n">first_data</span> <span class="o">=</span> <span class="n">sorted_energy_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">first_data</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracked_ids_for_energy</span><span class="p">):</span>
                    <span class="n">initial_energies</span><span class="p">[</span><span class="n">tracked_ids_for_energy</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Energy is in column 5</span>

        <span class="k">if</span> <span class="n">sorted_E_matrix</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">sorted_E_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sorted_E_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">max_particles</span><span class="p">,</span> <span class="n">sorted_E_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">particle_id</span> <span class="o">=</span> <span class="n">tracked_ids_for_energy</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]</span>
                <span class="n">init_e</span> <span class="o">=</span> <span class="n">initial_energies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">particle_id</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>

                <span class="c1"># Format initial energy with scientific notation if it&#39;s a number</span>
                <span class="k">if</span> <span class="n">init_e</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span><span class="p">:</span>
                    <span class="n">init_e_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">init_e</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">init_e_str</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>

                <span class="c1"># Get the data for this particle</span>
                <span class="n">particle_data</span> <span class="o">=</span> <span class="n">sorted_E_matrix</span><span class="p">[:,</span> <span class="n">row_idx</span><span class="p">]</span>

                <span class="c1"># Check if we have any non-NaN data for this particle</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">particle_data</span><span class="p">)):</span>
                    <span class="c1"># Use masked array to ignore NaN values</span>
                    <span class="n">valid_indices</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">particle_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">):</span>
                        <span class="n">valid_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dyn_times</span><span class="p">)[</span><span class="n">valid_indices</span><span class="p">]</span>
                        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">particle_data</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>

                        <span class="c1"># Log how much data was found for this particle</span>
                        <span class="n">data_percentage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Particle </span><span class="si">{</span><span class="n">particle_id</span><span class="si">}</span><span class="s2">: Found </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span><span class="si">}</span><span class="s2"> data points (</span><span class="si">{</span><span class="n">data_percentage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

                        <span class="c1"># Only plot if at least some valid data points exist</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                             <span class="c1"># Use LaTeX for legend</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">valid_times</span><span class="p">,</span> <span class="n">valid_data</span><span class="p">,</span>
                                     <span class="n">label</span><span class="o">=</span><span class="sa">fr</span><span class="s2">&quot;ID </span><span class="si">{</span><span class="n">particle_id</span><span class="si">}</span><span class="s2"> ($r_0$=</span><span class="si">{</span><span class="n">tracked_radii</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, $\mathcal</span><span class="se">{{</span><span class="s2">E</span><span class="se">}}</span><span class="s2">_0$=</span><span class="si">{</span><span class="n">init_e_str</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid data for particle ID </span><span class="si">{</span><span class="n">particle_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data available for particle ID </span><span class="si">{</span><span class="n">particle_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t$ ($t_{\rm dyn}$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathcal</span><span class="si">{E}</span><span class="s1">$ (km$^2$/s$^2$)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Energy vs. Time (Lowest Initial Radius)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="c1"># Legend removed for clarity</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/Energy_vs_timestep_sorted</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved sorted energy plot: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Return the output file path for progress tracking</span>
            <span class="k">return</span> <span class="n">output_file</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate energy-time sorted plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="create_mass_animation">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.create_mass_animation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_mass_animation</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create mass profile animation with optional robust ranging.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>
<span class="sd">    duration : float</span>
<span class="sd">        Duration of each frame in milliseconds.</span>
<span class="sd">    config : object, optional</span>
<span class="sd">        Configuration object containing plot settings. If provided and has</span>
<span class="sd">        use_median_ranges=True, will use robust ranging for axes.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Function does not return a value, but saves the animation to a file.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses parallel processing for rendering animation frames.</span>
<span class="sd">    Saves the animation incrementally using `imageio.get_writer` to reduce</span>
<span class="sd">    peak memory usage compared to collecting all frames first.</span>
<span class="sd">    Requires imageio v2 (`pip install imageio==2.*`).</span>
<span class="sd">    With robust ranging enabled, calculates data-driven axis limits based</span>
<span class="sd">    on the median of the data distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">mass_snapshots</span><span class="p">,</span> <span class="n">mass_max_value</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mass_snapshots</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No mass data available for animation.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
        
    <span class="c1"># Calculate global maximum values for consistent scaling</span>
    <span class="n">calculate_global_max_values</span><span class="p">()</span>

    <span class="n">total_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mass_snapshots</span><span class="p">)</span>
    <span class="c1"># Log detailed info to file only</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating mass profile frames for </span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2"> snapshots...&quot;</span><span class="p">)</span>

    <span class="c1"># Extract tfinal_factor from suffix if possible</span>
    <span class="c1"># Format is typically _[file_tag]_npts_Ntimes_tfinal_factor</span>
    <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Default value</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="c1"># Use default if parsing fails</span>
            <span class="k">pass</span>
            
    <span class="c1"># Calculate axis ranges for consistent plotting</span>
    <span class="n">x_range</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">_calculate_profile_animation_ranges</span><span class="p">(</span>
        <span class="n">mass_snapshots</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">data_index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">x_default_max</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span>
        <span class="n">animation_name</span><span class="o">=</span><span class="s2">&quot;Mass&quot;</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">x_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Use calculated ranges</span>
        <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">x_range</span>
        <span class="n">m_min</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Mass is always non-negative</span>
        <span class="n">mass_max_value</span> <span class="o">=</span> <span class="n">y_max</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Original hardcoded logic</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">mass_snapshots</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>  <span class="c1"># Cap at 200 kpc for reasonable display</span>
        <span class="n">r_min</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Mass profiles always start at r=0</span>
        <span class="n">m_min</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Mass is always non-negative</span>

    <span class="c1"># Create frame_data tuples with the actual snapshot data and range information</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mass_snapshots</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Error: mass_snapshots list is empty before pool creation.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1"># Handle error appropriately</span>
    <span class="n">frame_data_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">mass_snapshots</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tfinal_factor</span><span class="p">,</span> <span class="n">total_frames</span><span class="p">,</span> 
                        <span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">),</span> <span class="p">(</span><span class="n">m_min</span><span class="p">,</span> <span class="n">mass_max_value</span><span class="p">),</span> <span class="n">PROJECT_ROOT</span><span class="p">)</span> 
                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_frames</span><span class="p">)]</span>

    <span class="c1"># Set up imageio writer</span>
    <span class="n">mass_anim_output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/Mass_Profile_Animation</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.gif&quot;</span>
    <span class="c1"># Use seconds per frame for imageio v2 duration</span>
    <span class="n">frame_duration_sec_v2</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">/</span> <span class="mf">1000.0</span> <span class="c1"># Convert ms to seconds</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use mode=&#39;I&#39; for multiple images, loop=0 for infinite loop</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">get_writer</span><span class="p">(</span>
            <span class="n">mass_anim_output</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GIF-PIL&#39;</span><span class="p">,</span>        <span class="c1"># Explicitly use Pillow</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="c1"># quantizer=&#39;nq&#39;,          # Temporarily removed</span>
            <span class="n">palettesize</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>         <span class="c1"># Ensure full palette</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">frame_duration_sec_v2</span><span class="p">,</span>
            <span class="n">loop</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating GIF writer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1"># Cannot proceed without writer</span>

    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="c1"># Use a custom tqdm instance with two progress displays</span>
        <span class="c1"># First, create a standard tqdm for the counter on the first line</span>
        <span class="c1"># Determine description and format dynamically</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">term_width</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">term_width</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Fallback width</span>
        <span class="n">selected_desc</span><span class="p">,</span> <span class="n">selected_bar_format</span> <span class="o">=</span> <span class="n">select_tqdm_format</span><span class="p">(</span><span class="s1">&#39;gen_mass_frames&#39;</span><span class="p">,</span> <span class="n">term_width</span><span class="p">)</span>
        
        <span class="n">counter_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_frames</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">selected_desc</span><span class="p">,</span> <span class="c1"># Use dynamic description</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">,</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">miniters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="n">selected_bar_format</span>
        <span class="p">)</span>


        <span class="n">bar_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_frames</span><span class="p">,</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{bar}</span><span class="s2"> </span><span class="si">{percentage:3.1f}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="n">ascii</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Process the frames and append directly to the writer</span>
        <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">frame_image</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">render_mass_frame</span><span class="p">,</span> <span class="n">frame_data_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">frame_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">frame_image</span><span class="p">)</span> <span class="c1"># Append directly to writer</span>
                    <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error appending frame </span><span class="si">{</span><span class="n">frame_count</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="c1"># Update progress bars</span>
            <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


        <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Close the writer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing GIF writer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

        <span class="c1"># No delay between frame generation and animation saving to improve fluidity</span>

    <span class="c1"># Log to file</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated and saved </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2"> mass profile frames successfully to </span><span class="si">{</span><span class="n">mass_anim_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frame_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Animation saved: </span><span class="si">{</span><span class="n">get_file_prefix</span><span class="p">(</span><span class="n">mass_anim_output</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Add separator line after animation completion</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Failed to generate any mass profile frames.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Encourage garbage collection</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_density_animation">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.create_density_animation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_density_animation</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create density profile animation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>
<span class="sd">    duration : float</span>
<span class="sd">        Duration of each frame in milliseconds.</span>
<span class="sd">    config : Configuration, optional</span>
<span class="sd">        Configuration object containing plot settings. If provided,</span>
<span class="sd">        enables robust dynamic ranging for axes.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Function does not return a value, but saves the animation to a file.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses parallel processing for rendering animation frames.</span>
<span class="sd">    Saves the animation incrementally using `imageio.get_writer` to reduce</span>
<span class="sd">    peak memory usage compared to collecting all frames first.</span>
<span class="sd">    Requires imageio v2 (`pip install imageio==2.*`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">density_snapshots</span><span class="p">,</span> <span class="n">density_max_value</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">density_snapshots</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No density data available for animation.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
        
    <span class="c1"># Calculate global maximum values for consistent scaling</span>
    <span class="n">x_range</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">_calculate_profile_animation_ranges</span><span class="p">(</span>
        <span class="n">density_snapshots</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">data_index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">x_default_max</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span>
        <span class="n">animation_name</span><span class="o">=</span><span class="s2">&quot;Density&quot;</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">y_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">density_max_value</span> <span class="o">=</span> <span class="n">y_max</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">calculate_global_max_values</span><span class="p">()</span>

    <span class="n">total_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">density_snapshots</span><span class="p">)</span>
    <span class="c1"># Log detailed info to file only</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating density profile frames for </span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2"> snapshots...&quot;</span><span class="p">)</span>

    <span class="c1"># Extract tfinal_factor from suffix if possible</span>
    <span class="c1"># Format is typically _[file_tag]_npts_Ntimes_tfinal_factor</span>
    <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Default value</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="c1"># Use default if parsing fails</span>
            <span class="k">pass</span>
            
    <span class="c1"># Calculate r_max for consistent plotting - do this once before creating the pool</span>
    <span class="k">if</span> <span class="n">x_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Use the calculated range from helper function</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Original hardcoded behavior when not using median ranges</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">density_snapshots</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>  <span class="c1"># Cap at 300 kpc for reasonable display</span>

    <span class="c1"># Create frame_data tuples with the actual snapshot data, tfinal_factor, total_frames, ranges and project_root_path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">density_snapshots</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Error: density_snapshots list is empty before pool creation.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1"># Handle error appropriately</span>
    
    <span class="c1"># Prepare range information</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;use_median_ranges&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">use_median_ranges</span><span class="p">:</span>
        <span class="c1"># Use calculated robust ranges</span>
        <span class="n">r_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>  <span class="c1"># Density profiles always start at r=0</span>
        <span class="n">d_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">density_max_value</span> <span class="k">if</span> <span class="n">density_max_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.2e10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use original behavior</span>
        <span class="n">r_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
        <span class="n">d_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">density_max_value</span> <span class="k">if</span> <span class="n">density_max_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.2e10</span><span class="p">)</span>
    
    <span class="n">frame_data_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">density_snapshots</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tfinal_factor</span><span class="p">,</span> <span class="n">total_frames</span><span class="p">,</span> <span class="n">r_range</span><span class="p">,</span> <span class="n">d_range</span><span class="p">,</span> <span class="n">PROJECT_ROOT</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_frames</span><span class="p">)]</span>

    <span class="c1"># Set up imageio writer</span>
    <span class="n">density_anim_output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/Density_Profile_Animation</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.gif&quot;</span>
    <span class="c1"># Use seconds per frame for imageio v2 duration</span>
    <span class="n">frame_duration_sec_v2</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">/</span> <span class="mf">1000.0</span> <span class="c1"># Convert ms to seconds</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use mode=&#39;I&#39; for multiple images, loop=0 for infinite loop</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">get_writer</span><span class="p">(</span>
            <span class="n">density_anim_output</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GIF-PIL&#39;</span><span class="p">,</span>        <span class="c1"># Explicitly use Pillow</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="c1"># quantizer=&#39;nq&#39;,          # Temporarily removed</span>
            <span class="n">palettesize</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>         <span class="c1"># Ensure full palette</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">frame_duration_sec_v2</span><span class="p">,</span>
            <span class="n">loop</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating GIF writer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1"># Cannot proceed without writer</span>

    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="c1"># Use a custom tqdm instance with two progress displays</span>
        <span class="c1"># First, create a standard tqdm for the counter on the first line</span>
        <span class="c1"># Determine description and format dynamically</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">term_width</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">term_width</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Fallback width</span>
        <span class="n">selected_desc</span><span class="p">,</span> <span class="n">selected_bar_format</span> <span class="o">=</span> <span class="n">select_tqdm_format</span><span class="p">(</span><span class="s1">&#39;gen_dens_frames&#39;</span><span class="p">,</span> <span class="n">term_width</span><span class="p">)</span>
        
        <span class="n">counter_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_frames</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">selected_desc</span><span class="p">,</span> <span class="c1"># Use dynamic description</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">,</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">miniters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="n">selected_bar_format</span>
        <span class="p">)</span>


        <span class="n">bar_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_frames</span><span class="p">,</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{bar}</span><span class="s2"> </span><span class="si">{percentage:3.1f}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="n">ascii</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Process the frames and append directly to the writer</span>
        <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">frame_image</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">render_density_frame</span><span class="p">,</span> <span class="n">frame_data_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">frame_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">frame_image</span><span class="p">)</span> <span class="c1"># Append directly to writer</span>
                    <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error appending frame </span><span class="si">{</span><span class="n">frame_count</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="c1"># Update progress bars</span>
            <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


        <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Close the writer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing GIF writer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

        <span class="c1"># No delay between frame generation and animation saving to improve fluidity</span>

    <span class="c1"># Log to file</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated and saved </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2"> density profile frames successfully to </span><span class="si">{</span><span class="n">density_anim_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frame_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Animation saved: </span><span class="si">{</span><span class="n">get_file_prefix</span><span class="p">(</span><span class="n">density_anim_output</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Add separator line after animation completion</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Failed to generate any density profile frames.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Encourage garbage collection</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_psi_animation">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.create_psi_animation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_psi_animation</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create psi profile animation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>
<span class="sd">    duration : float</span>
<span class="sd">        Duration of each frame in milliseconds.</span>
<span class="sd">    config : Configuration, optional</span>
<span class="sd">        Configuration object containing plot settings. If provided,</span>
<span class="sd">        enables robust dynamic ranging for axes.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">        Function does not return a value, but saves the animation to a file.</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses parallel processing for rendering animation frames.</span>
<span class="sd">    Saves the animation incrementally using `imageio.get_writer` to reduce</span>
<span class="sd">    peak memory usage compared to collecting all frames first.</span>
<span class="sd">    Requires imageio v2 (`pip install imageio==2.*`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">psi_snapshots</span><span class="p">,</span> <span class="n">psi_max_value</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi_snapshots</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;No psi data available for animation.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
        
    <span class="c1"># Calculate global maximum values for consistent scaling</span>
    <span class="n">x_range</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">_calculate_profile_animation_ranges</span><span class="p">(</span>
        <span class="n">psi_snapshots</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">data_index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">x_default_max</span><span class="o">=</span><span class="mf">250.0</span><span class="p">,</span>
        <span class="n">animation_name</span><span class="o">=</span><span class="s2">&quot;Psi&quot;</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">y_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">psi_max_value</span> <span class="o">=</span> <span class="n">y_max</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">calculate_global_max_values</span><span class="p">()</span>

    <span class="n">total_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psi_snapshots</span><span class="p">)</span>
    <span class="c1"># Log detailed info to file only</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating psi profile frames for </span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2"> snapshots...&quot;</span><span class="p">)</span>

    <span class="c1"># Extract tfinal_factor from suffix if possible</span>
    <span class="c1"># Format is typically _[file_tag]_npts_Ntimes_tfinal_factor</span>
    <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Default value</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tfinal_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="c1"># Use default if parsing fails</span>
            <span class="k">pass</span>
            
    <span class="c1"># Calculate r_max for consistent plotting - do this once before creating the pool</span>
    <span class="k">if</span> <span class="n">x_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Use the calculated range from helper function</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Original hardcoded behavior when not using median ranges</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">psi_snapshots</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>  <span class="c1"># Cap at 250 kpc for reasonable display</span>

    <span class="c1"># Create frame_data tuples with the actual snapshot data, tfinal_factor, total_frames, ranges and project_root_path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">psi_snapshots</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Error: psi_snapshots list is empty before pool creation.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1"># Handle error appropriately</span>
    
    <span class="c1"># Prepare range information</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;use_median_ranges&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">use_median_ranges</span><span class="p">:</span>
        <span class="c1"># Use calculated robust ranges</span>
        <span class="n">r_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>  <span class="c1"># Psi profiles always start at r=0</span>
        <span class="n">p_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">psi_max_value</span> <span class="k">if</span> <span class="n">psi_max_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.072</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use original behavior</span>
        <span class="n">r_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
        <span class="n">p_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">psi_max_value</span> <span class="k">if</span> <span class="n">psi_max_value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.072</span><span class="p">)</span>
    
    <span class="n">frame_data_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">psi_snapshots</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tfinal_factor</span><span class="p">,</span> <span class="n">total_frames</span><span class="p">,</span> <span class="n">r_range</span><span class="p">,</span> <span class="n">p_range</span><span class="p">,</span> <span class="n">PROJECT_ROOT</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_frames</span><span class="p">)]</span>

    <span class="c1"># Set up imageio writer</span>
    <span class="n">psi_anim_output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/Psi_Profile_Animation</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.gif&quot;</span>
    <span class="c1"># Use seconds per frame for imageio v2 duration</span>
    <span class="n">frame_duration_sec_v2</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">/</span> <span class="mf">1000.0</span> <span class="c1"># Convert ms to seconds</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use mode=&#39;I&#39; for multiple images, loop=0 for infinite loop</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">imageio</span><span class="o">.</span><span class="n">get_writer</span><span class="p">(</span>
            <span class="n">psi_anim_output</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;GIF-PIL&#39;</span><span class="p">,</span>        <span class="c1"># Explicitly use Pillow</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span>
            <span class="c1"># quantizer=&#39;nq&#39;,          # Temporarily removed</span>
            <span class="n">palettesize</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>         <span class="c1"># Ensure full palette</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">frame_duration_sec_v2</span><span class="p">,</span>
            <span class="n">loop</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating GIF writer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1"># Cannot proceed without writer</span>

    <span class="k">with</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="c1"># Use a custom tqdm instance with two progress displays</span>
        <span class="c1"># First, create a standard tqdm for the counter on the first line</span>
        <span class="c1"># Determine description and format dynamically</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">term_width</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">term_width</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Fallback width</span>
        <span class="n">selected_desc</span><span class="p">,</span> <span class="n">selected_bar_format</span> <span class="o">=</span> <span class="n">select_tqdm_format</span><span class="p">(</span><span class="s1">&#39;gen_psi_frames&#39;</span><span class="p">,</span> <span class="n">term_width</span><span class="p">)</span>
        
        <span class="n">counter_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_frames</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="n">selected_desc</span><span class="p">,</span> <span class="c1"># Use dynamic description</span>
            <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;frame&quot;</span><span class="p">,</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">miniters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="n">selected_bar_format</span>
        <span class="p">)</span>


        <span class="n">bar_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_frames</span><span class="p">,</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{bar}</span><span class="s2"> </span><span class="si">{percentage:3.1f}</span><span class="s2">%&quot;</span><span class="p">,</span>
            <span class="n">ascii</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Process the frames and append directly to the writer</span>
        <span class="n">frame_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">frame_image</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">render_psi_frame</span><span class="p">,</span> <span class="n">frame_data_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">frame_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">frame_image</span><span class="p">)</span> <span class="c1"># Append directly to writer</span>
                    <span class="n">frame_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error appending frame </span><span class="si">{</span><span class="n">frame_count</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="c1"># Update progress bars</span>
            <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


        <span class="n">counter_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">bar_tqdm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c1"># Close the writer</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing GIF writer: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>

        <span class="c1"># No delay between frame generation and animation saving to improve fluidity</span>

    <span class="c1"># Log to file</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated and saved </span><span class="si">{</span><span class="n">frame_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_frames</span><span class="si">}</span><span class="s2"> psi profile frames successfully to </span><span class="si">{</span><span class="n">psi_anim_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frame_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Animation saved: </span><span class="si">{</span><span class="n">get_file_prefix</span><span class="p">(</span><span class="n">psi_anim_output</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Add separator line after animation completion</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Failed to generate any psi profile frames.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Encourage garbage collection</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>


<div class="viewcode-block" id="process_single_rank_file_for_histogram">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_single_rank_file_for_histogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_single_rank_file_for_histogram</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a single rank file (snapshot 0) for generating a histogram.</span>
<span class="sd">    This is more efficient than processing all snapshots when we only need one.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray or None</span>
<span class="sd">        The processed data from snapshot 0, or None if not available.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find the initial snapshot file</span>
    <span class="n">initial_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/Rank_Mass_Rad_VRad_sorted_t00000</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>

    <span class="c1"># If the initial file doesn&#39;t exist, try to find any sorted rank file</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">initial_file</span><span class="p">):</span>
        <span class="n">rank_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;data/Rank_Mass_Rad_VRad_sorted_t*</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rank_files</span><span class="p">:</span>
            <span class="c1"># Sort files to ensure we get the earliest snapshot</span>
            <span class="n">rank_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">initial_file</span> <span class="o">=</span> <span class="n">rank_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No rank files found for histogram.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>


    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">initial_file</span><span class="p">,</span> <span class="n">ncol_Rank_Mass_Rad_VRad_sorted</span><span class="p">,</span>
                                  <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data to process in </span><span class="si">{</span><span class="n">initial_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="generate_rank_histogram">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.generate_rank_histogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_rank_histogram</span><span class="p">(</span><span class="n">rank_decimated_data</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate 2D histogram from rank data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rank_decimated_data : list or numpy.ndarray</span>
<span class="sd">        Processed rank data, either as a list of (snap, data) tuples</span>
<span class="sd">        or as a single data array for a specific snapshot.</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix for input/output files.</span>
<span class="sd">    output_file : str, optional</span>
<span class="sd">        Custom output file path. If None, a default path will be used.</span>
<span class="sd">    config : dict, optional</span>
<span class="sd">        Configuration dictionary with plot settings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating histograms from rank data...&quot;</span><span class="p">)</span>

    <span class="c1"># Check if input is a list of (snap, data) tuples or a single data array</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rank_decimated_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Processing list of (snap, data) tuples - locate snapshot 0</span>
        <span class="n">initial_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">snap</span><span class="p">,</span> <span class="n">decimated</span> <span class="ow">in</span> <span class="n">rank_decimated_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">snap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">initial_data</span> <span class="o">=</span> <span class="n">decimated</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">initial_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No initial snapshot found in the existing data&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Processing single data array (from process_single_rank_file_for_histogram)</span>
        <span class="n">initial_data</span> <span class="o">=</span> <span class="n">rank_decimated_data</span>

    <span class="c1"># Extract columns from the decimated data</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="n">initial_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">masses</span> <span class="o">=</span> <span class="n">initial_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">initial_data</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">vrad</span> <span class="o">=</span> <span class="n">initial_data</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">initial_data</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">initial_data</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">angular_momentum</span> <span class="o">=</span> <span class="n">initial_data</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span>

    <span class="c1"># Calculate total velocity (including angular momentum component)</span>
    <span class="c1"># Filter out zero radii before division</span>
    <span class="n">nonzero_mask</span> <span class="o">=</span> <span class="n">radii</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">radii_nz</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">vrad_nz</span> <span class="o">=</span> <span class="n">vrad</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>
    <span class="n">angular_momentum_nz</span> <span class="o">=</span> <span class="n">angular_momentum</span><span class="p">[</span><span class="n">nonzero_mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii_nz</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No particles with non-zero radius found in rank data for histogram.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Calculate the total velocity in simulation internal units</span>
    <span class="n">total_velocity_internal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vrad_nz</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">angular_momentum_nz</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">radii_nz</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

    <span class="c1"># Convert to km/s</span>
    <span class="n">kmsec_to_kpcmyr</span> <span class="o">=</span> <span class="mf">1.0227e-3</span>  <span class="c1"># Conversion factor</span>
    <span class="n">total_velocity</span> <span class="o">=</span> <span class="n">total_velocity_internal</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">kmsec_to_kpcmyr</span><span class="p">)</span>

    <span class="c1"># Set up histogram parameters using robust ranging</span>
    <span class="c1"># Calculate dynamic ranges using the robust range helper</span>
    <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
        <span class="n">radii_nz</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile</span><span class="p">,</span>
        <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile_multiplier</span><span class="p">,</span>
        <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_x_range_abs</span><span class="p">,</span>
        <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;radius&quot;</span>
    <span class="p">)</span>
    
    <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
        <span class="n">total_velocity</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile</span><span class="p">,</span>
        <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile_multiplier</span><span class="p">,</span>
        <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_y_range_abs</span><span class="p">,</span> 
        <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">320.0</span><span class="p">),</span> <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;velocity&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Create the 2D histogram using non-zero radius data</span>
    <span class="n">hist</span><span class="p">,</span> <span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span>
        <span class="n">radii_nz</span><span class="p">,</span>
        <span class="n">total_velocity</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">[[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">],</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]]</span>
    <span class="p">)</span>

    <span class="c1"># Transpose for correct orientation</span>
    <span class="n">hist</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">T</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span><span class="p">,</span> <span class="n">hist</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Counts&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Initial Phase Space Distribution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Define default output filename</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/part_data_histogram_initial</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Log to file (progress tracking by the caller)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram saved: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_file</span></div>


<div class="viewcode-block" id="process_variable_histograms">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.process_variable_histograms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_variable_histograms</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates 1D variable distribution histograms comparing initial vs final distributions.</span>
<span class="sd">    Creates histograms for radius, velocity, radial velocity, and angular momentum.</span>
<span class="sd">    </span>
<span class="sd">    Note: This function creates 1D distributions, not 2D phase space plots,</span>
<span class="sd">    so it does not require robust ranging modifications.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : Configuration</span>
<span class="sd">        The configuration object containing parsed arguments and settings.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if successful, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating 1D Variable Distribution Histograms&quot;</span><span class="p">)</span>
    
    <span class="c1"># Determine file paths directly within this function</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">suffix</span>
    <span class="n">initial_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/particles</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
    <span class="n">final_unsorted_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">unsorted_pattern_glob</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;data/Rank_Mass_Rad_VRad_unsorted_t*</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.dat&quot;</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searching for unsorted files: </span><span class="si">{</span><span class="n">unsorted_pattern_glob</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
    <span class="n">unsorted_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">unsorted_pattern_glob</span><span class="p">)</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unsorted_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> matching files.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">unsorted_files</span><span class="p">:</span>
        <span class="n">unsorted_regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Rank_Mass_Rad_VRad_unsorted_t(\d+)&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\.dat&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">unsorted_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">get_snapshot_number</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">unsorted_regex_pattern</span><span class="p">))</span>
            <span class="n">last_file_candidate</span> <span class="o">=</span> <span class="n">unsorted_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">get_snapshot_number</span><span class="p">(</span><span class="n">last_file_candidate</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">unsorted_regex_pattern</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">999999999</span><span class="p">:</span>
                <span class="n">final_unsorted_file</span> <span class="o">=</span> <span class="n">last_file_candidate</span>
                <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Identified last unsorted snapshot: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">final_unsorted_file</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Warning: Sorting unsorted files failed to identify latest.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Error sorting unsorted files: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Using basic sort.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
            <span class="n">unsorted_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">unsorted_files</span><span class="p">:</span> 
                <span class="n">final_unsorted_file</span> <span class="o">=</span> <span class="n">unsorted_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Prepare files_to_load_info using determined paths</span>
    <span class="n">files_to_load_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">initial_file</span><span class="p">):</span>
        <span class="n">files_to_load_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">initial_file</span><span class="p">,</span> <span class="n">ncol_particles_initial</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial particles file not found: </span><span class="si">{</span><span class="n">initial_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Initial particles file not found: </span><span class="si">{</span><span class="n">initial_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Exit the function if initial file missing</span>
        
    <span class="k">if</span> <span class="n">final_unsorted_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">final_unsorted_file</span><span class="p">):</span>
        <span class="n">files_to_load_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">final_unsorted_file</span><span class="p">,</span> <span class="n">ncol_Rank_Mass_Rad_VRad_unsorted</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Last unsorted snapshot file not found or determined for suffix </span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">log_message</span><span class="p">(</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">err_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Exit the function if final file missing</span>

    <span class="c1"># --- Data Loading Phase ---</span>
    <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Starting data loading phase.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
    <span class="n">loading_section_key</span> <span class="o">=</span> <span class="s2">&quot;diagnostic_data_loading&quot;</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="n">loading_section_key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_to_load_info</span><span class="p">))</span>
    <span class="n">loaded_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">load_success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">f_path</span><span class="p">,</span> <span class="n">f_ncol</span><span class="p">,</span> <span class="n">f_dtype</span> <span class="ow">in</span> <span class="n">files_to_load_info</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading data from: </span><span class="si">{</span><span class="n">f_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">safe_load_and_filter_bin</span><span class="p">(</span><span class="n">f_path</span><span class="p">,</span> <span class="n">f_ncol</span><span class="p">,</span> <span class="n">f_dtype</span><span class="p">)</span>
        <span class="n">loaded_data</span><span class="p">[</span><span class="n">f_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load or filter data from: </span><span class="si">{</span><span class="n">f_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
            <span class="n">load_success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">update_combined_progress</span><span class="p">(</span><span class="n">loading_section_key</span><span class="p">,</span> <span class="n">f_path</span><span class="p">)</span>  <span class="c1"># Pass file path for prefix</span>

    <span class="n">initial_raw_data</span> <span class="o">=</span> <span class="n">loaded_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">initial_file</span><span class="p">)</span>
    <span class="n">final_unsorted_raw_data</span> <span class="o">=</span> <span class="n">loaded_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">final_unsorted_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">load_success</span> <span class="ow">or</span> <span class="n">initial_raw_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">final_unsorted_raw_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Failed to load required data files.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Error: Failed to load required data files.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loading_section_key</span> <span class="ow">in</span> <span class="n">_combined_plot_trackers</span><span class="p">:</span>
            <span class="n">_combined_plot_trackers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">loading_section_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">clear_line</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Data loading complete.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>

    <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Processing particle data...&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
    <span class="n">init_r</span><span class="p">,</span> <span class="n">init_vr</span><span class="p">,</span> <span class="n">init_L</span><span class="p">,</span> <span class="n">init_vtot</span><span class="p">,</span> <span class="n">init_vperp</span> <span class="o">=</span> <span class="n">process_particle_data</span><span class="p">(</span><span class="n">initial_raw_data</span><span class="p">,</span> <span class="n">ncol_particles_initial</span><span class="p">)</span>
    <span class="n">final_r</span><span class="p">,</span> <span class="n">final_vr</span><span class="p">,</span> <span class="n">final_L</span><span class="p">,</span> <span class="n">final_vtot</span><span class="p">,</span> <span class="n">final_vperp</span> <span class="o">=</span> <span class="n">process_particle_data</span><span class="p">(</span><span class="n">final_unsorted_raw_data</span><span class="p">,</span> <span class="n">ncol_Rank_Mass_Rad_VRad_unsorted</span><span class="p">)</span>

    <span class="n">processed_data_valid</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">init_r</span><span class="p">,</span> <span class="n">init_vr</span><span class="p">,</span> <span class="n">init_L</span><span class="p">,</span> <span class="n">init_vtot</span><span class="p">,</span> <span class="n">init_vperp</span><span class="p">,</span>
                                                      <span class="n">final_r</span><span class="p">,</span> <span class="n">final_vr</span><span class="p">,</span> <span class="n">final_L</span><span class="p">,</span> <span class="n">final_vtot</span><span class="p">,</span> <span class="n">final_vperp</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">processed_data_valid</span><span class="p">:</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Could not extract valid data after processing.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Error: Could not extract valid data after processing.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Particle data processing complete.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>

    <span class="c1"># --- Define plot specifications with refined labels and titles ---</span>
    <span class="c1"># Calculate robust ranges for radius and velocity if config enables it</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;use_median_ranges&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">use_median_ranges</span><span class="p">:</span>
        <span class="c1"># Calculate robust range for radius</span>
        <span class="n">combined_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">init_r</span><span class="p">,</span> <span class="n">final_r</span><span class="p">])</span>
        <span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
            <span class="n">combined_r</span><span class="p">,</span> 
            <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile</span><span class="p">,</span>
            <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">x_percentile_multiplier</span><span class="p">,</span>
            <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_x_range_abs</span><span class="p">,</span>
            <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">),</span> 
            <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;1D radius histogram&quot;</span>
        <span class="p">)</span>
        <span class="n">radius_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">]</span>
        
        <span class="c1"># Calculate robust range for velocity</span>
        <span class="n">combined_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">init_vtot</span><span class="p">,</span> <span class="n">final_vtot</span><span class="p">])</span>
        <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span> <span class="o">=</span> <span class="n">_calculate_robust_range</span><span class="p">(</span>
            <span class="n">combined_v</span><span class="p">,</span> 
            <span class="n">percentile</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile</span><span class="p">,</span>
            <span class="n">percentile_multiplier</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">y_percentile_multiplier</span><span class="p">,</span>
            <span class="n">min_abs_extent</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">min_y_range_abs</span><span class="p">,</span>
            <span class="n">default_if_empty</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">),</span> 
            <span class="n">can_be_negative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">axis_name</span><span class="o">=</span><span class="s2">&quot;1D velocity histogram&quot;</span>
        <span class="p">)</span>
        <span class="n">velocity_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use original hardcoded ranges</span>
        <span class="n">radius_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">]</span>
        <span class="n">velocity_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
    
    <span class="n">plot_vars</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;data1&#39;</span><span class="p">:</span> <span class="n">init_r</span><span class="p">,</span> <span class="s1">&#39;data2&#39;</span><span class="p">:</span> <span class="n">final_r</span><span class="p">,</span>
         <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$r$ (kpc)&#39;</span><span class="p">,</span>
         <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;Comparison of Radius Distribution $N(r)$&#39;</span><span class="p">,</span>
         <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;radius_hist_compare</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">radius_range</span><span class="p">},</span>

        <span class="p">{</span><span class="s1">&#39;data1&#39;</span><span class="p">:</span> <span class="n">init_vtot</span><span class="p">,</span> <span class="s1">&#39;data2&#39;</span><span class="p">:</span> <span class="n">final_vtot</span><span class="p">,</span>
         <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$v$ (km/s)&#39;</span><span class="p">,</span>
         <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;Comparison of Total Velocity Distribution $N(v)$&#39;</span><span class="p">,</span>
         <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;total_velocity_histogram_compare</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="n">velocity_range</span><span class="p">},</span>

        <span class="p">{</span><span class="s1">&#39;data1&#39;</span><span class="p">:</span> <span class="n">init_vperp</span><span class="p">,</span> <span class="s1">&#39;data2&#39;</span><span class="p">:</span> <span class="n">final_vperp</span><span class="p">,</span>
         <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$v_{\perp}$ (km/s)&#39;</span><span class="p">,</span>
         <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;Comparison of Tangential Velocity Magnitude Distribution $N(v_{\perp})$&#39;</span><span class="p">,</span>
         <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;tangential_velocity_histogram_compare</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;plot_func&#39;</span><span class="p">:</span> <span class="n">plot_tangential_velocity_histogram</span><span class="p">},</span>

        <span class="p">{</span><span class="s1">&#39;data1&#39;</span><span class="p">:</span> <span class="n">init_vr</span><span class="p">,</span> <span class="s1">&#39;data2&#39;</span><span class="p">:</span> <span class="n">final_vr</span><span class="p">,</span>
         <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$v_r$ (km/s)&#39;</span><span class="p">,</span>
         <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;Comparison of Radial Velocity Distribution $N(v_r)$&#39;</span><span class="p">,</span>
         <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;radial_velocity_histogram_compare</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>  <span class="c1"># Auto range</span>

        <span class="p">{</span><span class="s1">&#39;data1&#39;</span><span class="p">:</span> <span class="n">init_L</span><span class="p">,</span> <span class="s1">&#39;data2&#39;</span><span class="p">:</span> <span class="n">final_L</span><span class="p">,</span>
         <span class="s1">&#39;xlabel&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;$\ell$ (simulation units)&#39;</span><span class="p">,</span>  <span class="c1"># Use \ell</span>
         <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;Comparison of Angular Momentum Distribution $N(\ell)$&#39;</span><span class="p">,</span>  <span class="c1"># Use \ell</span>
         <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;angular_momentum_histogram_compare</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>  <span class="c1"># Auto range</span>
    <span class="p">]</span>

    <span class="n">num_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_vars</span><span class="p">)</span>
    <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating </span><span class="si">{</span><span class="n">num_plots</span><span class="si">}</span><span class="s2"> comparison histograms...&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
    <span class="n">plots_generated</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># --- Plot Saving Phase ---</span>
    <span class="n">saving_section_key</span> <span class="o">=</span> <span class="s2">&quot;diagnostic_plot_saving&quot;</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="n">saving_section_key</span><span class="p">,</span> <span class="n">num_plots</span><span class="p">)</span>  <span class="c1"># Uses default &quot;Save:&quot;</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_vars</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
        <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating plot: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;plot_func&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>  <span class="c1"># Check if a custom plot function is specified</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;plot_func&#39;</span><span class="p">](</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;data1&#39;</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;data2&#39;</span><span class="p">],</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">plot_range</span><span class="o">=</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">))</span>
                <span class="n">plots_generated</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">update_combined_progress</span><span class="p">(</span><span class="n">saving_section_key</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
                <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">clear_line</span><span class="p">()</span>
                <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating plot </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error generating plot for </span><span class="si">{</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">update_combined_progress</span><span class="p">(</span><span class="n">saving_section_key</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>  <span class="c1"># Pass path for prefix</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Original histogram plotting logic</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">hist_range</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">hist_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;data1&#39;</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;data2&#39;</span><span class="p">]))</span>
                <span class="n">finite</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">combined</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">finite</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
                    <span class="n">hist_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">finite</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">finite</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">hist_range</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;data1&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;data2&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">hist_range</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Final&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized Frequency&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>  <span class="c1"># Match nsphere_plot grid style</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>  <span class="c1"># Consistent DPI</span>
                <span class="n">plots_generated</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">update_combined_progress</span><span class="p">(</span><span class="n">saving_section_key</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
                <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">clear_line</span><span class="p">()</span>
                <span class="n">log_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating plot </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error generating plot for </span><span class="si">{</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;xlabel&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">update_combined_progress</span><span class="p">(</span><span class="n">saving_section_key</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>  <span class="c1"># Pass path for prefix</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Corrected Footer message logic</span>
    <span class="k">if</span> <span class="n">plots_generated</span> <span class="o">==</span> <span class="n">num_plots</span><span class="p">:</span>
        <span class="n">print_footer</span><span class="p">(</span><span class="s2">&quot;1D Variable Comparison Histograms generated successfully.&quot;</span><span class="p">)</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;1D Variable Comparison Histograms generated successfully.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;1D Comparison Histograms partially generated (</span><span class="si">{</span><span class="n">plots_generated</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_plots</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="n">print_status</span><span class="p">(</span><span class="n">final_message</span> <span class="o">+</span> <span class="s2">&quot; Check log for details.&quot;</span><span class="p">)</span>
        <span class="n">log_message</span><span class="p">(</span><span class="n">final_message</span> <span class="o">+</span> <span class="s2">&quot; Some plots failed.&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="generate_all_2d_histograms">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.generate_all_2d_histograms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_all_2d_histograms</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">rank_decimated_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates all 2D histogram plots including particle, nsphere, and rank histograms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : Configuration</span>
<span class="sd">        The configuration object.</span>
<span class="sd">    rank_decimated_data : list or None</span>
<span class="sd">        Pre-processed rank data that can be used as fallback for histogram generation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating 2D Histograms&quot;</span><span class="p">)</span>

    <span class="c1"># Count total histogram plots (4 from particles and nsphere, 1 from rank)</span>
    <span class="n">total_histograms</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;histogram_plots&quot;</span><span class="p">,</span> <span class="n">total_histograms</span><span class="p">)</span>

    <span class="c1"># Process particles histograms with combined progress</span>
    <span class="n">plot_particles_histograms</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">output_file</span><span class="p">:</span> <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;histogram_plots&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">),</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Process nsphere histograms with combined progress</span>
    <span class="n">plot_nsphere_histograms</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">output_file</span><span class="p">:</span> <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;histogram_plots&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">),</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># For rank histogram, only a single file is needed</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating histograms from rank data...&quot;</span><span class="p">)</span>
    <span class="n">single_rank_data</span> <span class="o">=</span> <span class="n">process_single_rank_file_for_histogram</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>

    <span class="c1"># Generate rank histogram if we have data</span>
    <span class="n">rank_output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/part_data_histogram_initial</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
    <span class="k">if</span> <span class="n">single_rank_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">generate_rank_histogram</span><span class="p">(</span><span class="n">single_rank_data</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">rank_output_file</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">update_combined_progress</span><span class="p">(</span><span class="s2">&quot;histogram_plots&quot;</span><span class="p">,</span> <span class="n">rank_output_file</span><span class="p">)</span>
    <span class="c1"># No fallback available for histogram generation</span>

    <span class="n">print_footer</span><span class="p">(</span><span class="s2">&quot;2D histograms generated successfully.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_all_energy_plots">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.generate_all_energy_plots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_all_energy_plots</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">file_paths</span><span class="p">,</span> <span class="n">unsorted_energy_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates all energy-related plots with status display and progress tracking.</span>

<span class="sd">    Displays the initial status, generates plots in parallel (unsorted and sorted </span>
<span class="sd">    energy plots), and updates the console output with completion status.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : Configuration</span>
<span class="sd">        The configuration object containing suffix and other settings.</span>
<span class="sd">    file_paths : dict or None</span>
<span class="sd">        Dictionary of file paths, will be created if None.</span>
<span class="sd">    unsorted_energy_data : list or None</span>
<span class="sd">        Pre-processed unsorted energy data from process_rank_files.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The console output is managed with a series of up/down cursor movements</span>
<span class="sd">    to create a clean, consistently updated display. Initial status appears</span>
<span class="sd">    immediately while plots are being generated, with the final update</span>
<span class="sd">    overwriting the status lines upon completion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Access the global paced_mode variable for the timer function</span>
    <span class="k">global</span> <span class="n">paced_mode</span>

    <span class="c1"># Setup file paths if they weren&#39;t provided</span>
    <span class="k">if</span> <span class="n">file_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_paths</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">setup_file_paths</span><span class="p">()</span>

    <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating Energy Plots&quot;</span><span class="p">,</span> <span class="n">add_newline</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Import threading module</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

    <span class="c1"># Prepare static display lines</span>
    <span class="n">energy_plot_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">unsorted_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Energy_vs_timestep_unsorted</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">sorted_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Energy_vs_timestep_sorted</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Log start of processing</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Energy plots starting&quot;</span><span class="p">)</span>

    <span class="c1"># Set up progress bar appearance</span>
    <span class="n">bar_length</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">half_filled</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bar_length</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">half_bar</span> <span class="o">=</span> <span class="s1">&#39;█&#39;</span> <span class="o">*</span> <span class="n">half_filled</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">bar_length</span> <span class="o">-</span> <span class="n">half_filled</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">get_file_prefix</span><span class="p">(</span><span class="n">unsorted_name</span><span class="p">)</span>

    <span class="c1"># Timer thread will handle displaying the 50% unsorted status</span>
    <span class="c1"># print(f&quot;Save: {half_bar} 50.0% | File: {prefix}&quot;)  # Commented out as timer thread shows this</span>
    <span class="c1"># print(get_separator_line(char=&#39;-&#39;))</span>

    <span class="c1"># Create timer thread</span>
    <span class="n">stop_timer</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">timer_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">update_timer_energy_plots</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">stop_timer</span><span class="p">,</span> <span class="n">energy_plot_start_time</span><span class="p">,</span> <span class="n">paced_mode</span><span class="p">))</span>
    <span class="n">timer_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">timer_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Generate the unsorted energy plot</span>
        <span class="k">if</span> <span class="n">unsorted_energy_data</span><span class="p">:</span>
            <span class="n">unsorted_output</span> <span class="o">=</span> <span class="n">generate_unsorted_energy_plot</span><span class="p">(</span><span class="n">unsorted_energy_data</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unsorted_output</span> <span class="o">=</span> <span class="n">generate_unsorted_energy_plot</span><span class="p">([],</span> <span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>

        <span class="c1"># Stop the timer after first plot completes</span>
        <span class="n">stop_timer</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="n">timer_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="c1"># --- Write separator line and move down ---</span>
        <span class="c1"># Timer status is on line X. Cursor is likely start of X+1.</span>
        <span class="c1"># Write separator on line X+1. Use truncate_and_pad for consistency.</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Write separator + newline</span>
        <span class="c1"># Cursor is now at start of line X+2. Tqdm will start here.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c1"># --- End separator write + move down ---</span>

        <span class="c1"># Generate the sorted energy plot</span>
        <span class="n">sorted_output</span> <span class="o">=</span> <span class="n">generate_sorted_energy_plot</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
        
        <span class="c1"># Generate total energy diagnostics plot if file exists</span>
        <span class="n">total_energy_file</span> <span class="o">=</span> <span class="n">file_paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_energy_vs_time&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">total_energy_file</span><span class="p">):</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results/total_energy_diagnostics</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">total_energy_output</span> <span class="o">=</span> <span class="n">plot_total_energy_diagnostics</span><span class="p">(</span><span class="n">total_energy_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">total_energy_output</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total energy diagnostics plot saved to </span><span class="si">{</span><span class="n">total_energy_output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate final timing statistics</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">energy_plot_start_time</span>
        <span class="n">displayed_elapsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">nominal_elapsed</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">nominal_elapsed</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">)</span>
        <span class="n">time_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; [</span><span class="si">{</span><span class="n">displayed_elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">remaining</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">rate</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">file/s]&quot;</span> <span class="c1"># Final stats</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Stop timer thread on error</span>
        <span class="k">if</span> <span class="n">timer_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">stop_timer</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="n">timer_thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        
        <span class="c1"># Log the error</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during energy plot generation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during energy plot generation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Mark plots as failed</span>
        <span class="n">unsorted_output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sorted_output</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Show completion status</span>
    <span class="n">full_bar</span> <span class="o">=</span> <span class="s1">&#39;█&#39;</span> <span class="o">*</span> <span class="n">bar_length</span> <span class="c1"># Keep this</span>
    <span class="n">final_prefix</span> <span class="o">=</span> <span class="n">get_file_prefix</span><span class="p">(</span><span class="n">sorted_name</span><span class="p">)</span> <span class="c1"># Use SORTED prefix</span>

    <span class="c1"># --- Start Final Update Logic ---</span>
    <span class="c1"># Move up 5 lines (1 init status + 1 init separator + 2 tqdm bars + 1 line below tqdm)</span>
    <span class="n">move_up_final</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[5A&quot;</span>
    <span class="c1"># Downward movement: We write status (line X), then separator (line X+1).</span>
    <span class="c1"># We need to land below where the second tqdm bar was (line X+4).</span>
    <span class="c1"># So, after writing separator on X+1, move down 3 lines.</span>
    <span class="n">move_down_final</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[4B&quot;</span> <span class="c1"># Relative Move</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">move_up_final</span><span class="p">)</span> <span class="c1"># Move up to initial status line (X)</span>
    <span class="c1"># Create the final status string</span>
    <span class="n">content_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Save: </span><span class="si">{</span><span class="n">full_bar</span><span class="si">}</span><span class="s2"> 100.0% | File: </span><span class="si">{</span><span class="n">final_prefix</span><span class="si">}{</span><span class="n">time_info</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># Clear line X and write final status</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[2K</span><span class="si">{</span><span class="n">truncate_and_pad_string</span><span class="p">(</span><span class="n">content_string</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Move to next line (X+1), clear and write separator</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># Move cursor to start of line X+1</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r\033</span><span class="s2">[2K</span><span class="si">{</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Clear/write separator</span>

    <span class="c1"># Move cursor down 4 lines relative to the current line (X+1) to land below tqdm area</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">move_down_final</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="c1"># --- End Final Update Logic ---</span>

    <span class="c1"># Generate additional energy plots</span>
    <span class="n">process_trajectory_energy_plots</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="n">include_angular_momentum</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Display completion message</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Energy data processing complete.&quot;</span><span class="p">)</span>
    <span class="n">print_footer</span><span class="p">(</span><span class="s2">&quot;Energy plots generated successfully.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="display_configuration_summary">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.display_configuration_summary">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_configuration_summary</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints the execution banner and summarizes the configuration parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config : Configuration</span>
<span class="sd">        The configuration object containing parsed arguments and settings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Display banner and parameter information</span>
    <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;NSphere Plot Generation Tool&quot;</span><span class="p">)</span>

    <span class="c1"># Display parameter values in a structured format</span>
    <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parameter values requested:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Number of Particles:          </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">npts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Number of Time Steps:         </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">Ntimes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Number of Dynamical Times:    </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">tfinal_factor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  FPS:                          </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">fps</span><span class="si">}</span><span class="s2"> (frame duration: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">ms)&quot;</span><span class="p">)</span>
    <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Output Directory:             results&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">file_tag</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Filename Tag:                 </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">file_tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Filename Tag:                 [none]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">paced_mode</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Paced Mode:                   Enabled (section delay: 5.0s, progress bar delay: 2.0s)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Paced Mode:                   Disabled (fast mode - no delays)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">enable_logging</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Logging:                      Full (log/nsphere_plot.log)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Logging:                      Errors and warnings only (log/nsphere_plot.log)&quot;</span><span class="p">)</span>
    <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function that orchestrates the visualization process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">start_snap</span><span class="p">,</span> <span class="n">end_snap</span><span class="p">,</span> <span class="n">step_snap</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">args</span>
    <span class="k">global</span> <span class="n">mass_snapshots</span><span class="p">,</span> <span class="n">density_snapshots</span><span class="p">,</span> <span class="n">psi_snapshots</span>
    <span class="k">global</span> <span class="n">showing_help</span>

    <span class="c1"># Create Configuration object (parses arguments and sets up parameters)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">()</span>

    <span class="c1"># If showing help, exit immediately</span>
    <span class="k">if</span> <span class="n">showing_help</span><span class="p">:</span>
        <span class="k">return</span>
        
    <span class="c1"># Display configuration summary</span>
    <span class="n">display_configuration_summary</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1"># Set global variables from configuration</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">suffix</span>
    <span class="n">start_snap</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">start_snap</span>
    <span class="n">end_snap</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">end_snap</span>
    <span class="n">step_snap</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">step_snap</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">duration</span>

    <span class="c1"># Create results directory</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Check if any &quot;only&quot; flags are active</span>
    <span class="n">only_flags_active</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">only_specific_visualizations</span><span class="p">()</span>


    <span class="n">file_paths</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rank_decimated_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Only process phase space plots if specified or in normal mode</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">phase_space</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">only_flags_active</span><span class="p">:</span>
        <span class="c1"># Skip if explicitly told not to generate phase space plots</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_phase_space</span><span class="p">:</span>
            <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating Phase Space Initial Histogram&quot;</span><span class="p">)</span>
            <span class="n">generate_initial_phase_histogram</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="n">print_footer</span><span class="p">(</span><span class="s2">&quot;Initial phase space histogram created successfully.&quot;</span><span class="p">)</span>

            <span class="c1"># If phase_space_only is true, also generate the animation right away</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">phase_space</span><span class="p">:</span>
                <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating Phase Space Animation&quot;</span><span class="p">)</span>
                <span class="n">generate_phase_space_animation</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">fps</span><span class="p">)</span>
                <span class="c1"># Add separator and completion message for phase space animation</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_separator_line</span><span class="p">(</span><span class="n">char</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Phase space animation generated successfully.&quot;</span><span class="p">)</span>
                <span class="c1"># Log this message to file only, not to console</span>
                <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Phase space animation created successfully.&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>

    <span class="c1"># Only process phase comparison if specified or in normal mode</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">phase_comparison</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">only_flags_active</span><span class="p">:</span>
        <span class="c1"># Skip if explicitly told not to generate phase comparison</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_phase_comparison</span><span class="p">:</span>
            <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating Phase Space Comparison&quot;</span><span class="p">)</span>
            <span class="n">generate_comparison_plot</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="n">print_footer</span><span class="p">(</span><span class="s2">&quot;Phase space comparison created successfully.&quot;</span><span class="p">)</span>
            
    <span class="c1"># --- Generate 1D Variable Distributions ---</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">distributions</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">only_flags_active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_distributions</span><span class="p">):</span>
        <span class="c1"># This function handles its own header, data loading, processing, and plotting.</span>
        <span class="n">process_variable_histograms</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="c1"># Footer is printed by the function or progress bar completion</span>

    <span class="c1"># Process profile plots if requested or in normal mode</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">profile_plots</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">only_flags_active</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_profile_plots</span><span class="p">:</span>
            <span class="c1"># Setup file paths</span>
            <span class="n">file_paths</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">setup_file_paths</span><span class="p">()</span>
            <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating Profile Plots&quot;</span><span class="p">)</span>
            <span class="n">process_profile_plots</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
            <span class="n">print_footer</span><span class="p">(</span><span class="s2">&quot;Profile plots generated successfully.&quot;</span><span class="p">)</span>

    <span class="c1"># Process trajectory plots if requested or in normal mode</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">trajectory_plots</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">only_flags_active</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_trajectory_plots</span><span class="p">:</span>
            <span class="c1"># Setup file paths if not already set</span>
            <span class="k">if</span> <span class="n">file_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">file_paths</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">setup_file_paths</span><span class="p">()</span>
            <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating Trajectory and Diagnostic Plots&quot;</span><span class="p">)</span>

            <span class="c1"># Count the total plots to be generated from both functions</span>
            <span class="n">trajectory_count</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># trajectories, single_trajectory, lowest_l_3panel</span>
            <span class="n">energy_count</span> <span class="o">=</span> <span class="mi">3</span>      <span class="c1"># energy_vs_time, angular_momentum_vs_time, energy_compare</span>

            <span class="c1"># Initialize combined progress tracking for all trajectory-related plots</span>
            <span class="n">total_plots</span> <span class="o">=</span> <span class="n">trajectory_count</span> <span class="o">+</span> <span class="n">energy_count</span>
            <span class="n">start_combined_progress</span><span class="p">(</span><span class="s2">&quot;trajectory_plots&quot;</span><span class="p">,</span> <span class="n">total_plots</span><span class="p">)</span>

            <span class="c1"># Use a modified process_trajectory_plots function that updates the combined tracker</span>
            <span class="n">process_trajectory_plots</span><span class="p">(</span><span class="n">file_paths</span><span class="p">)</span>

            <span class="n">print_footer</span><span class="p">(</span><span class="s2">&quot;Trajectory and diagnostic plots generated successfully.&quot;</span><span class="p">)</span>

    <span class="c1"># Generate 2D histograms if requested or in normal mode</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;2d_histograms&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">only_flags_active</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_histograms</span><span class="p">:</span>
            <span class="n">generate_all_2d_histograms</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">rank_decimated_data</span><span class="p">)</span>

    <span class="c1"># Generate convergence test plots if requested or in normal mode</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">convergence_tests</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">only_flags_active</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_convergence_tests</span><span class="p">:</span>
            <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating Convergence Test Plots&quot;</span><span class="p">)</span>
            <span class="c1"># The generate_convergence_test_plots function uses combined progress tracking</span>
            <span class="n">generate_convergence_test_plots</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
            <span class="n">print_footer</span><span class="p">(</span><span class="s2">&quot;Convergence test plots generated successfully.&quot;</span><span class="p">)</span>

    <span class="c1"># Exit early if only specific, already-handled visualizations were requested</span>
    <span class="c1"># to avoid unnecessary rank file processing</span>
    <span class="n">need_to_process_rank_files</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">need_to_process_rank_files</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">only_flags_active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">need_to_process_rank_files</span><span class="p">:</span>
        <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Visualization Complete&quot;</span><span class="p">)</span>
        <span class="n">print_footer</span><span class="p">(</span><span class="s2">&quot;All requested visualizations completed successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

     <span class="c1"># Process rank files first if they&#39;ll be needed for animations or energy plots</span>
    <span class="n">rank_decimated_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">unsorted_energy_data</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize to ensure it&#39;s defined</span>
    <span class="k">if</span> <span class="n">need_to_process_rank_files</span><span class="p">:</span>
        <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Processing Particle Snapshot Data&quot;</span><span class="p">)</span>

        <span class="c1"># Setup file paths if not already set</span>
        <span class="k">if</span> <span class="n">file_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_paths</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">setup_file_paths</span><span class="p">()</span>

        <span class="c1"># Process rank files and prepare data for animations and energy plots</span>
        <span class="c1"># The function will print its own completion message</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">unsorted_energy_data</span> <span class="o">=</span> <span class="n">process_rank_files</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">start_snap</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">end_snap</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">step_snap</span><span class="p">)</span>
        <span class="n">rank_decimated_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Process energy plots if requested or in normal mode</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">energy_plots</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">only_flags_active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_energy_plots</span><span class="p">):</span>
        <span class="n">generate_all_energy_plots</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">file_paths</span><span class="p">,</span> <span class="n">unsorted_energy_data</span><span class="p">)</span>
       
    <span class="c1"># Process animations if requested or in normal mode</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">animations</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">only_flags_active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_animations</span><span class="p">):</span>
        <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating Animations&quot;</span><span class="p">)</span>

        <span class="c1"># Use parallel processing internally for animations; manage progress sequentially here</span>
        <span class="c1"># This provides parallel processing with clean progress output</span>
        <span class="n">generate_all_1D_animations</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="c1"># Add completion message for profile animations (no separator needed here)</span>
        <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Mass, density, and psi animations generated successfully.&quot;</span><span class="p">)</span>

        <span class="c1"># Generate phase space animation if not explicitly disabled and not already generated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">no_phase_space</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">phase_space</span><span class="p">:</span>  <span class="c1"># Skip if already generated in phase-space-only mode</span>
            <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Generating Phase Space Animation&quot;</span><span class="p">)</span>
            <span class="n">generate_phase_space_animation</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">fps</span><span class="p">)</span> <span class="c1"># Pass full config</span>
            <span class="c1"># Add completion message for phase space animation (separator is already added in the function)</span>
            <span class="n">print_status</span><span class="p">(</span><span class="s2">&quot;Phase space animation generated successfully.&quot;</span><span class="p">)</span>
            <span class="c1"># Log this message to file only, not to console</span>
            <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;Phase space animation created successfully.&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>

        <span class="c1"># Log this message to file only, not to console</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;All animations generated successfully.&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>


    <span class="c1"># If doing only specific visualizations, exit now</span>
    <span class="k">if</span> <span class="n">only_flags_active</span><span class="p">:</span>
        <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;Visualization Complete&quot;</span><span class="p">)</span>
        <span class="c1"># Log completion message to file only, not to console</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;All Visualizations Complete&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">print_header</span><span class="p">(</span><span class="s2">&quot;All Visualizations Complete&quot;</span><span class="p">)</span>
        <span class="c1"># Log completion message to file only, not to console</span>
        <span class="n">log_message</span><span class="p">(</span><span class="s2">&quot;All visualizations generated successfully. Results saved to &#39;results&#39; directory.&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_main">
<a class="viewcode-back" href="../python_api/index.html#nsphere_plot.run_main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run_main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point that runs the application with the cursor hidden.</span>
<span class="sd">    Ensures cursor is always restored when the program exits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Hide cursor at program start</span>
        <span class="n">hide_cursor</span><span class="p">()</span>
        <span class="n">main</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Process interrupted by user&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Re-raise any exceptions after showing cursor</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span> <span class="c1"># Log full traceback</span>
        <span class="c1"># Print error to console as well for visibility</span>
        <span class="n">print_status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">An error occurred: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Always ensure cursor is visible before exiting</span>
        <span class="n">show_cursor</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">run_main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Kris Sigurdson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>